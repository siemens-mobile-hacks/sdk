diff -Naur ../../../dietlibc-0.34/lib/abort.c lib/abort.c
--- ../../../dietlibc-0.34/lib/abort.c	2003-08-23 19:12:47.000000000 +0300
+++ lib/abort.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <sys/types.h>
-#include <signal.h>
-#include <stdlib.h>
-#include <stdio.h>
-
-#ifndef __PIC__
-void __stdio_flushall(void) __attribute__((weak));
-void __stdio_flushall(void) { }
-#else
-#include "dietstdio.h"
-#endif
-
-void abort() {
-  sigset_t t;
-  __stdio_flushall();
-  if (!sigemptyset(&t) && !sigaddset(&t, SIGABRT))
-    sigprocmask(SIG_UNBLOCK, &t, 0);
-  while (1)
-    if (raise(SIGABRT))
-      exit(127);
-}
diff -Naur ../../../dietlibc-0.34/lib/accept.c lib/accept.c
--- ../../../dietlibc-0.34/lib/accept.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/accept.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_accept(int a, void * addr, void * addr2);
-
-int __libc_accept(int a, void * addr, void * addr2) {
-  long args[] = { a, (long) addr, (long) addr2 };
-  return socketcall(SYS_ACCEPT, args);
-}
-
-int accept(int a, void * addr, void * addr2) __attribute__((weak,alias("__libc_accept")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/adjtime.c lib/adjtime.c
--- ../../../dietlibc-0.34/lib/adjtime.c	2001-11-04 21:03:31.000000000 +0200
+++ lib/adjtime.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include <time.h>
-#include <sys/timex.h>
-
-int adjtime (const struct timeval *itv, struct timeval *otv) {
-  struct timex tmp;
-  if (itv) {
-    tmp.offset = (itv->tv_usec % 1000000L) + (itv->tv_sec + itv->tv_usec / 1000000L) * 1000000L;
-    tmp.modes = ADJ_OFFSET_SINGLESHOT;
-  } else
-    tmp.modes = 0;
-  if (adjtimex(&tmp)==-1)
-    return -1;
-  if (otv) {
-    otv->tv_usec = tmp.offset % 1000000;
-    otv->tv_sec  = tmp.offset / 1000000;
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/__alarm.c lib/__alarm.c
--- ../../../dietlibc-0.34/lib/__alarm.c	2011-03-03 20:54:54.000000000 +0200
+++ lib/__alarm.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include <unistd.h>
-#include <sys/time.h>
-#include "syscalls.h"
-
-#ifndef __NR_alarm
-unsigned int alarm(unsigned int seconds) {
-  struct itimerval old, new;
-  unsigned int ret;
-  new.it_interval.tv_usec=0;
-  new.it_interval.tv_sec=0;
-  new.it_value.tv_usec	=0;
-  new.it_value.tv_sec	=(long)seconds;
-  if (setitimer(ITIMER_REAL,&new,&old)==-1) return 0;
-  return old.it_value.tv_sec+(old.it_value.tv_usec?1:0);
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/alloc.c lib/alloc.c
--- ../../../dietlibc-0.34/lib/alloc.c	2016-02-05 22:17:39.000000000 +0200
+++ lib/alloc.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,255 +0,0 @@
-/*
- * malloc/free by O.Dreesen
- *
- * first TRY:
- *   lists w/magics
- * and now the second TRY
- *   let the kernel map all the stuff (if there is something to do)
- */
-
-#include <unistd.h>
-#include <sys/mman.h>
-#include <errno.h>
-#include "dietfeatures.h"
-
-#include <sys/cdefs.h>
-#include <sys/types.h>
-#include <stddef.h>
-#include <stdlib.h>
-#include <string.h>
-
-#include <sys/shm.h>	/* for PAGE_SIZE */
-
-
-/* -- HELPER CODE --------------------------------------------------------- */
-
-#ifndef MAP_FAILED
-#define MAP_FAILED ((void*)-1)
-#endif
-
-#ifndef NULL
-#define NULL ((void*)0)
-#endif
-
-typedef struct {
-  void*  next;
-  size_t size;
-} __alloc_t;
-
-#define BLOCK_START(b)	(((void*)(b))-sizeof(__alloc_t))
-#define BLOCK_RET(b)	(((void*)(b))+sizeof(__alloc_t))
-
-#define MEM_BLOCK_SIZE	PAGE_SIZE
-#define PAGE_ALIGN(s)	(((s)+MEM_BLOCK_SIZE-1)&(unsigned long)(~(MEM_BLOCK_SIZE-1)))
-
-/* a simple mmap :) */
-#if defined(__i386__)
-#define REGPARM(x) __attribute__((regparm(x)))
-#else
-#define REGPARM(x)
-#endif
-
-static void REGPARM(1) *do_mmap(size_t size) {
-  return mmap(0, size, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE, -1, (size_t)0);
-}
-
-/* -- SMALL MEM ----------------------------------------------------------- */
-
-static __alloc_t* __small_mem[8];
-
-#define __SMALL_NR(i)		(MEM_BLOCK_SIZE/(i))
-
-#define __MIN_SMALL_SIZE	__SMALL_NR(256)		/*   16 /   32 */
-#define __MAX_SMALL_SIZE	__SMALL_NR(2)		/* 2048 / 4096 */
-
-#define GET_SIZE(s)		(__MIN_SMALL_SIZE<<get_index((s)))
-
-#define FIRST_SMALL(p)		(((unsigned long)(p))&(~(MEM_BLOCK_SIZE-1)))
-
-static inline int __ind_shift() { return (MEM_BLOCK_SIZE==4096)?4:5; }
-
-static size_t REGPARM(1) get_index(size_t _size) {
-  register size_t idx=0;
-//  if (_size) {	/* we already check this in the callers */
-    register size_t size=((_size-1)&(MEM_BLOCK_SIZE-1))>>__ind_shift();
-    while(size) { size>>=1; ++idx; }
-//  }
-  return idx;
-}
-
-/* small mem */
-static void __small_free(void*_ptr,size_t _size) REGPARM(2);
-
-static void REGPARM(2) __small_free(void*_ptr,size_t _size) {
-  __alloc_t* ptr=BLOCK_START(_ptr);
-  size_t size=_size;
-  size_t idx=get_index(size);
-
-#ifdef WANT_FREE_OVERWRITE
-  memset(ptr,0x55,size);	/* allways zero out small mem */
-#else
-  memset(ptr,0,size);	/* allways zero out small mem */
-#endif
-
-  ptr->next=__small_mem[idx];
-  __small_mem[idx]=ptr;
-}
-
-static void* REGPARM(1) __small_malloc(size_t _size) {
-  __alloc_t *ptr;
-  size_t size=_size;
-  size_t idx;
-
-  idx=get_index(size);
-  ptr=__small_mem[idx];
-
-  if (ptr==0)  {	/* no free blocks ? */
-    register int i,nr;
-    ptr=do_mmap(MEM_BLOCK_SIZE);
-    if (ptr==MAP_FAILED) return MAP_FAILED;
-
-    __small_mem[idx]=ptr;
-
-    nr=__SMALL_NR(size)-1;
-    for (i=0;i<nr;i++) {
-      ptr->next=(((void*)ptr)+size);
-      ptr=ptr->next;
-    }
-    ptr->next=0;
-
-    ptr=__small_mem[idx];
-  }
-
-  /* get a free block */
-  __small_mem[idx]=ptr->next;
-  ptr->next=0;
-
-  return ptr;
-}
-
-/* -- PUBLIC FUNCTIONS ---------------------------------------------------- */
-
-static void _alloc_libc_free(void *ptr) {
-  register size_t size;
-  if (ptr) {
-    size=((__alloc_t*)BLOCK_START(ptr))->size;
-    if (size) {
-      if (size<=__MAX_SMALL_SIZE)
-	__small_free(ptr,size);
-      else
-	munmap(BLOCK_START(ptr),size);
-    }
-  }
-}
-void __libc_free(void *ptr) __attribute__((alias("_alloc_libc_free")));
-void free(void *ptr) __attribute__((weak,alias("_alloc_libc_free")));
-
-#ifdef WANT_MALLOC_ZERO
-static __alloc_t zeromem[2];
-#endif
-
-static void* _alloc_libc_malloc(size_t size) {
-  __alloc_t* ptr;
-  size_t need;
-#ifdef WANT_MALLOC_ZERO
-  if (!size) return BLOCK_RET(zeromem);
-#else
-  if (!size) goto err_out;
-#endif
-  size+=sizeof(__alloc_t);
-  if (size<sizeof(__alloc_t)) goto err_out;
-  if (size<=__MAX_SMALL_SIZE) {
-    need=GET_SIZE(size);
-    ptr=__small_malloc(need);
-  }
-  else {
-    need=PAGE_ALIGN(size);
-    if (!need) ptr=MAP_FAILED; else ptr=do_mmap(need);
-  }
-  if (ptr==MAP_FAILED) goto err_out;
-  ptr->size=need;
-  return BLOCK_RET(ptr);
-err_out:
-  (*__errno_location())=ENOMEM;
-  return 0;
-}
-void* __libc_malloc(size_t size) __attribute__((alias("_alloc_libc_malloc")));
-void* malloc(size_t size) __attribute__((weak,alias("_alloc_libc_malloc")));
-
-void* __libc_calloc(size_t nmemb, size_t _size);
-void* __libc_calloc(size_t nmemb, size_t _size) {
-  size_t size;
-#if __GNUC__>=5
-  if (__builtin_mul_overflow(_size,nmemb,&size)) {
-    (*__errno_location())=ENOMEM;
-    return 0;
-  }
-#else
-  size=_size*nmemb;
-  if (nmemb && size/nmemb!=_size) {
-    (*__errno_location())=ENOMEM;
-    return 0;
-  }
-#endif
-#ifdef WANT_FREE_OVERWRITE
-  if (size<__MAX_SMALL_SIZE) {
-    void* x=malloc(size);
-    memset(x,0,size);
-    return x;
-  } else
-#endif
-  return malloc(size);
-}
-void* calloc(size_t nmemb, size_t _size) __attribute__((weak,alias("__libc_calloc")));
-
-void* __libc_realloc(void* ptr, size_t _size);
-void* __libc_realloc(void* ptr, size_t _size) {
-  register size_t size=_size;
-  if (ptr) {
-    if (size) {
-      __alloc_t* tmp=BLOCK_START(ptr);
-      size+=sizeof(__alloc_t);
-      if (size<sizeof(__alloc_t)) goto retzero;
-      size=(size<=__MAX_SMALL_SIZE)?GET_SIZE(size):PAGE_ALIGN(size);
-      if (tmp->size!=size) {
-	if ((tmp->size<=__MAX_SMALL_SIZE)) {
-	  void *new=_alloc_libc_malloc(_size);
-	  if (new) {
-	    register __alloc_t* foo=BLOCK_START(new);
-	    size=foo->size;
-	    if (size>tmp->size) size=tmp->size;
-	    if (size) memcpy(new,ptr,size-sizeof(__alloc_t));
-	    _alloc_libc_free(ptr);
-	  }
-	  ptr=new;
-	}
-	else {
-	  register __alloc_t* foo;
-	  size=PAGE_ALIGN(size);
-	  foo=mremap(tmp,tmp->size,size,MREMAP_MAYMOVE);
-	  if (foo==MAP_FAILED) {
-retzero:
-	    (*__errno_location())=ENOMEM;
-	    ptr=0;
-	  }
-	  else {
-	    foo->size=size;
-	    ptr=BLOCK_RET(foo);
-	  }
-	}
-      }
-    }
-    else { /* size==0 */
-      _alloc_libc_free(ptr);
-      ptr = NULL;
-    }
-  }
-  else { /* ptr==0 */
-    if (size) {
-      ptr=_alloc_libc_malloc(size);
-    }
-  }
-  return ptr;
-}
-void* realloc(void* ptr, size_t size) __attribute__((weak,alias("__libc_realloc")));
-
diff -Naur ../../../dietlibc-0.34/lib/arc4random.c lib/arc4random.c
--- ../../../dietlibc-0.34/lib/arc4random.c	2017-02-23 18:54:14.000000000 +0200
+++ lib/arc4random.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,64 +0,0 @@
-#define _LINUX_SOURCE
-#include <unistd.h>
-#include <sys/random.h>
-#include <stdlib.h>
-#include <fcntl.h>
-#include <errno.h>
-
-static uint32_t buf[256];
-static unsigned int n;
-
-/* These come from OpenBSD: */
-uint32_t arc4random(void) {
-  if (n==0) arc4random_stir();
-  uint32_t r=buf[n];
-  if (++n > sizeof(buf)/sizeof(buf[0])) n=0;
-  return r;
-}
-
-void arc4random_buf(void* Buf, size_t N) {
-  int r;
-  if ((size_t)(r=getrandom(Buf,N,GRND_NONBLOCK)) != N) {
-    if (r==-1 && errno==ENOSYS) {
-      int fd=open("/dev/urandom",O_RDONLY);
-      if (fd==-1) abort();
-      r=read(fd,Buf,N);
-      close(fd);
-    }
-    if ((size_t)r != N)
-      abort();
-  }
-}
-
-uint32_t arc4random_uniform(uint32_t upper_bound) {
-  uint32_t r, min;
-
-  if (upper_bound < 2)
-    return 0;
-
-  /* 2**32 % x == (2**32 - x) % x */
-  min = -upper_bound % upper_bound;
-
-  /*
-    * This could theoretically loop forever but each retry has
-    * p > 0.5 (worst case, usually far better) of selecting a
-    * number inside the range we need, so it should rarely need
-    * to re-roll.
-    */
-  for (;;) {
-    r = arc4random();
-    if (r >= min)
-      break;
-  }
-
-  return r % upper_bound;
-}
-
-void arc4random_stir(void) {
-  n=0;
-  arc4random_buf(buf,sizeof(buf));
-}
-
-void arc4random_addrandom(unsigned char* dat,size_t datlen) {
-}
-
diff -Naur ../../../dietlibc-0.34/lib/assert_fail.c lib/assert_fail.c
--- ../../../dietlibc-0.34/lib/assert_fail.c	2002-10-17 22:51:17.000000000 +0300
+++ lib/assert_fail.c	2023-10-14 22:05:22.499036337 +0300
@@ -2,16 +2,15 @@
 #include <string.h>
 #include <unistd.h>
 #include "dietwarning.h"
-#include <write12.h>
-
-void __assert_fail (const char *assertion, const char *file, unsigned int line, const char *function);
+#include <write12.h>
+#include <stdio.h>
 
 void __assert_fail (const char *assertion, const char *file, unsigned int line, const char *function)
 {
-  unsigned int alen=strlen(assertion);
-  unsigned int flen=strlen(file);
-  unsigned int fulen=function?strlen(function):0;
-  char *buf=(char*)alloca(alen+flen+fulen+50);
+  unsigned int alen = strlen(assertion);
+  unsigned int flen = strlen(file);
+  unsigned int fulen = function ? strlen(function) : 0;
+  char *buf = (char*)malloc(alen+flen+fulen+50);
   if (buf) {
     char *tmp;
     *buf=0;
@@ -23,9 +22,14 @@
     strcat(buf,"Assertion `");
     strcat(buf,assertion);
     strcat(buf,"' failed.\n");
-    __write2(buf);
+    //__write2(buf);
+    fprintf(stderr, buf);
+    free(buf);
   }
-  abort();
+  //abort();
 }
-
+
+
+#ifdef __NEED_WARNING
 link_warning("__assert_fail","warning: your code still has assertions enabled!")
+#endif
diff -Naur ../../../dietlibc-0.34/lib/atexit.c lib/atexit.c
--- ../../../dietlibc-0.34/lib/atexit.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/atexit.c	2023-10-15 17:05:34.780183822 +0300
@@ -1,5 +1,7 @@
 #include <stdlib.h>
 #include <unistd.h>
+#include <stdio.h>
+
 
 typedef void (*function)(void);
 
@@ -22,10 +24,16 @@
 void __libc_exit(int code);
 void __libc_exit(int code) {
   register int i=atexit_counter;
-  __thread_doexit(code);
+  //__thread_doexit(code);
   while(i) {
     __atexitlist[--i]();
-  }
-  _exit(code);
-}
+  }
+
+  //setvbuf(stdout, 0, _IONBF, 0);
+  //setvbuf(stderr, 0, _IONBF, 0);
+  fclose(stdout);
+  fclose(stderr);
+  //_exit(code);
+}
+
 void exit(int code) __attribute__((alias("__libc_exit")));
diff -Naur ../../../dietlibc-0.34/lib/atoi.c lib/atoi.c
--- ../../../dietlibc-0.34/lib/atoi.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/atoi.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,19 +0,0 @@
-#include <endian.h>
-#include <ctype.h>
-#include <stdlib.h>
-
-#if __WORDSIZE == 64
-int atoi(const char* s) {
-  long int v=0;
-  int sign=1;
-  while ( *s == ' '  ||  (unsigned int)(*s - 9) < 5u) s++;
-  switch (*s) {
-  case '-': sign=-1; /* fall through */
-  case '+': ++s;
-  }
-  while ((unsigned int) (*s - '0') < 10u) {
-    v=v*10+*s-'0'; ++s;
-  }
-  return sign==-1?-v:v;
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/atol.c lib/atol.c
--- ../../../dietlibc-0.34/lib/atol.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/atol.c	2023-10-14 22:05:22.491036121 +0300
@@ -7,7 +7,7 @@
   int sign=0;
   while ( *s == ' '  ||  (unsigned int)(*s - 9) < 5u) ++s;
   switch (*s) {
-  case '-': sign=-1;	/* fall through */
+  case '-': sign=-1;
   case '+': ++s;
   }
   while ((unsigned int) (*s - '0') < 10u) {
diff -Naur ../../../dietlibc-0.34/lib/atoll.c lib/atoll.c
--- ../../../dietlibc-0.34/lib/atoll.c	2002-02-24 00:18:42.000000000 +0200
+++ lib/atoll.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,19 +0,0 @@
-#include <endian.h>
-#include <ctype.h>
-#include <stdlib.h>
-
-#if __WORDSIZE != 64
-long long int atoll(const char* s) {
-  long long int v=0;
-  int sign=1;
-  while ( *s == ' '  ||  (unsigned int)(*s - 9) < 5u) ++s;
-  switch (*s) {
-  case '-': sign=-1;
-  case '+': ++s;
-  }
-  while ((unsigned int) (*s - '0') < 10u) {
-    v=v*10+*s-'0'; ++s;
-  }
-  return sign==-1?-v:v;
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/bind.c lib/bind.c
--- ../../../dietlibc-0.34/lib/bind.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/bind.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_bind(int a, void * b, int c);
-int __libc_bind(int a, void * b, int c) {
-  long args[] = { a, (long) b, c };
-  return socketcall(SYS_BIND, args);
-}
-
-int bind(int a, void * b, int c) __attribute__((weak,alias("__libc_bind")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/binshstr.c lib/binshstr.c
--- ../../../dietlibc-0.34/lib/binshstr.c	2001-09-10 16:17:48.000000000 +0300
+++ lib/binshstr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,5 +0,0 @@
-#include "binshstr.h"
-
-const char __binsh [] = "/bin/sh";
-
-/* end of binshstr.c */
diff -Naur ../../../dietlibc-0.34/lib/_brk.c lib/_brk.c
--- ../../../dietlibc-0.34/lib/_brk.c	2002-02-23 23:08:27.000000000 +0200
+++ lib/_brk.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#include <unistd.h>
-
-extern void* __diet_brk(void *end_data_segment);
-
-void* __curbrk=0;
-
-int __libc_brk(void *end_data_segment);
-
-int __libc_brk(void *end_data_segment) {
-  return ((__curbrk=__diet_brk(end_data_segment))==(void*)-1?-1:0);
-}
-
-int brk(void *end_data_segment) __attribute__((weak,alias("__libc_brk")));
diff -Naur ../../../dietlibc-0.34/lib/bsearch.c lib/bsearch.c
--- ../../../dietlibc-0.34/lib/bsearch.c	2003-08-19 20:29:38.000000000 +0300
+++ lib/bsearch.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include <assert.h>
-#include <stdlib.h>
-
-void *bsearch(const void *key, const void *base, size_t nmemb, size_t size, int (*compar)(const void* , const void* )) {
-  size_t m;
-  while (__likely(nmemb)) {
-    int tmp;
-    void *p;
-    m=nmemb/2;
-    p=(void *) (((const char *) base) + (m * size));
-    if ((tmp=(*compar)(key,p))<0) {
-      nmemb=m;
-    } else if (tmp>0) {
-      base=p+size;
-      nmemb-=m+1;
-    } else
-      return p;
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/btowc.c lib/btowc.c
--- ../../../dietlibc-0.34/lib/btowc.c	2010-09-23 05:11:00.000000000 +0300
+++ lib/btowc.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#include <wchar.h>
-#include "dietlocale.h"
-
-wint_t btowc(int c) {
-  if (c==0) return 0;
-  if (c==EOF) return WEOF;
-  switch (lc_ctype) {
-  case CT_8BIT:
-    return c>0xff?WEOF:1;
-  case CT_UTF8:
-    return c>0x7f?WEOF:1;
-  }
-  return WEOF;
-}
diff -Naur ../../../dietlibc-0.34/lib/call_once.c lib/call_once.c
--- ../../../dietlibc-0.34/lib/call_once.c	2014-03-19 11:00:12.000000000 +0200
+++ lib/call_once.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <threads.h>
-
-void call_once(once_flag* flag, void (*func)(void)) {
-  if (__sync_bool_compare_and_swap(flag,0,1))
-    func();
-}
diff -Naur ../../../dietlibc-0.34/lib/cfgetospeed.c lib/cfgetospeed.c
--- ../../../dietlibc-0.34/lib/cfgetospeed.c	2006-12-18 23:28:47.000000000 +0200
+++ lib/cfgetospeed.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <termios.h>
-#include <sys/types.h>
-
-speed_t cfgetospeed(const struct termios *termios_p) {
-  return ((termios_p->c_cflag & (CBAUD|CBAUDEX)));
-}
-
-speed_t cfgetispeed(const struct termios *termios_p)	__attribute__((weak,alias("cfgetospeed")));
diff -Naur ../../../dietlibc-0.34/lib/cfmakeraw.c lib/cfmakeraw.c
--- ../../../dietlibc-0.34/lib/cfmakeraw.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/cfmakeraw.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#include <termios.h>
-#include <sys/ioctl.h>
-
-void cfmakeraw(struct termios *t) {
-     t->c_iflag &= ~(IGNBRK|BRKINT|PARMRK|ISTRIP|INLCR|IGNCR|ICRNL|IXON);
-     t->c_oflag &= ~OPOST;
-     t->c_lflag &= ~(ECHO|ECHONL|ICANON|ISIG|IEXTEN);
-     t->c_cflag &= ~(CSIZE|PARENB);
-     t->c_cflag |= CS8;
-     t->c_cc[VMIN] = 1;
-     t->c_cc[VTIME] = 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/cfsetispeed.c lib/cfsetispeed.c
--- ../../../dietlibc-0.34/lib/cfsetispeed.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/cfsetispeed.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,22 +0,0 @@
-#include <termios.h>
-#include <errno.h>
-#include "dietfeatures.h"
-
-#define IBAUD0  020000000000
-
-int cfsetispeed(struct termios *termios_p, speed_t speed)
-{
-  if ((speed & (speed_t)~CBAUD) != 0 && (speed < B57600 || speed > B460800)) {
-    errno=EINVAL;
-    return -1;
-  }
-  if (speed == 0)
-    termios_p->c_iflag |= IBAUD0;
-  else {
-    termios_p->c_iflag &= ~IBAUD0;
-    termios_p->c_cflag &= ~(CBAUD | CBAUDEX);
-    termios_p->c_cflag |= speed;
-  }
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/cfsetospeed.c lib/cfsetospeed.c
--- ../../../dietlibc-0.34/lib/cfsetospeed.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/cfsetospeed.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#include <termios.h>
-#include <errno.h>
-#include "dietfeatures.h"
-
-int cfsetospeed(struct termios *termios_p, speed_t speed) {
-  if ((speed & (speed_t)~CBAUD) != 0 && (speed < B57600 || speed > B460800)) {
-    errno=EINVAL;
-    return -1;
-  }
-  termios_p->c_cflag &= ~(CBAUD | CBAUDEX);
-  termios_p->c_cflag |= speed;
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/closedir.c lib/closedir.c
--- ../../../dietlibc-0.34/lib/closedir.c	2002-07-03 23:33:37.000000000 +0300
+++ lib/closedir.c	2023-10-14 22:05:22.495036228 +0300
@@ -3,9 +3,11 @@
 #include <unistd.h>
 #include <dirent.h>
 #include <stdlib.h>
+
 
-int closedir (DIR* d) {
-  int res=close(d->fd);
-  munmap (d, PAGE_SIZE);
-  return res;
+int closedir (DIR* d)
+{
+    int res = FindClose(&d->dir, 0);
+    free(d);
+    return res;
 }
diff -Naur ../../../dietlibc-0.34/lib/cnd_broadcast.c lib/cnd_broadcast.c
--- ../../../dietlibc-0.34/lib/cnd_broadcast.c	2014-03-19 11:00:12.000000000 +0200
+++ lib/cnd_broadcast.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <threads.h>
-#include <sys/futex.h>
-
-int cnd_broadcast(cnd_t* cond) {
-  cond->sem=1;
-  futex(&cond->sem,FUTEX_WAKE,0x7fffffff,0,0,0);
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/cnd_destroy.c lib/cnd_destroy.c
--- ../../../dietlibc-0.34/lib/cnd_destroy.c	2014-03-24 10:22:54.000000000 +0200
+++ lib/cnd_destroy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <threads.h>
-
-void cnd_destroy(cnd_t* cond) {
-  // no need to do anything
-  (void)cond;
-}
diff -Naur ../../../dietlibc-0.34/lib/cnd_init.c lib/cnd_init.c
--- ../../../dietlibc-0.34/lib/cnd_init.c	2014-03-19 11:00:12.000000000 +0200
+++ lib/cnd_init.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <threads.h>
-
-int cnd_init(cnd_t* cond) {
-  cond->sem=0;
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/cnd_signal.c lib/cnd_signal.c
--- ../../../dietlibc-0.34/lib/cnd_signal.c	2014-03-19 11:00:12.000000000 +0200
+++ lib/cnd_signal.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <threads.h>
-#include <sys/futex.h>
-
-int cnd_signal(cnd_t* cond) {
-  cond->sem=1;
-  futex(&cond->sem,FUTEX_WAKE,1,0,0,0);
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/cnd_timedwait.c lib/cnd_timedwait.c
--- ../../../dietlibc-0.34/lib/cnd_timedwait.c	2015-04-11 07:25:42.000000000 +0300
+++ lib/cnd_timedwait.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <threads.h>
-#include <sys/futex.h>
-#include <errno.h>
-
-int cnd_timedwait(cnd_t* cond, mtx_t* mutex, const struct timespec* time_point) {
-  int r;
-  do {
-    r=futex(&cond->sem,FUTEX_WAIT,0,time_point,0,0);
-    if (r==-1) {
-      if (errno==EWOULDBLOCK) break;
-      else if (errno==EINTR) continue;
-    } else
-      break;
-  } while (r==0);
-  cond->sem=0;
-  return mtx_timedlock(mutex,time_point);
-}
diff -Naur ../../../dietlibc-0.34/lib/cnd_wait.c lib/cnd_wait.c
--- ../../../dietlibc-0.34/lib/cnd_wait.c	2014-03-19 11:00:12.000000000 +0200
+++ lib/cnd_wait.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <threads.h>
-#include <sys/futex.h>
-#include <errno.h>
-
-int cnd_wait(cnd_t* cond, mtx_t* mutex) {
-  return cnd_timedwait(cond,mutex,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/connect.c lib/connect.c
--- ../../../dietlibc-0.34/lib/connect.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/connect.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_connect(int a, void * b, int c);
-int __libc_connect(int a, void * b, int c) {
-  long args[] = { a, (long) b, c };
-  return socketcall(SYS_CONNECT, args);
-}
-
-int connect(int a, void * b, int c) __attribute__((weak,alias("__libc_connect")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/creat64.c lib/creat64.c
--- ../../../dietlibc-0.34/lib/creat64.c	2001-02-02 23:42:24.000000000 +0200
+++ lib/creat64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <fcntl.h>
-
-#ifndef O_LARGEFILE
-#define O_LARGEFILE 0
-#endif
-
-int creat64(const char *file,mode_t mode) {
-  return open(file,O_WRONLY|O_CREAT|O_TRUNC|O_LARGEFILE,mode);
-}
diff -Naur ../../../dietlibc-0.34/lib/creat.c lib/creat.c
--- ../../../dietlibc-0.34/lib/creat.c	2002-02-24 00:18:42.000000000 +0200
+++ lib/creat.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <fcntl.h>
-
-int __libc_creat(const char *file,mode_t mode);
-int __libc_creat(const char *file,mode_t mode) {
-  return open(file,O_WRONLY|O_CREAT|O_TRUNC,mode);
-}
-int creat(const char *file,mode_t mode) __attribute__((weak,alias("__libc_creat")));
diff -Naur ../../../dietlibc-0.34/lib/div.c lib/div.c
--- ../../../dietlibc-0.34/lib/div.c	2005-10-07 20:43:02.000000000 +0300
+++ lib/div.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include "dietwarning.h"
-#include <stdlib.h>
-
-div_t div(int numerator, int denominator) {
-  div_t x;
-  x.quot=numerator/denominator;
-  x.rem=numerator-x.quot*denominator;
-  return x;
-}
-
-link_warning("div","warning: your code uses div(), which is completely superfluous!");
diff -Naur ../../../dietlibc-0.34/lib/__dtostr.c lib/__dtostr.c
--- ../../../dietlibc-0.34/lib/__dtostr.c	2016-04-30 00:49:28.000000000 +0300
+++ lib/__dtostr.c	2023-10-25 21:26:58.316228960 +0300
@@ -3,6 +3,8 @@
 #include <math.h>
 /* convert double to string.  Helper for sprintf. */
 
+int __isnan (double);
+
 static int copystring(char* buf,int maxlen, const char* s) {
   int i;
   for (i=0; i<maxlen; ++i) {
@@ -42,14 +44,14 @@
 		      (d<0)?
 		      (flags&0x02?"-INF":"-inf"):
 		      (flags&0x02?"INF":"inf"));
-  if (isnan(d)) return copystring(buf,maxlen,flags&0x02?"NAN":"nan");
+  if (__isnan(d)) return copystring(buf,maxlen,flags&0x02?"NAN":"nan");
   e10=1+(long)(e*0.30102999566398119802); /* log10(2) */
   /* Wir iterieren von Links bis wir bei 0 sind oder maxlen erreicht
    * ist.  Wenn maxlen erreicht ist, machen wir das nochmal in
-   * scientific notation.  Wenn dann von prec noch was Ã¼brig ist, geben
+   * scientific notation.  Wenn dann von prec noch was übrig ist, geben
    * wir einen Dezimalpunkt aus und geben prec2 Nachkommastellen aus.
    * Wenn prec2 Null ist, geben wir so viel Stellen aus, wie von prec
-   * noch Ã¼brig ist. */
+   * noch übrig ist. */
   if (d==0.0) {
     prec2=prec2==0?1:prec2+2;
     prec2=prec2>maxlen?8:prec2;
diff -Naur ../../../dietlibc-0.34/lib/errno.c lib/errno.c
--- ../../../dietlibc-0.34/lib/errno.c	2014-03-29 13:08:53.000000000 +0200
+++ lib/errno.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,3 +0,0 @@
-#define extern
-
-#include "errno_definition.h"
diff -Naur ../../../dietlibc-0.34/lib/errno_location.c lib/errno_location.c
--- ../../../dietlibc-0.34/lib/errno_location.c	2018-02-01 04:03:39.000000000 +0200
+++ lib/errno_location.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,9 +1,7 @@
-#include <sys/tls.h>
-#include <threads.h>
-#include <errno.h>
-#undef errno
-#include <errno_definition.h>
+
+//extern int errno;
+int errno;
 
-// int *__errno_location(void) __attribute__((weak));
-__attribute__((weak)) int *__errno_location(void) { return &errno; }
+int *__errno_location(void) __attribute__((weak));
+int *__errno_location() { return &errno; }
 
diff -Naur ../../../dietlibc-0.34/lib/eventfd.c lib/eventfd.c
--- ../../../dietlibc-0.34/lib/eventfd.c	2014-09-08 13:11:21.000000000 +0300
+++ lib/eventfd.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <sys/types.h>
-#include <fcntl.h>
-#include <errno.h>
-#include <sys/eventfd.h>
-
-extern int __eventfd(unsigned int count);
-extern int __eventfd2(unsigned int count,int flags);
-
-int eventfd(unsigned int count,int flags) {
-  int r=__eventfd2(count,flags);
-  if (r==-1 && errno==ENOSYS) {
-    r=__eventfd(count);
-    if (r!=-1 && flags) {
-      int x;
-      x=fcntl(r,F_SETFD,flags);
-      if (x==-1)
-	close(r);
-    }
-  }
-  return r;
-}
diff -Naur ../../../dietlibc-0.34/lib/execl.c lib/execl.c
--- ../../../dietlibc-0.34/lib/execl.c	2015-04-11 07:22:26.000000000 +0300
+++ lib/execl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,28 +0,0 @@
-#include <stdarg.h>
-#include <unistd.h>
-#include <errno.h>
-#include <stdlib.h>
-#include "dietfeatures.h"
-
-int execl( const char *path, const char* arg, ...) {
-  va_list ap,bak;
-  int n,i;
-  char **argv,*tmp;
-  (void)arg;
-  va_start(ap, arg);
-  va_copy(bak,ap);
-  n=2;
-  while ((tmp=va_arg(ap,char *)))
-    ++n;
-  va_end (ap);
-  if ((argv=(char **)alloca(n*sizeof(char*)))) {
-    argv[0]=(char*)arg;
-    for (i=1; i<n; ++i)
-      argv[i]=va_arg(bak,char *);
-    va_end (bak);
-    return execve(path,argv,environ);
-  }
-  va_end (bak);
-  errno=ENOMEM;
-  return -1;
-}
diff -Naur ../../../dietlibc-0.34/lib/execle.c lib/execle.c
--- ../../../dietlibc-0.34/lib/execle.c	2015-04-11 07:22:26.000000000 +0300
+++ lib/execle.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,28 +0,0 @@
-#include <stdarg.h>
-#include <unistd.h>
-#include <errno.h>
-#include <stdlib.h>
-#include "dietfeatures.h"
-
-int execle( const char *path, const char* arg, ...) {
-  va_list ap;
-  int n,i;
-  char **argv,*tmp, **env;
-  va_start(ap, arg);
-  (void)arg;
-  n=2;
-  while ((tmp=va_arg(ap,char *)))
-    ++n;
-  va_end (ap);
-  if ((argv=(char **)alloca(n*sizeof(char*)))) {
-    va_start(ap, arg);
-    argv[0]=(char*)arg;
-    for (i=1; i<n; ++i)
-      argv[i]=va_arg(ap,char *);
-    env=va_arg(ap, char **);
-    va_end (ap);
-    return execve(path,argv,env);
-  }
-  errno=ENOMEM;
-  return -1;
-}
diff -Naur ../../../dietlibc-0.34/lib/exec_lib.c lib/exec_lib.c
--- ../../../dietlibc-0.34/lib/exec_lib.c	2016-04-30 00:49:28.000000000 +0300
+++ lib/exec_lib.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,22 +0,0 @@
-#include <unistd.h>
-#include <paths.h>
-#include <alloca.h>
-
-extern char **environ;
-
-int __exec_shell(const char *file, char *const argv[]);
-int __exec_shell(const char *file, char *const argv[]) {
-  int i;
-  const char** shell_argv;
-
-  for (i = 0; argv[i]; ++i);
-  ++i;
-
-  shell_argv=alloca(sizeof(char*)*(i+1));
-  shell_argv[0] = _PATH_BSHELL;
-  shell_argv[1] = file;
-  for (; i > 1; i--)
-    shell_argv[i] = argv[i - 1];
-  return execve(_PATH_BSHELL, (char*const*)shell_argv, environ);
-}
-
diff -Naur ../../../dietlibc-0.34/lib/exec_lib.h lib/exec_lib.h
--- ../../../dietlibc-0.34/lib/exec_lib.h	2001-03-19 19:37:53.000000000 +0200
+++ lib/exec_lib.h	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#ifndef __EXEC_LIB_H
-#define __EXEC_LIB_H
-
-#include <paths.h>
-
-extern int __exec_shell(const char *file, char *const argv[]);
-
-#endif /* __EXEC_LIB_H */
-
diff -Naur ../../../dietlibc-0.34/lib/execlp.c lib/execlp.c
--- ../../../dietlibc-0.34/lib/execlp.c	2003-10-29 18:47:34.000000000 +0200
+++ lib/execlp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,27 +0,0 @@
-#include <stdarg.h>
-#include <unistd.h>
-#include <errno.h>
-#include <stdlib.h>
-#include "dietfeatures.h"
-
-int execlp(const char* file, const char *arg,...) {
-  va_list ap,bak;
-  int n,i;
-  char **argv,*tmp;
-  va_start(ap, arg);
-  va_copy(bak,ap);
-  n=2;
-  while ((tmp=va_arg(ap,char *)))
-    ++n;
-  va_end (ap);
-  if ((argv=(char **)alloca(n*sizeof(char*)))) {
-    argv[0]=(char*)arg;
-    for (i=0; i<n; ++i)
-      argv[i+1]=va_arg(bak,char *);
-    va_end (bak);
-    return execvp(file,argv);
-  }
-  va_end (bak);
-  errno=ENOMEM;
-  return -1;
-}
diff -Naur ../../../dietlibc-0.34/lib/execv.c lib/execv.c
--- ../../../dietlibc-0.34/lib/execv.c	2001-05-31 20:03:41.000000000 +0300
+++ lib/execv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,15 +0,0 @@
-#include <limits.h>
-#include <stdlib.h>
-#include <string.h>
-#include <unistd.h>
-#include <errno.h>
-#include "exec_lib.h"
-#include "dietfeatures.h"
-
-int execv(const char *file, char *const argv[]) {
-  if (execve(file,argv,environ)==-1) {
-    if (errno==ENOEXEC)
-      __exec_shell(file,argv);
-  }
-  return -1;
-}
diff -Naur ../../../dietlibc-0.34/lib/execvp.c lib/execvp.c
--- ../../../dietlibc-0.34/lib/execvp.c	2004-03-07 23:44:51.000000000 +0200
+++ lib/execvp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,47 +0,0 @@
-#include <limits.h>
-#include <stdlib.h>
-#include <string.h>
-#include <unistd.h>
-#include <errno.h>
-#include "exec_lib.h"
-#include "dietfeatures.h"
-
-int execvp(const char *file, char *const argv[]) {
-  const char *path=getenv("PATH");
-  char *cur,*next;
-  char buf[PATH_MAX];
-  if (strchr((char*)file,'/')) {
-    if (execve(file,argv,environ)==-1) {
-      if (errno==ENOEXEC)
-	__exec_shell(file,argv);
-      return -1;
-    }
-  }
-  if (!path) path=_PATH_DEFPATH;
-  for (cur=(char*)path; cur; cur=next) {
-    next=strchr(cur,':');
-    if (!next)
-      next=cur+strlen(cur);
-    if (next==cur) {
-      buf[0]='.';
-      cur--;
-    } else {
-      if (next-cur>=PATH_MAX-3) { error: errno=EINVAL; return -1; }
-      memmove(buf,cur,(size_t)(next-cur));
-    }
-    buf[next-cur]='/';
-    {
-      int len=strlen(file);
-      if (len+(next-cur)>=PATH_MAX-2) goto error;
-      memmove(&buf[next-cur+1],file,strlen(file)+1);
-    }
-    if (execve(buf,argv,environ)==-1) {
-      if (errno==ENOEXEC)
-	return __exec_shell(buf,argv);
-      if ((errno!=EACCES) && (errno!=ENOENT) && (errno!=ENOTDIR)) return -1;
-    }
-    if (*next==0) break;
-    next++;
-  }
-  return -1;
-}
diff -Naur ../../../dietlibc-0.34/lib/explicit_bzero.c lib/explicit_bzero.c
--- ../../../dietlibc-0.34/lib/explicit_bzero.c	2015-09-30 15:06:54.000000000 +0300
+++ lib/explicit_bzero.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <string.h>
-
-void explicit_bzero(void* dest,size_t len) {
-  memset(dest,0,len);
-  asm volatile("": : "r"(dest) : "memory");
-}
diff -Naur ../../../dietlibc-0.34/lib/__fcntl64.c lib/__fcntl64.c
--- ../../../dietlibc-0.34/lib/__fcntl64.c	2005-08-17 10:32:17.000000000 +0300
+++ lib/__fcntl64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,58 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#ifndef __NO_STAT64
-#include <fcntl.h>
-#include <stdarg.h>
-
-extern int __dietlibc_fcntl64(int __fd, int cmd, ...);
-
-int fcntl64(int fd, int cmd, ...) {
-  va_list va;
-  va_start(va,cmd);
-  switch (cmd) {
-  case F_GETLK:
-  case F_SETLK:
-  case F_SETLKW:
-    {
-      struct flock64* x = va_arg(va,struct flock64*);
-      struct flock tmp;
-      int res;
-      if ((res=__dietlibc_fcntl64(fd,cmd,x))) {
-	if (errno!=ENOSYS) return -1;
-	tmp.l_type=x->l_type;
-	tmp.l_whence=x->l_whence;
-	tmp.l_start=x->l_start;
-	tmp.l_len=x->l_len;
-	tmp.l_pid=x->l_pid;
-	if (tmp.l_len != x->l_len || tmp.l_start != x->l_start) {
-	  errno=EOVERFLOW;
-	  return -1;
-	}
-	res=fcntl(fd,cmd,&tmp);
-	if (cmd==F_GETLK) {
-	  x->l_type=tmp.l_type;
-	  x->l_whence=tmp.l_whence;
-	  x->l_start=tmp.l_start;
-	  x->l_len=tmp.l_len;
-	  x->l_pid=tmp.l_pid;
-	}
-      }
-      return res;
-    }
-
-  default:
-    {
-      long arg = va_arg(va,long);
-      int res;
-      if ((res=__dietlibc_fcntl64(fd,cmd,arg))==-1) {
-	if (errno!=ENOSYS) return -1;
-	return fcntl(fd,cmd,arg);
-      }
-      return res;
-    }
-  }
-}
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/fdopendir.c lib/fdopendir.c
--- ../../../dietlibc-0.34/lib/fdopendir.c	2013-05-25 02:36:59.000000000 +0300
+++ lib/fdopendir.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include "dietdirent.h"
-#include <sys/mman.h>
-#include <unistd.h>
-#include <dirent.h>
-#include <stdlib.h>
-#include <fcntl.h>
-
-DIR*  fdopendir ( int fd ) {
-  DIR*  t  = NULL;
-
-  if ( fd >= 0 ) {
-    t = (DIR *) mmap (NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, 
-		MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
-    if (t != MAP_FAILED)
-      t->fd = fd;
-  }
-
-
-  return t;
-}
diff -Naur ../../../dietlibc-0.34/lib/ffs.c lib/ffs.c
--- ../../../dietlibc-0.34/lib/ffs.c	2003-08-20 02:47:56.000000000 +0300
+++ lib/ffs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,31 +0,0 @@
-#include <strings.h>
-
-int ffs(int i) {
-  int plus=0;
-  /* return index of rightmost bit set */
-  /* ffs(1) == 1, ffs(2) == 2, ffs(256) == 9, ffs(257)=1 */
-#if 0
-  if (sizeof(i)==8)	/* fold 64-bit archs */
-    if ((i&0xffffffff)==0) {
-      plus=32;
-      i>>=32;
-    }
-#endif
-  if ((i&0xffff)==0) {
-    plus+=16;
-    i>>=16;
-  }
-  if ((i&0xff)==0) {
-    plus+=8;
-    i>>=8;
-  }
-  if ((i&0xf)==0) {
-    plus+=4;
-    i>>=4;
-  }
-  if (i&1) return plus+1;
-  if (i&2) return plus+2;
-  if (i&4) return plus+3;
-  if (i&8) return plus+4;
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/__finite.c lib/__finite.c
--- ../../../dietlibc-0.34/lib/__finite.c	2003-03-24 04:04:46.000000000 +0200
+++ lib/__finite.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <math.h>
-
-int finite(double d) {
-  return isinf(d)==0 && isnan(d)==0;
-}
-
-int __finite(double d) __attribute__((alias("finite")));
diff -Naur ../../../dietlibc-0.34/lib/__fstat64.c lib/__fstat64.c
--- ../../../dietlibc-0.34/lib/__fstat64.c	2001-05-31 19:12:27.000000000 +0300
+++ lib/__fstat64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#ifndef __NO_STAT64
-
-extern int __dietlibc_fstat64(int __fd, struct stat64 *__buf);
-extern void __stat64_cvt(const struct stat *src,struct stat64 *dest);
-
-int fstat64(int __fd, struct stat64 *__buf) {
-  if (__dietlibc_fstat64(__fd,__buf)) {
-    struct stat temp;
-    if (errno!=ENOSYS) return -1;
-    if (fstat(__fd,&temp)) return -1;
-    __stat64_cvt(&temp,__buf);
-  }
-  return 0;
-}
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__fstatat64.c lib/__fstatat64.c
--- ../../../dietlibc-0.34/lib/__fstatat64.c	2016-10-27 20:44:26.000000000 +0300
+++ lib/__fstatat64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,54 +0,0 @@
-#define _ATFILE_SOURCE
-#include <errno.h>
-#include "dietfeatures.h"
-#include "syscalls.h"
-
-#if defined(__NR_fstatat64) && defined(__NR_fstatat)
-
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#include <fcntl.h>
-#ifndef __NO_STAT64
-
-extern int __dietlibc_fstatat64(int dirfd, const char* pathname, struct stat64 *buf, int flags);
-extern void __stat64_cvt(const struct stat *src,struct stat64 *dest);
-
-int fstatat64(int dirfd, const char* pathname, struct stat64 *buf, int flags) {
-  if (__dietlibc_fstatat64(dirfd,pathname,buf,flags)) {
-    struct stat temp;
-    if (errno!=ENOSYS) return -1;
-    if (fstatat(dirfd,pathname,&temp,flags)) return -1;
-    __stat64_cvt(&temp,buf);
-  }
-  return 0;
-}
-#endif
-#endif
-
-#elif defined(__NR_fstatat64) && !defined(__NR_fstatat)
-
-#include <sys/stat.h>
-#include <fcntl.h>
-int fstatat(int dirfd, const char* pathname, struct stat *buf, int flags) {
-  struct stat64 ss;
-  if (fstatat64(dirfd,pathname,&ss,flags)==0) {
-    buf->st_dev=ss.st_dev;
-    buf->st_ino=ss.st_ino;
-    buf->st_mode=ss.st_mode;
-    buf->st_nlink=ss.st_nlink;
-    buf->st_uid=ss.st_uid;
-    buf->st_gid=ss.st_gid;
-    buf->st_rdev=ss.st_rdev;
-    buf->st_size=ss.st_size;
-    buf->st_blksize=ss.st_blksize;
-    buf->st_blocks=ss.st_blocks;
-    buf->st_atime=ss.st_atime;
-    buf->st_mtime=ss.st_mtime;
-    buf->st_ctime=ss.st_ctime;
-    if (buf->st_uid!=ss.st_uid || buf->st_gid!=ss.st_gid || buf->st_size!=ss.st_size || buf->st_ino!=ss.st_ino || buf->st_blocks!=ss.st_blocks)
-      errno=EOVERFLOW;
-  }
-  return 0;
-}
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__fstatfs64.c lib/__fstatfs64.c
--- ../../../dietlibc-0.34/lib/__fstatfs64.c	2007-03-26 06:06:59.000000000 +0300
+++ lib/__fstatfs64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,23 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#include <sys/statfs.h>
-
-#if __WORDSIZE == 32
-
-extern int __dietlibc_fstatfs64(int fd, size_t bufsize, struct statfs64 *__buf);
-extern void __statfs64_cvt(const struct statfs *src,struct statfs64 *dest);
-
-int fstatfs64(int fd, struct statfs64 *__buf) {
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-  if (__dietlibc_fstatfs64(fd,sizeof(*__buf),__buf)) {
-    struct statfs temp;
-    if (errno!=ENOSYS) return -1;
-    if (fstatfs(fd,&temp)) return -1;
-    __statfs64_cvt(&temp,__buf);
-  }
-  return 0;
-#else
-  return __dietlibc_fstatfs64(fd,sizeof(*__buf),__buf);
-#endif
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/fstatvfs.c lib/fstatvfs.c
--- ../../../dietlibc-0.34/lib/fstatvfs.c	2007-10-19 00:08:02.000000000 +0300
+++ lib/fstatvfs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#define _FILE_OFFSET_BITS 64
-#include <sys/statvfs.h>
-#include <sys/statfs.h>
-
-extern void __statvfs_cvt(struct statfs* from,struct statvfs* to);
-
-int fstatvfs(int fd, struct statvfs *sv) {
-  struct statfs ss;
-  if (fstatfs(fd,&ss)==-1) return -1;
-  __statvfs_cvt(&ss,sv);
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/__ftruncate64.c lib/__ftruncate64.c
--- ../../../dietlibc-0.34/lib/__ftruncate64.c	2002-10-21 16:02:06.000000000 +0300
+++ lib/__ftruncate64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,23 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#include "syscalls.h"
-#include <unistd.h>
-#ifndef __NO_STAT64
-#ifdef __NR_ftruncate64
-
-extern int __dietlibc_ftruncate64(int fd, loff_t o);
-
-int ftruncate64(int fd, loff_t o) {
-  int tmp;
-  if ((tmp=__dietlibc_ftruncate64(fd,o))==-1) {
-    if (errno!=ENOSYS) return -1;
-    if (o>0x7fffffff) { errno=EOVERFLOW; return -1; }
-    return ftruncate(fd,o);
-  }
-  return tmp;
-}
-#endif
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/ftw64.c lib/ftw64.c
--- ../../../dietlibc-0.34/lib/ftw64.c	2007-02-08 16:40:20.000000000 +0200
+++ lib/ftw64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,93 +0,0 @@
-#define _FILE_OFFSET_BITS 64
-#include <sys/stat.h>
-#include <unistd.h>
-#include <limits.h>
-#include <ftw.h>
-#include <dirent.h>
-#include <string.h>
-#include <stdlib.h>
-#include <fcntl.h>
-
-#ifdef __dietlibc__
-#include "dietdirent.h"
-#endif
-
-#ifndef O_DIRECTORY
-#define O_DIRECTORY 0
-#endif
-
-#ifdef __NO_STAT64
-int ftw64(const char*dir,int(*f)(const char*file,const struct stat* sb,int flag),int dpth) __THROW;
-#endif
-
-int ftw64(const char*dir,int(*f)(const char*file,const struct stat* sb,int flag),int dpth){
-  char* cd;
-  size_t cdl;
-  DIR* d;
-  struct dirent* de;
-  struct stat sb;
-  int r;
-  unsigned int oldlen=0;
-  char* filename = NULL;
-  int previous=open(".",O_RDONLY|O_DIRECTORY);
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-  int thisdir;
-#endif
-  if (chdir(dir)) return -1;
-  cd=alloca(PATH_MAX+1);
-  if (!getcwd(cd,PATH_MAX) || !(d=opendir("."))) {
-    close(previous);
-    return -1;
-  }
-  cd[PATH_MAX]='\0';
-  cdl=strlen(cd);
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-  if ((thisdir=open(".",O_RDONLY|O_DIRECTORY))==-1) {
-    closedir(d); return -1;
-  }
-#endif
-  while((de=readdir(d))){
-    int flg;
-    size_t nl;
-    if(de->d_name[0]=='.'){if(!de->d_name[1])continue;if(de->d_name[1]=='.'&&!de->d_name[2])continue;}
-    nl=strlen(de->d_name);
-    if (nl+cdl+2>oldlen)
-      filename=alloca(oldlen=nl+cdl+2);
-    memmove(filename,cd,cdl);
-    filename[cdl]='/';
-    memmove(filename+cdl+1,de->d_name,nl+1);
-    if(!lstat(de->d_name,&sb)){
-      if(S_ISLNK(sb.st_mode))flg=FTW_SL;else if(S_ISDIR(sb.st_mode))flg=FTW_D;else flg=FTW_F;
-    }else flg=FTW_NS;
-    r=f(filename,&sb,flg);
-    if(r){
-err:
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-      close(thisdir);
-#endif
-      closedir(d);
-      fchdir(previous);
-      close(previous);
-      return r;
-    }
-    if(flg==FTW_D&&dpth){
-      r=ftw(filename,f,dpth-1);
-#ifndef __dietlibc__
-#ifdef __MINGW32__
-      chdir("..");
-#else
-      fchdir(thisdir);
-#endif
-#else
-      fchdir(d->fd);
-#endif
-      if (r) goto err;
-    }
-  }
-  fchdir(previous);
-  close(previous);
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-  close(thisdir);
-#endif
-  return closedir(d);
-}
diff -Naur ../../../dietlibc-0.34/lib/ftw.c lib/ftw.c
--- ../../../dietlibc-0.34/lib/ftw.c	2006-09-20 16:04:30.000000000 +0300
+++ lib/ftw.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,88 +0,0 @@
-#include <sys/stat.h>
-#include <unistd.h>
-#include <limits.h>
-#include <ftw.h>
-#include <dirent.h>
-#include <string.h>
-#include <stdlib.h>
-#include <fcntl.h>
-
-#ifdef __dietlibc__
-#include "dietdirent.h"
-#endif
-
-#ifndef O_DIRECTORY
-#define O_DIRECTORY 0
-#endif
-
-int ftw(const char*dir,int(*f)(const char*file,const struct stat*sb,int flag),int dpth){
-  char* cd;
-  size_t cdl;
-  DIR* d;
-  struct dirent* de;
-  struct stat sb;
-  int r;
-  unsigned int oldlen=0;
-  char* filename = NULL;
-  int previous=open(".",O_RDONLY|O_DIRECTORY);
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-  int thisdir;
-#endif
-  if (chdir(dir)) return-1;
-  cd=alloca(PATH_MAX+1);
-  if (!getcwd(cd,PATH_MAX) || !(d=opendir("."))) {
-    close(previous);
-    return -1;
-  }
-  cd[PATH_MAX]='\0';
-  cdl=strlen(cd);
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-  if ((thisdir=open(".",O_RDONLY|O_DIRECTORY))==-1) {
-    closedir(d); return;
-  }
-#endif
-  while((de=readdir(d))){
-    int flg;
-    size_t nl;
-    if(de->d_name[0]=='.'){if(!de->d_name[1])continue;if(de->d_name[1]=='.'&&!de->d_name[2])continue;}
-    nl=strlen(de->d_name);
-    if (nl+cdl+2>oldlen)
-      filename=alloca(oldlen=nl+cdl+2);
-    memmove(filename,cd,cdl);
-    filename[cdl]='/';
-    memmove(filename+cdl+1,de->d_name,nl+1);
-    if(!lstat(de->d_name,&sb)){
-      if(S_ISLNK(sb.st_mode))flg=FTW_SL;else if(S_ISDIR(sb.st_mode))flg=FTW_D;else flg=FTW_F;
-    }else flg=FTW_NS;
-    r=f(filename,&sb,flg);
-    if(r){
-err:
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-      close(thisdir);
-#endif
-      closedir(d);
-      fchdir(previous);
-      close(previous);
-      return r;
-    }
-    if(flg==FTW_D&&dpth){
-      r=ftw(filename,f,dpth-1);
-#ifndef __dietlibc__
-#ifdef __MINGW32__
-      chdir("..");
-#else
-      fchdir(thisdir);
-#endif
-#else
-      fchdir(d->fd);
-#endif
-      if (r) goto err;
-    }
-  }
-  fchdir(previous);
-  close(previous);
-#if !defined(__dietlibc__) && !defined(__MINGW32__)
-  close(thisdir);
-#endif
-  return closedir(d);
-}
diff -Naur ../../../dietlibc-0.34/lib/__get_cur_tcb.c lib/__get_cur_tcb.c
--- ../../../dietlibc-0.34/lib/__get_cur_tcb.c	2014-03-16 00:18:58.000000000 +0200
+++ lib/__get_cur_tcb.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,26 +0,0 @@
-#include <sys/tls.h>
-
-tcbhead_t* __get_cur_tcb(void) {
-#if defined(__alpha__)
-  register void* cur asm("$0");
-  asm("call_pal 158" : "=r"(cur) );	/* PAL_rduniq = 158 */
-#else	/* alpha */
-  register void* cur=0;
-#if defined(__sparc__)
-  asm("mov %%g6,%0" : "=r"(cur) );	/* %g6 (res. system use) is used as thread pointer */
-#elif defined(__s390__)
-  asm("ear %0,%%a0" : "=d"(cur) );	/* a0 (access register 0) is used as thread pointer */
-#elif defined(__ia64__)
-  asm("mov %0 = r13" : "=r"(cur) );	/* r13 (tp) is used as thread pointer */
-#elif defined(__x86_64__)
-#ifdef __ILP32__
-  asm("movl %%fs:(0),%0" : "=r"(cur));
-#else
-  asm("movq %%fs:(0),%0" : "=r"(cur));
-#endif
-#elif defined(__i386__)
-  asm("movl %%gs:(0),%0" : "=r"(cur));
-#endif
-#endif /* __alpha__ */
-  return cur;
-}
diff -Naur ../../../dietlibc-0.34/lib/__getcwd.c lib/__getcwd.c
--- ../../../dietlibc-0.34/lib/__getcwd.c	2006-09-20 16:04:30.000000000 +0300
+++ lib/__getcwd.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <unistd.h>
-#include <stdlib.h>
-#include <errno.h>
-
-extern int __syscall_getcwd(char* buf, size_t size);
-
-char *getcwd(char *buf, size_t size) {
-  if (__unlikely(!size)) {
-    errno=EINVAL;
-    buf=0;
-  } else {
-    int tmp;
-    if ((tmp=__syscall_getcwd(buf,size-1))<0) return 0;
-    buf[tmp]=0;
-  }
-  return buf;
-}
diff -Naur ../../../dietlibc-0.34/lib/getdomainname.c lib/getdomainname.c
--- ../../../dietlibc-0.34/lib/getdomainname.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/getdomainname.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#define _GNU_SOURCE
-
-#include <sys/types.h>
-#include <sys/utsname.h>
-#include <unistd.h>
-
-int getdomainname(char *name,size_t len) {
-  struct utsname u;
-  int res=uname(&u);
-  if (res==0) {
-    size_t i;
-    if (len>=_UTSNAME_DOMAIN_LENGTH)
-      len=_UTSNAME_DOMAIN_LENGTH;
-    for (i=0; i<len; i++)
-      name[i]=u.domainname[i];
-  }
-  return res;
-}
diff -Naur ../../../dietlibc-0.34/lib/getentropy.c lib/getentropy.c
--- ../../../dietlibc-0.34/lib/getentropy.c	2017-02-07 18:32:36.000000000 +0200
+++ lib/getentropy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <sys/random.h>
-#include <errno.h>
-#include <fcntl.h>
-
-int getentropy(void* buf,size_t buflen) {
-  int r;
-  if (buflen>256) {
-    errno=EIO;
-    return -1;
-  }
-  r=getrandom(buf,buflen,GRND_NONBLOCK);
-  if (r==-1 && errno==ENOSYS) {
-    int fd=open("/dev/urandom",O_RDONLY);
-    if (fd==-1) return -1;
-    r=read(fd,buf,buflen);
-    close(fd);
-  }
-  if (r<(int)buflen)
-    return -1;
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/getenv.c lib/getenv.c
--- ../../../dietlibc-0.34/lib/getenv.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/getenv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include <stdlib.h>
-#include <string.h>
-
-extern char *getenv(const char *s)
-{
-  int i;
-  unsigned int len;
-
-  if (!environ || !s) return 0;
-  len = strlen(s);
-  for (i = 0;environ[i];++i)
-    if ((memcmp(environ[i],s,len)==0) && (environ[i][len] == '='))
-      return environ[i] + len + 1;
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/gethostname.c lib/gethostname.c
--- ../../../dietlibc-0.34/lib/gethostname.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/gethostname.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,19 +0,0 @@
-#define _GNU_SOURCE
-
-#include <sys/types.h>
-#include <sys/utsname.h>
-#include <unistd.h>
-
-int gethostname(char *name,size_t len) {
-  struct utsname u;
-  int res=uname(&u);
-  if (res==0) {
-    size_t i;
-    if (len>=_UTSNAME_NODENAME_LENGTH)
-      len=_UTSNAME_NODENAME_LENGTH;
-    for (i=0; i<len; i++)
-      name[i]=u.nodename[i];
-  }
-  return res;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/getpeername.c lib/getpeername.c
--- ../../../dietlibc-0.34/lib/getpeername.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/getpeername.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-#include <sys/socket.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_getpeername(int a, void * b, int *c);
-int __libc_getpeername(int a, void * b, int *c) {
-  long args[] = { a, (long) b, (long) c };
-  return socketcall(SYS_GETPEERNAME, args);
-}
-
-int getpeername(int a, struct sockaddr* b, socklen_t *c) __attribute__((weak,alias("__libc_getpeername")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/getpgrp.c lib/getpgrp.c
--- ../../../dietlibc-0.34/lib/getpgrp.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/getpgrp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <unistd.h>
-
-pid_t getpgrp()
-{
-  return getpgid(0);
-}
diff -Naur ../../../dietlibc-0.34/lib/_getpriority.c lib/_getpriority.c
--- ../../../dietlibc-0.34/lib/_getpriority.c	2012-01-15 20:56:57.000000000 +0200
+++ lib/_getpriority.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <sys/resource.h>
-
-extern int __syscall_getpriority(int which, int who);
-
-int getpriority(int which, int who) {
-  int r;
-
-  r = __syscall_getpriority(which, who);
-  if (r >= 0) r = 20 - r;
-  return r;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/getsockname.c lib/getsockname.c
--- ../../../dietlibc-0.34/lib/getsockname.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/getsockname.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-#include <sys/socket.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_getsockname(int a, void * b, int c);
-int __libc_getsockname(int a, void * b, int c) {
-  long args[] = { a, (long) b, c };
-  return socketcall(SYS_GETSOCKNAME, args);
-}
-
-int getsockname(int a, struct sockaddr* b, socklen_t* c) __attribute__((weak,alias("__libc_getsockname")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/getsockopt.c lib/getsockopt.c
--- ../../../dietlibc-0.34/lib/getsockopt.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/getsockopt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-#include <sys/socket.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_getsockopt(int a, int b, int c, void *d, int e);
-int __libc_getsockopt(int a, int b, int c, void *d, int e) {
-  long args[] = { a, b, c, (long)d, e };
-  return socketcall(SYS_GETSOCKOPT, args);
-}
-
-int getsockopt(int s, int level, int optname, void * optval, socklen_t *optlen) __attribute__((weak,alias("__libc_getsockopt")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/hcreate.c lib/hcreate.c
--- ../../../dietlibc-0.34/lib/hcreate.c	2014-10-13 00:38:40.000000000 +0300
+++ lib/hcreate.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include <search.h>
-
-static struct hsearch_data hd;
-
-int hcreate(size_t count) {
-  return hcreate_r(count,&hd);
-}
-
-void hdestroy(void) {
-  hdestroy_r(&hd);
-}
-
-ENTRY* hsearch(ENTRY item, ACTION action) {
-  ENTRY* x;
-  if (hsearch_r(item,action,&x,&hd))
-    return x;
-  return NULL;
-}
diff -Naur ../../../dietlibc-0.34/lib/hcreate_r.c lib/hcreate_r.c
--- ../../../dietlibc-0.34/lib/hcreate_r.c	2017-03-06 16:02:05.000000000 +0200
+++ lib/hcreate_r.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,29 +0,0 @@
-#define _LINUX_SOURCE
-#include <search.h>
-#include <stdlib.h>
-#include <unistd.h>
-#include <time.h>
-#include <sys/auxv.h>
-#include <sys/random.h>
-
-int hcreate_r(size_t count, struct hsearch_data* htab) {
-  htab->size=count;
-  htab->filled=0;
-  htab->table=calloc(count,sizeof(htab->table[0]));
-  if (htab->table) {
-    char* rnd=(char*)getauxval(AT_RANDOM);
-    if (rnd)
-      memcpy(htab->key,rnd,16);
-    else {
-      struct timeval tv;
-      struct timeval* x=(struct timeval*)htab->key;
-      if (getrandom(&htab->key,sizeof(htab->key),0) != sizeof(htab->key)) {
-	gettimeofday(&tv,NULL);
-	x->tv_sec += tv.tv_sec;
-	x->tv_usec += tv.tv_usec;
-      }
-    }
-  }
-  return htab->table ? 1 : 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/hdestroy_r.c lib/hdestroy_r.c
--- ../../../dietlibc-0.34/lib/hdestroy_r.c	2014-10-13 00:38:41.000000000 +0300
+++ lib/hdestroy_r.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,19 +0,0 @@
-#define _GNU_SOURCE
-#include <search.h>
-#include <stdlib.h>
-
-static void freelist(struct bucket* b) {
-  while (b) {
-    struct bucket* o=b;
-    b=b->next;
-    free(o);
-  }
-}
-
-void hdestroy_r(struct hsearch_data* htab) {
-  size_t i;
-  for (i=0; i<htab->size; ++i) {
-    freelist(htab->table[i]);
-    htab->table[i]=0;
-  }
-}
diff -Naur ../../../dietlibc-0.34/lib/hsearch_r.c lib/hsearch_r.c
--- ../../../dietlibc-0.34/lib/hsearch_r.c	2014-10-13 00:38:41.000000000 +0300
+++ lib/hsearch_r.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,68 +0,0 @@
-#define _GNU_SOURCE
-#include <search.h>
-#include <string.h>
-#include <errno.h>
-#include <stdlib.h>
-
-static const size_t primes[] = {
-  67, 127, 257, 521, 1031, 2053, 4099, 8191, 16381, 32771, 65537,
-  131071, 262147, 524287, 1048583, 2097143 };
-
-static const unsigned int nprimes = sizeof(primes)/sizeof(primes[0]);
-
-int hsearch_r(ENTRY item, ACTION action, ENTRY** retval, struct hsearch_data* htab) {
-  uint64_t hv=siphash24(htab->key,(const unsigned char*)item.key,strlen(item.key));
-  struct bucket** b=&htab->table[hv%htab->size];
-  while (*b) {
-    if ((*b)->hv==hv && !strcmp((*b)->e.key,item.key)) {
-      /* found */
-      if (retval) *retval=&(*b)->e;
-      return 1;
-    }
-    b=(&(*b)->next);
-  }
-  if (action==FIND) {
-    errno=ESRCH;
-    return 0;
-  }
-  /* if we get this far, we are supposed to add the key */
-  if (htab -> size < primes[nprimes-1] && htab->filled+1 > htab->size) {
-    /* attempt to resize */
-    unsigned int i;
-    struct bucket** n;
-    for (i=0; i<nprimes; ++i)
-      if (htab->size < primes[i]) break;
-    i=primes[i];
-    n=calloc(i,sizeof(struct bucket*));
-    /* If the allocation failed, we can just limp on.
-      * Performance will be reduced but we'll live. */
-    if (n) {
-      unsigned int j;
-
-      for (j=0; j<htab->size; ++j) {
-	struct bucket* B=htab->table[j];
-	while (B) {
-	  struct bucket* c=B;
-	  B=B->next;
-	  unsigned int m=c->hv % i;
-	  c->next=n[m];
-	  n[m]=c;
-	}
-      }
-      free(htab->table);
-      htab->table=n;
-      htab->size=i;
-      b=&htab->table[hv%htab->size];
-      while (*b)
-	b=(&(*b)->next);
-    }
-  }
-  *b=malloc(sizeof(struct bucket));
-  if (!*b) return 0;
-  ++htab->filled;
-  (*b)->next=0;
-  (*b)->e=item;
-  (*b)->hv=hv;
-  if (retval) *retval=&(*b)->e;
-  return 1;
-}
diff -Naur ../../../dietlibc-0.34/lib/htonl.c lib/htonl.c
--- ../../../dietlibc-0.34/lib/htonl.c	2003-08-19 19:32:23.000000000 +0300
+++ lib/htonl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#include <endian.h>
-#include <netinet/in.h>
-
-uint32_t htonl(uint32_t hostlong) {
-#if __BYTE_ORDER==__LITTLE_ENDIAN
-  return (hostlong>>24) | ((hostlong&0xff0000)>>8) |
-	  ((hostlong&0xff00)<<8) | (hostlong<<24);
-#else
-  return hostlong;
-#endif
-}
-
-uint32_t ntohl(uint32_t hostlong) __attribute__((weak,alias("htonl")));
diff -Naur ../../../dietlibc-0.34/lib/htons.c lib/htons.c
--- ../../../dietlibc-0.34/lib/htons.c	2003-08-19 19:32:23.000000000 +0300
+++ lib/htons.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <endian.h>
-#include <netinet/in.h>
-
-uint16_t htons(uint16_t hostshort) {
-#if __BYTE_ORDER==__LITTLE_ENDIAN
-  return ((hostshort>>8)&0xff) | (hostshort<<8);
-#else
-  return hostshort;
-#endif
-}
-
-uint16_t ntohs(uint16_t hostshort) __attribute__((weak,alias("htons")));
diff -Naur ../../../dietlibc-0.34/lib/if_freenameindex.c lib/if_freenameindex.c
--- ../../../dietlibc-0.34/lib/if_freenameindex.c	2014-10-10 13:42:16.000000000 +0300
+++ lib/if_freenameindex.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <net/if.h>
-#include <stdlib.h>
-
-void if_freenameindex(struct if_nameindex* ptr) {
-  free(ptr);
-}
diff -Naur ../../../dietlibc-0.34/lib/if_indextoname.c lib/if_indextoname.c
--- ../../../dietlibc-0.34/lib/if_indextoname.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/if_indextoname.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,28 +0,0 @@
-#include <net/if.h>
-#include <sys/ioctl.h>
-#include <unistd.h>
-#include <sys/socket.h>
-
-#ifndef SOCK_DGRAM
-#define SOCK_DGRAM 2
-#endif
-
-char* if_indextoname(unsigned int interface,char* blub) {
-  struct ifreq ifr;
-  int fd;
-
-  fd=socket(AF_INET6,SOCK_DGRAM,0);
-  if (fd<0) fd=socket(AF_INET,SOCK_DGRAM,0);
-  ifr.ifr_ifindex=interface;
-  if (ioctl(fd,SIOCGIFNAME,&ifr)==0) {
-    int i;
-    close(fd);
-    for (i=0; i<IFNAMSIZ-1; i++)
-      if (!(blub[i]=ifr.ifr_name[i]))
-	return blub;
-    blub[i]=0;
-    return blub;
-  }
-  close(fd);
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/if_nameindex.c lib/if_nameindex.c
--- ../../../dietlibc-0.34/lib/if_nameindex.c	2006-07-04 06:33:02.000000000 +0300
+++ lib/if_nameindex.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,38 +0,0 @@
-#include <net/if.h>
-#include <unistd.h>
-#include <string.h>
-#include <stdlib.h>
-#include <sys/ioctl.h>
-#include <stdio.h>
-
-struct if_nameindex* if_nameindex(void) {
-  struct ifconf ic;
-  int fd,len,i;
-  struct if_nameindex* x=0,* y;
-  char *dest;
-  fd=socket(AF_INET6,SOCK_DGRAM,0);
-  if (fd<0) fd=socket(AF_INET,SOCK_DGRAM,0);
-  ic.ifc_buf=0;
-  ic.ifc_len=0;
-  if (ioctl(fd,SIOCGIFCONF,&ic)<0) goto b0rken;
-  ic.ifc_buf=alloca((size_t)ic.ifc_len);
-  if (ioctl(fd,SIOCGIFCONF,&ic)<0) goto b0rken;
-  len=(ic.ifc_len/sizeof(struct ifreq));
-  x=(struct if_nameindex*)malloc((len+1)*sizeof(struct if_nameindex)+len*IFNAMSIZ);
-  if (!x) goto b0rken;
-  dest=(char*)(x+len+1);
-  y=x;
-  for (i=0; i<len; ++i) {
-    struct ifreq* ir=(struct ifreq*)&ic.ifc_req[i];
-    y->if_name=dest;
-    memcpy(dest,ir->ifr_name,IFNAMSIZ);
-    if (ioctl(fd,SIOCGIFINDEX,ir)==-1) continue;
-    y->if_index=ir->ifr_ifindex;
-    dest+=IFNAMSIZ;
-    ++y;
-  }
-  y->if_name=0; y->if_index=0;
-b0rken:
-  close(fd);
-  return x;
-}
diff -Naur ../../../dietlibc-0.34/lib/if_nametoindex.c lib/if_nametoindex.c
--- ../../../dietlibc-0.34/lib/if_nametoindex.c	2006-07-04 06:33:02.000000000 +0300
+++ lib/if_nametoindex.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,25 +0,0 @@
-#include <net/if.h>
-#include <sys/ioctl.h>
-#include <unistd.h>
-#include <sys/socket.h>
-
-#ifndef SOCK_DGRAM
-#define SOCK_DGRAM 2
-#endif
-
-unsigned int if_nametoindex(const char* blub) {
-  struct ifreq ifr;
-  int fd;
-  int ret=0;
-  char *tmp;
-  int len=sizeof(ifr.ifr_name);
-  fd=socket(AF_INET6,SOCK_DGRAM,0);
-  if (fd<0) fd=socket(AF_INET,SOCK_DGRAM,0);
-  for (tmp=ifr.ifr_name; len>0; --len) {
-    if ((*tmp++=*blub++)==0) break;
-  }
-  if (ioctl(fd,SIOCGIFINDEX,&ifr)==0)
-    ret=ifr.ifr_ifindex;
-  close(fd);
-  return ret;
-}
diff -Naur ../../../dietlibc-0.34/lib/__inotify_init.c lib/__inotify_init.c
--- ../../../dietlibc-0.34/lib/__inotify_init.c	2018-08-17 13:13:11.000000000 +0300
+++ lib/__inotify_init.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <sys/inotify.h>
-#include "syscalls.h"
-
-#if defined(__NR_inotify_init1) && !defined(__NR_inotify_init)
-int inotify_init() {
-  return inotify_init1(0);
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/ipv6constants.c lib/ipv6constants.c
--- ../../../dietlibc-0.34/lib/ipv6constants.c	2001-09-03 16:09:30.000000000 +0300
+++ lib/ipv6constants.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,4 +0,0 @@
-#include "netinet/in.h"
-
-const struct in6_addr in6addr_any = IN6ADDR_ANY_INIT;
-const struct in6_addr in6addr_loopback = IN6ADDR_LOOPBACK_INIT;
diff -Naur ../../../dietlibc-0.34/lib/isatty.c lib/isatty.c
--- ../../../dietlibc-0.34/lib/isatty.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/isatty.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#define ioctl libc_ioctl
-#include <termios.h>
-#undef ioctl
-#include <sys/ioctl.h>
-#include <errno.h>
-#include <unistd.h>
-#include "dietfeatures.h"
-
-int isatty(int fd) {
-  int save;
-  int is_tty;
-  struct termios term;
-
-  save = errno;
-  is_tty = ioctl(fd, TCGETS, &term) == 0;
-  errno = save;
-
-  return is_tty;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/iscntrl.c lib/iscntrl.c
--- ../../../dietlibc-0.34/lib/iscntrl.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/iscntrl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <ctype.h>
-
-int __iscntrl_ascii ( int ch );
-int __iscntrl_ascii ( int ch ) {
-    return (unsigned int)ch < 32u  ||  ch == 127;
-}
-
-int iscntrl ( int ch ) __attribute__((weak,alias("__iscntrl_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/__isinf.c lib/__isinf.c
--- ../../../dietlibc-0.34/lib/__isinf.c	2003-09-15 02:29:03.000000000 +0300
+++ lib/__isinf.c	2023-10-14 22:05:22.491036121 +0300
@@ -1,6 +1,9 @@
+
 #include <math.h>
+
+
 
-int isinf(double d) {
+int __isinf(double d) {
   union {
     unsigned long long l;
     double d;
@@ -8,7 +11,7 @@
   u.d=d;
   return (u.l==0x7FF0000000000000ll?1:u.l==0xFFF0000000000000ll?-1:0);
 }
-int __isinf(double d) __attribute__((alias("isinf")));
+//int __isinf(double d) __attribute__((alias("isinf")));
 
 #if 0
 TestFromIeeeExtended("7FFF0000000000000000");   /* +infinity */
diff -Naur ../../../dietlibc-0.34/lib/__isnan.c lib/__isnan.c
--- ../../../dietlibc-0.34/lib/__isnan.c	2003-09-15 02:29:03.000000000 +0300
+++ lib/__isnan.c	2023-10-16 17:10:43.406124463 +0300
@@ -1,6 +1,6 @@
 #include <math.h>
 
-int isnan(double d) {
+int __isnan(double d) {
   union {
     unsigned long long l;
     double d;
@@ -8,7 +8,6 @@
   u.d=d;
   return (u.l==0x7FF8000000000000ll || u.l==0x7FF0000000000000ll || u.l==0xfff8000000000000ll);
 }
-int __isnan(double d) __attribute__((alias("isnan")));
 
 #if 0
 TestFromIeeeExtended("7FFF0000000000000000");   /* +infinity */
diff -Naur ../../../dietlibc-0.34/lib/iswalnum.c lib/iswalnum.c
--- ../../../dietlibc-0.34/lib/iswalnum.c	2005-07-23 01:43:09.000000000 +0300
+++ lib/iswalnum.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <ctype.h>
-#include <wctype.h>
-
-int __iswalnum_ascii(wint_t c);
-int __iswalnum_ascii(wint_t c) {
-  return (((unsigned char)c == c)?isalnum(c):0);
-}
-
-int iswalnum(wint_t c) __attribute__((weak,alias("__iswalnum_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswalpha.c lib/iswalpha.c
--- ../../../dietlibc-0.34/lib/iswalpha.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswalpha.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <ctype.h>
-#include <wctype.h>
-
-int __iswalpha_ascii(wint_t c);
-int __iswalpha_ascii(wint_t c) {
-  return (((unsigned char)c == c)?isalpha(c):0);
-}
-
-int iswalpha(wint_t c) __attribute__((weak,alias("__iswalpha_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswblank.c lib/iswblank.c
--- ../../../dietlibc-0.34/lib/iswblank.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswblank.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-int __iswblank_ascii(wint_t c);
-int __iswblank_ascii(wint_t c) {
-  return (c == ' ' || c == '\t');
-}
-
-int iswblank(wint_t c) __attribute__((weak,alias("__iswblank_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswcntrl.c lib/iswcntrl.c
--- ../../../dietlibc-0.34/lib/iswcntrl.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswcntrl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-int __iswcntrl_ascii(wint_t c);
-int __iswcntrl_ascii(wint_t c) {
-  return ((unsigned int)c < 32u || c == 127);
-}
-
-int iswcntrl(wint_t c) __attribute__((weak,alias("__iswcntrl_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswdigit.c lib/iswdigit.c
--- ../../../dietlibc-0.34/lib/iswdigit.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswdigit.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,5 +0,0 @@
-#include <wctype.h>
-
-int iswdigit(wint_t c) {
-    return (unsigned int)(c - '0') < 10u;
-}
diff -Naur ../../../dietlibc-0.34/lib/iswgraph.c lib/iswgraph.c
--- ../../../dietlibc-0.34/lib/iswgraph.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswgraph.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-int __iswgraph_ascii(wint_t c);
-int __iswgraph_ascii(wint_t c) {
-  return (unsigned int)(c - '!') < 127u - '!';
-}
-
-int iswgraph(wint_t c) __attribute__((weak,alias("__iswgraph_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswlower.c lib/iswlower.c
--- ../../../dietlibc-0.34/lib/iswlower.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswlower.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-int __iswlower_ascii(wint_t c);
-int __iswlower_ascii(wint_t c) {
-  return (unsigned int) (c - 'a') < 26u;
-}
-
-int iswlower ( wint_t ch ) __attribute__((weak,alias("__iswlower_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswprint.c lib/iswprint.c
--- ../../../dietlibc-0.34/lib/iswprint.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswprint.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-int __iswprint_ascii(wint_t c);
-int __iswprint_ascii(wint_t c) {
-    return (unsigned int)(c - ' ') < 127u - ' ';
-}
-
-int iswprint(wint_t c) __attribute__((weak,alias("__iswprint_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswpunct.c lib/iswpunct.c
--- ../../../dietlibc-0.34/lib/iswpunct.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswpunct.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <wctype.h>
-
-int __iswpunct_ascii(wint_t c);
-int __iswpunct_ascii(wint_t c)
-{
-  return iswprint (c) && !iswalnum(c) && !iswspace(c);
-}
-
-int iswpunct(wint_t c) __attribute__((weak,alias("__iswpunct_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswspace.c lib/iswspace.c
--- ../../../dietlibc-0.34/lib/iswspace.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswspace.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-int __iswspace_ascii(wint_t c);
-int __iswspace_ascii(wint_t c) {
-  return (unsigned int)(c - 9) < 5u  ||  c == ' ';
-}
-
-int iswspace(wint_t c) __attribute__((weak,alias("__iswspace_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswupper.c lib/iswupper.c
--- ../../../dietlibc-0.34/lib/iswupper.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswupper.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <wctype.h>
-
-int __iswupper_ascii ( wint_t c );
-int __iswupper_ascii ( wint_t c )
-{
-    return (unsigned int)(c - 'A') < 26u;
-}
-
-int iswupper ( wint_t c ) __attribute__((weak,alias("__iswupper_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/iswxdigit.c lib/iswxdigit.c
--- ../../../dietlibc-0.34/lib/iswxdigit.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/iswxdigit.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <wctype.h>
-
-int __iswxdigit_ascii(wint_t c);
-int __iswxdigit_ascii(wint_t c)
-{
-    return (unsigned int)( c         - '0') < 10u  ||
-           (unsigned int)((c | 0x20) - 'a') <  6u;
-}
-
-int iswxdigit(wint_t c) __attribute__((weak,alias("__iswxdigit_ascii")));
diff -Naur ../../../dietlibc-0.34/lib/latin1-iscntrl.c lib/latin1-iscntrl.c
--- ../../../dietlibc-0.34/lib/latin1-iscntrl.c	1970-01-01 03:00:00.000000000 +0300
+++ lib/latin1-iscntrl.c	2023-10-14 22:05:22.491036121 +0300
@@ -0,0 +1,6 @@
+#include <ctype.h>
+
+int iscntrl(int x) {
+  unsigned char c=x&0xff;
+  return (c<32) || (c>=127 && c<=160);
+}
diff -Naur ../../../dietlibc-0.34/lib/lc_ctype.c lib/lc_ctype.c
--- ../../../dietlibc-0.34/lib/lc_ctype.c	2006-04-04 06:10:40.000000000 +0300
+++ lib/lc_ctype.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,3 +0,0 @@
-#include "dietlocale.h"
-
-enum __encoding lc_ctype=CT_8BIT;
diff -Naur ../../../dietlibc-0.34/lib/ldiv.c lib/ldiv.c
--- ../../../dietlibc-0.34/lib/ldiv.c	2005-07-19 12:43:09.000000000 +0300
+++ lib/ldiv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <stdlib.h>
-
-ldiv_t ldiv(long numerator, long denominator) {
-  ldiv_t x;
-  x.quot=numerator/denominator;
-  x.rem=numerator-x.quot*denominator;
-  return x;
-}
diff -Naur ../../../dietlibc-0.34/lib/listen.c lib/listen.c
--- ../../../dietlibc-0.34/lib/listen.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/listen.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-#include <sys/socket.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_listen(int a, int b);
-int __libc_listen(int a, int b) {
-  long args[] = { a, b, 0 };
-  return socketcall(SYS_LISTEN, args);
-}
-
-int listen(int s, int backlog) __attribute__((weak,alias("__libc_listen")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/lldiv.c lib/lldiv.c
--- ../../../dietlibc-0.34/lib/lldiv.c	2010-09-23 05:11:00.000000000 +0300
+++ lib/lldiv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#define _GNU_SOURCE
-#include <stdlib.h>
-#include <inttypes.h>
-
-lldiv_t lldiv(long long numerator, long long denominator) {
-  lldiv_t x;
-  x.quot=numerator/denominator;
-  x.rem=numerator-x.quot*denominator;
-  return x;
-}
-
-imaxdiv_t imaxdiv(intmax_t numerator, intmax_t denominator)  __attribute__((alias("lldiv")));
diff -Naur ../../../dietlibc-0.34/lib/__lltostr.c lib/__lltostr.c
--- ../../../dietlibc-0.34/lib/__lltostr.c	2016-03-29 18:56:33.000000000 +0300
+++ lib/__lltostr.c	2023-10-14 22:05:22.491036121 +0300
@@ -1,8 +1,8 @@
 #include <string.h>
 
-int __lltostr(char *s, unsigned int size, unsigned long long i, unsigned int base, int UpCase);
+int __lltostr(char *s, int size, unsigned long long i, int base, char UpCase);
 
-int __lltostr(char *s, unsigned int size, unsigned long long i, unsigned int base, int UpCase)
+int __lltostr(char *s, int size, unsigned long long i, int base, char UpCase)
 {
   char *tmp;
   unsigned int j=0;
diff -Naur ../../../dietlibc-0.34/lib/lockf.c lib/lockf.c
--- ../../../dietlibc-0.34/lib/lockf.c	2001-05-31 20:03:41.000000000 +0300
+++ lib/lockf.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,38 +0,0 @@
-#include <sys/types.h>
-#include <fcntl.h>
-#include <unistd.h>
-#include <errno.h>
-#include "dietfeatures.h"
-
-int lockf(int fd, int cmd, off_t len) {
-  struct flock fl;
-  fl.l_whence=SEEK_CUR;
-  fl.l_start=0;
-  fl.l_len=len;
-  fl.l_pid=0;
-  switch (cmd) {
-  case F_TEST:
-    if (fcntl(fd,F_GETLK,&fl)<0)
-      return -1;
-    if (fl.l_type == F_UNLCK || fl.l_pid == getpid ())
-      return 0;
-    errno=EACCES;
-    return -1;
-  case F_ULOCK:
-    fl.l_type=F_UNLCK;
-    cmd=F_SETLK;
-    break;
-  case F_LOCK:
-    fl.l_type = F_WRLCK;
-    cmd = F_SETLKW;
-    break;
-  case F_TLOCK:
-    fl.l_type = F_WRLCK;
-    cmd = F_SETLK;
-    break;
-  default:
-    errno=EINVAL;
-    return -1;
-  }
-  return fcntl(fd,cmd,&fl);
-}
diff -Naur ../../../dietlibc-0.34/lib/longjmp.c lib/longjmp.c
--- ../../../dietlibc-0.34/lib/longjmp.c	2002-03-20 18:57:53.000000000 +0200
+++ lib/longjmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include <setjmp.h>
-#include <signal.h>
-
-void __longjmp(void*env,int val);
-
-void __libc_longjmp(sigjmp_buf env,int val);
-void __libc_longjmp(sigjmp_buf env,int val) {
-  if (env[0].__mask_was_saved) {
-    sigprocmask(SIG_SETMASK,(sigset_t*)&env[0].__saved_mask,0);
-  }
-  if (val==0) val=1;
-  __longjmp(env[0].__jmpbuf,val);
-}
-void __siglongjmp(sigjmp_buf env,int val) __attribute__((alias("__libc_longjmp")));
-void longjmp(sigjmp_buf env,int val) __attribute__((weak,alias("__libc_longjmp")));
-void siglongjmp(sigjmp_buf env,int val) __attribute__((weak,alias("__libc_longjmp")));
diff -Naur ../../../dietlibc-0.34/lib/lseek64.c lib/lseek64.c
--- ../../../dietlibc-0.34/lib/lseek64.c	2001-11-12 16:47:00.000000000 +0200
+++ lib/lseek64.c	2023-10-14 22:05:22.491036121 +0300
@@ -7,10 +7,10 @@
 
 loff_t lseek64(int fildes, loff_t offset, int whence) {
   loff_t tmp;
-  if (llseek(fildes,(unsigned long)(offset>>32),(unsigned long)offset&0xffffffff,&tmp,whence)) {
-    if (errno!=ENOSYS) return -1;
+  //if (llseek(fildes,(unsigned long)(offset>>32),(unsigned long)offset&0xffffffff,&tmp,whence)) {
+  //  if (errno!=ENOSYS) return -1;
     return (loff_t)lseek(fildes,(off_t)offset,whence);
-  }
+  //}
   return tmp;
 }
 #endif
diff -Naur ../../../dietlibc-0.34/lib/__lstat64.c lib/__lstat64.c
--- ../../../dietlibc-0.34/lib/__lstat64.c	2001-05-31 19:12:27.000000000 +0300
+++ lib/__lstat64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#ifndef __NO_STAT64
-
-extern int __dietlibc_lstat64(const char *__file, struct stat64 *__buf);
-extern void __stat64_cvt(const struct stat *src,struct stat64 *dest);
-
-int lstat64(const char *__file, struct stat64 *__buf) {
-  if (__dietlibc_lstat64(__file,__buf)) {
-    struct stat temp;
-    if (errno!=ENOSYS) return -1;
-    if (lstat(__file,&temp)) return -1;
-    __stat64_cvt(&temp,__buf);
-  }
-  return 0;
-}
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/makecontext.c lib/makecontext.c
--- ../../../dietlibc-0.34/lib/makecontext.c	2014-10-10 21:23:27.000000000 +0300
+++ lib/makecontext.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,69 +0,0 @@
-#include <ucontext.h>
-#include <stdarg.h>
-
-extern void __setcontext_trampoline();
-
-void makecontext(ucontext_t* c, void (*func)(void), int argc, ...) {
-  size_t* sp;
-  va_list v;
-  int i;
-#ifdef __hppa__
-#define PUSH(val) *++sp=(val);
-#else
-#define PUSH(val) *--sp=(val);
-#endif
-  /* we are called like this:
-
-    if (getcontext(&uctx_func1) == -1)
-        handle_error("getcontext");
-    uctx_func1.uc_stack.ss_sp = func1_stack;
-    uctx_func1.uc_stack.ss_size = sizeof(func1_stack);
-    uctx_func1.uc_link = &uctx_main;
-    makecontext(&uctx_func1, func1, 0);
-  */
-
-  /* first order of business: set up the stack */
-  /* the &-16 aligns it to 16 bytes */
-  sp=(size_t*)((size_t)(c->uc_stack.ss_sp + c->uc_stack.ss_size)&-16);
-  /* note that if the provided stack is to small, we will just crash in here */
-  va_start(v,argc);
-#ifdef __i386__
-  /* if there are no args, we need to make sure there is space on the
-   * stack for the trampoline to pretend uc_link was passed as stack
-   * argument */
-  if (!argc) PUSH(0);
-  /* we set up the context so we jump to it directly, and we leave
-   * __setcontext_trampoline as return address on the stack. */
-  /* __setcontext_trampoline needs to know the c->uc_link, so we put
-   * that into ebx, which is callee-saved */
-  c->uc_mcontext.ebx=(size_t)c->uc_link;
-  sp-=argc;
-  for (i=0; i<argc; ++i)
-    sp[i]=va_arg(v,size_t);
-  PUSH((size_t)__setcontext_trampoline);
-  c->uc_mcontext.esp=(size_t)sp;
-  c->uc_mcontext.eip=(size_t)func;
-#elif defined __x86_64__
-  /* __setcontext_trampoline needs to know the c->uc_link, so we put
-   * that into ebx, which is callee-saved */
-  c->uc_mcontext.rbx=(size_t)c->uc_link;
-  for (i=0; i<argc; ++i) {
-    switch(i) {
-    case 0: c->uc_mcontext.rdi=va_arg(v,size_t); break;
-    case 1: c->uc_mcontext.rsi=va_arg(v,size_t); break;
-    case 2: c->uc_mcontext.rdx=va_arg(v,size_t); break;
-    case 3: c->uc_mcontext.rcx=va_arg(v,size_t); break;
-    case 4: c->uc_mcontext.r8=va_arg(v,size_t); break;
-    case 5: c->uc_mcontext.r9=va_arg(v,size_t); break;
-    default: /* the rest goes on the stack */
-      PUSH(va_arg(v,size_t));
-    }
-  }
-  PUSH((size_t)__setcontext_trampoline);
-  c->uc_mcontext.rsp=(size_t)sp;
-  c->uc_mcontext.rip=(size_t)func;
-#else
-#warning platform not supported yet in makecontext
-#endif
-  va_end(v);
-}
diff -Naur ../../../dietlibc-0.34/lib/mblen.c lib/mblen.c
--- ../../../dietlibc-0.34/lib/mblen.c	2007-09-20 21:51:18.000000000 +0300
+++ lib/mblen.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <stdlib.h>
-#include <wchar.h>
-
-int mblen(const char* s,size_t n) {
-  return mbrlen(s,n,NULL);
-}
diff -Naur ../../../dietlibc-0.34/lib/mbrlen.c lib/mbrlen.c
--- ../../../dietlibc-0.34/lib/mbrlen.c	2014-03-24 10:22:54.000000000 +0200
+++ lib/mbrlen.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <wchar.h>
-#include <errno.h>
-
-size_t mbrlen(const char *s, size_t n, mbstate_t *ps) {
-  static mbstate_t internal;
-  return mbrtowc (NULL, s, n, ps ?: &internal);
-}
diff -Naur ../../../dietlibc-0.34/lib/mbrtowc.c lib/mbrtowc.c
--- ../../../dietlibc-0.34/lib/mbrtowc.c	2008-10-01 00:02:35.000000000 +0300
+++ lib/mbrtowc.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,67 +0,0 @@
-#include "dietlocale.h"
-#include <wchar.h>
-#include <errno.h>
-
-static mbstate_t internal;
-
-size_t mbrtowc(wchar_t *pwc, const char *s, size_t n, mbstate_t *ps) {
-  size_t i;
-  if (!ps) ps=&internal;
-  if (!s) {
-    if (ps->count) {
-      errno=EILSEQ;
-      return (size_t)-1;
-    } else {
-      ps->count=0;
-      ps->sofar=0;
-      return 0;
-    }
-  }
-  for (i=0; i<n; ++i) {
-    unsigned char c=s[i];
-    switch (lc_ctype) {
-    case CT_8BIT:
-      if (pwc) { *pwc=c; ++pwc; }
-      return (!!c);
-    case CT_UTF8:
-      if (ps->count) {
-	/* we have an unfinished multibyte sequence */
-	if ((c&0xc0)!=0x80) {
-	  /* expected a continuation, didn't get one */
-kaputt:
-	  errno=EILSEQ;
-	  ps->count=0;
-	  return (size_t)-1;
-	}
-	ps->sofar=(ps->sofar << 6) + (c & 0x3f);
-	if (!--ps->count) {
-complete:
-	  if (pwc) { *pwc=ps->sofar; ++pwc; }
-	  if (ps->sofar) {
-	    ps->sofar=0;
-	    return i+1;
-	  } else {
-	    ps->count=0; ps->sofar=0;
-	    return 0;
-	  }
-	}
-      } else {
-	if (c&0x80) {	/* start of multibyte sequence? */
-	  unsigned char x=c<<1;
-	  unsigned char cnt=0;
-	  while (x&0x80) {
-	    x<<=1;
-	    ++cnt;
-	  }
-	  if (!cnt || cnt>5) goto kaputt;
-	  ps->sofar=x>>(cnt+1);
-	  ps->count=cnt;
-	} else {
-	  ps->sofar=c;
-	  goto complete;
-	}
-      }
-    }
-  }
-  return n;
-}
diff -Naur ../../../dietlibc-0.34/lib/mbsinit.c lib/mbsinit.c
--- ../../../dietlibc-0.34/lib/mbsinit.c	2007-09-09 04:37:54.000000000 +0300
+++ lib/mbsinit.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,5 +0,0 @@
-#include <wchar.h>
-
-int mbsinit(const mbstate_t* s) {
-  return (!s || s->sofar);
-}
diff -Naur ../../../dietlibc-0.34/lib/mbsrtowcs.c lib/mbsrtowcs.c
--- ../../../dietlibc-0.34/lib/mbsrtowcs.c	2015-04-11 07:26:28.000000000 +0300
+++ lib/mbsrtowcs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#include <wchar.h>
-
-size_t mbsrtowcs(wchar_t *dest, const char **src, size_t len, mbstate_t *ps) {
-  size_t i;
-  if (!dest) len=(size_t)-1;
-  for (i=0; i<len; ++i) {
-    size_t n=mbrtowc(dest?dest+i:0,*src,len,ps);
-    if (n==(size_t)-1) return -1;
-    if (!n) break;
-    *src+=n;
-  }
-  return i;
-}
diff -Naur ../../../dietlibc-0.34/lib/mbstowcs.c lib/mbstowcs.c
--- ../../../dietlibc-0.34/lib/mbstowcs.c	2007-09-09 05:11:18.000000000 +0300
+++ lib/mbstowcs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <stdlib.h>
-#include <wchar.h>
-
-size_t mbstowcs(wchar_t *dest, const char *src, size_t n) {
-  const char** s=&src;
-  return mbsrtowcs(dest,s,n,NULL);
-}
diff -Naur ../../../dietlibc-0.34/lib/mbtowc.c lib/mbtowc.c
--- ../../../dietlibc-0.34/lib/mbtowc.c	2007-09-09 04:37:54.000000000 +0300
+++ lib/mbtowc.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <stdlib.h>
-#include <wchar.h>
-
-int mbtowc(wchar_t *pwc, const char *s, size_t n) {
-  return mbrtowc(pwc,s,n,NULL);
-}
diff -Naur ../../../dietlibc-0.34/lib/memcmp.c lib/memcmp.c
--- ../../../dietlibc-0.34/lib/memcmp.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/memcmp.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,6 +1,9 @@
 #include <sys/types.h>
 #include <string.h>
-
+#include <swihelper.h>
+
+
+#ifndef __BUILDIN_FUNCTIONS
 /* gcc is broken and has a non-SUSv2 compliant internal prototype.
  * This causes it to warn about a type mismatch here.  Ignore it. */
 int memcmp(const void *dst, const void *src, size_t count) {
@@ -16,5 +19,12 @@
   }
   return 0;
 }
+#else
+int memcmp(const void *dst, const void *src, size_t count)
+{
+    __def_noinline(0x011C, int, dst, src, count)
+}
+
+#endif
 
 int bcmp(const char *a,const char *b,size_t c)	__attribute__((weak,alias("memcmp")));
diff -Naur ../../../dietlibc-0.34/lib/memcpy.c lib/memcpy.c
--- ../../../dietlibc-0.34/lib/memcpy.c	2008-02-23 02:02:19.000000000 +0200
+++ lib/memcpy.c	2023-10-14 22:05:22.495036228 +0300
@@ -2,8 +2,10 @@
 
 #include <string.h>
 #include "dietfeatures.h"
-#include "dietstring.h"
-
+#include "dietstring.h"
+#include <swihelper.h>
+
+#ifndef __BUILDIN_FUNCTIONS
 void *
 memcpy (void *dst, const void *src, size_t n)
 {
@@ -49,3 +51,16 @@
     return (res);
 #endif
 }
+#else
+
+void *
+memcpy (void *dst, const void *src, size_t n)
+{
+    __def_noinline(0x011E, void*, dst, src, n)
+}
+
+#endif
+
+
+
+
diff -Naur ../../../dietlibc-0.34/lib/memmem.c lib/memmem.c
--- ../../../dietlibc-0.34/lib/memmem.c	2001-08-23 19:57:52.000000000 +0300
+++ lib/memmem.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#define _GNU_SOURCE 23
-#include <sys/types.h>
-#include <string.h>
-
-void *memmem(const void* haystack, size_t hl, const void* needle, size_t nl) {
-  int i;
-  if (nl>hl) return 0;
-  for (i=hl-nl+1; i; --i) {
-    if (!memcmp(haystack,needle,nl))
-      return (char*)haystack;
-    ++haystack;
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/memmove.c lib/memmove.c
--- ../../../dietlibc-0.34/lib/memmove.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/memmove.c	2023-10-14 22:05:22.495036228 +0300
@@ -2,7 +2,9 @@
 #define _XOPEN_SOURCE
 #include <sys/types.h>
 #include <string.h>
-
+#include <swihelper.h>
+
+#ifndef __BUILDIN_FUNCTIONS
 void *memmove(void *dst, const void *src, size_t count)
 {
   char *a = dst;
@@ -22,3 +24,11 @@
   }
   return dst;
 }
+#else
+
+void *memmove(void *dst, const void *src, size_t count)
+{
+    __def_noinline(0x0132, void *, dst, src, count)
+}
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/memrchr.c lib/memrchr.c
--- ../../../dietlibc-0.34/lib/memrchr.c	2002-06-05 03:42:40.000000000 +0300
+++ lib/memrchr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,15 +0,0 @@
-#define _GNU_SOURCE
-#include <sys/types.h>
-#include <string.h>
-
-void* memrchr(const void *s, int c, size_t n) {
-  register const char* t=s;
-  register const char* last=0;
-  int i;
-  for (i=n; i; --i) {
-    if (*t==c)
-      last=t;
-    ++t;
-  }
-  return (void*)last; /* man, what an utterly b0rken prototype */
-}
diff -Naur ../../../dietlibc-0.34/lib/memset.c lib/memset.c
--- ../../../dietlibc-0.34/lib/memset.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/memset.c	2023-10-14 22:05:22.495036228 +0300
@@ -5,7 +5,7 @@
  * This causes it to warn about a type mismatch here.  Ignore it. */
 void* memset(void * dst, int s, size_t count) {
     register char * a = dst;
-    count++;	/* this actually creates smaller code than using count-- */
+    ++count;	/* this actually creates smaller code than using count-- */
     while (--count)
 	*a++ = s;
     return dst;
diff -Naur ../../../dietlibc-0.34/lib/mkfifo.c lib/mkfifo.c
--- ../../../dietlibc-0.34/lib/mkfifo.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/mkfifo.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <sys/stat.h>
-#include <unistd.h>
-
-int mkfifo(const char *fn,mode_t mode) {
-  return mknod(fn,(mode_t)(mode|S_IFIFO),0);
-}
diff -Naur ../../../dietlibc-0.34/lib/mmap64.c lib/mmap64.c
--- ../../../dietlibc-0.34/lib/mmap64.c	2004-12-13 12:21:31.000000000 +0200
+++ lib/mmap64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <dietfeatures.h>
-#include <sys/mman.h>
-#include <sys/shm.h>
-#include <syscalls.h>
-#include <errno.h>
-
-#ifdef __NR_mmap2
-void*__mmap2(void*start,size_t length,int prot,int flags,int fd,off_t pgoffset);
-
-void*__libc_mmap64(void*addr,size_t len,int prot,int flags,int fd,off64_t offset);
-void*__libc_mmap64(void*addr,size_t len,int prot,int flags,int fd,off64_t offset) {
-  if (offset&(PAGE_SIZE-1)) {
-    errno=-EINVAL;
-    return MAP_FAILED;
-  }
-  return __mmap2(addr,len,prot,flags,fd,offset>>PAGE_SHIFT);
-}
-
-void*mmap64(void*addr,size_t len,int prot,int flags,int fd,off64_t offset)
-__attribute__((weak,alias("__libc_mmap64")));
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__mmap.c lib/__mmap.c
--- ../../../dietlibc-0.34/lib/__mmap.c	2011-03-03 20:40:05.000000000 +0200
+++ lib/__mmap.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,22 +0,0 @@
-#include <errno.h>
-#include <sys/mman.h>
-#include <syscalls.h>
-
-#ifndef __NR_mmap
-void*__mmap2(void*start,size_t length,int prot,int flags,int fd,off_t
-pgoffset);
-void *mmap(void *addr, size_t length, int prot, int flags, int fd,
-          off_t offset)
-{
-  size_t pgsz = 4096;	/* TODO: fix for dynamic PAGESIZEs needed? */
-  void *res;
-
-  if (__unlikely(offset & (pgsz - 1))) {
-    errno = -EINVAL;
-    res = MAP_FAILED;
-  } else
-    res = __mmap2(addr, length, prot, flags, fd, offset / pgsz);
-  return res;
-}
-#endif
-
diff -Naur ../../../dietlibc-0.34/lib/mq_getattr.c lib/mq_getattr.c
--- ../../../dietlibc-0.34/lib/mq_getattr.c	2005-10-04 20:47:03.000000000 +0300
+++ lib/mq_getattr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <mqueue.h>
-
-int mq_getattr(mqd_t mqdes, struct mq_attr *mqstat) {
-  return mq_setattr(mqdes, NULL, mqstat);
-}
-
diff -Naur ../../../dietlibc-0.34/lib/mq_receive.c lib/mq_receive.c
--- ../../../dietlibc-0.34/lib/mq_receive.c	2005-10-04 20:47:03.000000000 +0300
+++ lib/mq_receive.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <mqueue.h>
-
-ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, size_t msg_len, unsigned int *msg_prio) {
-  return mq_timedreceive(mqdes, msg_ptr, msg_len, msg_prio, NULL);
-}
-
diff -Naur ../../../dietlibc-0.34/lib/mq_send.c lib/mq_send.c
--- ../../../dietlibc-0.34/lib/mq_send.c	2005-10-04 20:47:03.000000000 +0300
+++ lib/mq_send.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <mqueue.h>
-
-int mq_send (mqd_t mqdes, const char *msg_ptr, size_t msg_len, unsigned int msg_prio) {
-  return mq_timedsend(mqdes, msg_ptr, msg_len, msg_prio, NULL);
-}
-
diff -Naur ../../../dietlibc-0.34/lib/msgctl.c lib/msgctl.c
--- ../../../dietlibc-0.34/lib/msgctl.c	2001-06-16 20:48:55.000000000 +0300
+++ lib/msgctl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/msg.h>
-
-extern int __ipc(int,int,int,int,void*);
-
-int msgctl(int msqid, int cmd, struct msqid_ds *buf) {
-  return __ipc(MSGCTL,msqid,cmd,0,buf);
-}
diff -Naur ../../../dietlibc-0.34/lib/msgget.c lib/msgget.c
--- ../../../dietlibc-0.34/lib/msgget.c	2001-06-16 20:48:55.000000000 +0300
+++ lib/msgget.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/msg.h>
-
-extern int __ipc(int,key_t,int,int,int);
-
-int msgget(key_t key,int flag) {
-  return __ipc(MSGGET,key,flag,0,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/msgrcv.c lib/msgrcv.c
--- ../../../dietlibc-0.34/lib/msgrcv.c	2001-06-16 20:48:55.000000000 +0300
+++ lib/msgrcv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/msg.h>
-
-extern int __ipc(int,int,size_t,int,void*);
-
-struct ipc_kludge {
-  struct msgbuf *msgp;
-  long msgtyp;
-};
-
-int msgrcv(int msqid, void *msgp, size_t msgsz, long int msgtyp, int msgflg) {
-  struct ipc_kludge tmp;
-  tmp.msgp = msgp;
-  tmp.msgtyp = msgtyp;
-  return __ipc(MSGRCV,msqid, msgsz, msgflg, &tmp);
-}
diff -Naur ../../../dietlibc-0.34/lib/msgsnd.c lib/msgsnd.c
--- ../../../dietlibc-0.34/lib/msgsnd.c	2001-06-16 20:48:56.000000000 +0300
+++ lib/msgsnd.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/msg.h>
-
-extern int __ipc(int,int,size_t,int,const void*);
-
-int msgsnd (int msqid, const void *msgp, size_t msgsz, int msgflg) {
-  return __ipc(MSGSND,msqid, msgsz, msgflg, msgp);
-}
diff -Naur ../../../dietlibc-0.34/lib/mtx_destroy.c lib/mtx_destroy.c
--- ../../../dietlibc-0.34/lib/mtx_destroy.c	2014-03-24 10:22:54.000000000 +0200
+++ lib/mtx_destroy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <threads.h>
-
-void mtx_destroy(mtx_t* mutex) {
-  // no need to do anything
-  (void)mutex;
-}
diff -Naur ../../../dietlibc-0.34/lib/mtx_init.c lib/mtx_init.c
--- ../../../dietlibc-0.34/lib/mtx_init.c	2014-03-19 11:00:12.000000000 +0200
+++ lib/mtx_init.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <threads.h>
-
-int mtx_init(mtx_t* mutex, int type) {
-  mutex->lock=0;
-  mutex->type=type;
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/mtx_lock.c lib/mtx_lock.c
--- ../../../dietlibc-0.34/lib/mtx_lock.c	2014-03-24 10:25:17.000000000 +0200
+++ lib/mtx_lock.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#define _REENTRANT
-#include <threads.h>
-#include <sys/futex.h>
-#include <errno.h>
-
-int mtx_lock(mtx_t* mutex) {
-  return mtx_timedlock(mutex,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/mtx_timedlock.c lib/mtx_timedlock.c
--- ../../../dietlibc-0.34/lib/mtx_timedlock.c	2015-04-11 07:25:42.000000000 +0300
+++ lib/mtx_timedlock.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,23 +0,0 @@
-#define _REENTRANT
-#define _DIETLIBC_SOURCE
-#include <threads.h>
-#include <sys/futex.h>
-#include <errno.h>
-
-int mtx_timedlock(mtx_t* mutex, const struct timespec* time_point) {
-  int i,r;
-  do {
-    r=__mtx_trylock(mutex,&i);
-    if (r!=thrd_busy) return r;
-    for (;;) {
-      r=futex(&mutex->lock,FUTEX_WAIT,i,time_point,0,0);
-      if (r==-1) {
-	if (errno==EWOULDBLOCK) { r=0; break; } else
-	if (errno==ETIMEDOUT) return thrd_timedout; else
-	if (errno==EINTR) continue;
-      } else
-	break;
-    }
-  } while (r==0);
-  return thrd_error;
-}
diff -Naur ../../../dietlibc-0.34/lib/mtx_trylock.c lib/mtx_trylock.c
--- ../../../dietlibc-0.34/lib/mtx_trylock.c	2014-03-24 10:25:17.000000000 +0200
+++ lib/mtx_trylock.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,28 +0,0 @@
-#define _REENTRANT
-#define _DIETLIBC_SOURCE
-#include <threads.h>
-#include <sys/futex.h>
-#include <errno.h>
-
-int __mtx_trylock(mtx_t* mutex,int* lockval) {
-  int i;
-  thrd_t me=thrd_current();
-  /* attempt to lock the mutex with an atomic instruction */
-  if ((i=__sync_val_compare_and_swap(&mutex->lock,0,1))==0) {
-    mutex->owner=me;
-    return thrd_success;
-  }
-  if ((mutex->type&mtx_recursive) && mutex->owner==me) {
-    if (__sync_add_and_fetch(&mutex->lock,1)>1000) {
-      __sync_add_and_fetch(&mutex->lock,-1);
-      return thrd_error;
-    }
-    return thrd_success;
-  }
-  if (lockval) *lockval=i;
-  return thrd_busy;
-}
-
-int mtx_trylock(mtx_t* mutex) {
-  return __mtx_trylock(mutex,NULL);
-}
diff -Naur ../../../dietlibc-0.34/lib/mtx_unlock.c lib/mtx_unlock.c
--- ../../../dietlibc-0.34/lib/mtx_unlock.c	2014-03-24 10:25:17.000000000 +0200
+++ lib/mtx_unlock.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,22 +0,0 @@
-#define _REENTRANT
-#include <threads.h>
-#include <sys/futex.h>
-#include <errno.h>
-
-int mtx_unlock(mtx_t* mutex) {
-  int i,r;
-  thrd_t me=thrd_current();
-  if (mutex->lock==0) return thrd_error;
-  if ((mutex->type&mtx_recursive) && mutex->owner==me) {
-    if (__sync_add_and_fetch(&mutex->lock,-1)==0) {
-      // If we get here, the mutex was recursive, we unlocked it, and we
-      // were the last guy holding the lock.  Wake waiters.
-      mutex->owner=0;	// cosmetic; not really needed
-      futex(&mutex->lock,FUTEX_WAKE,1,0,0,0);
-    }
-    return thrd_success;
-  }
-  if (__sync_val_compare_and_swap(&mutex->lock,1,0)==1)
-    futex(&mutex->lock,FUTEX_WAKE,1,0,0,0);
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/nice.c lib/nice.c
--- ../../../dietlibc-0.34/lib/nice.c	2014-10-10 21:23:27.000000000 +0300
+++ lib/nice.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#ifndef _REENTRANT
-#define _REENTRANT
-#endif
-#include <errno.h>
-#include <unistd.h>
-#include <sys/resource.h>
-
-int nice(int incr) {
-  int prio;
-  int res;
-  errno=0;
-  prio = getpriority(PRIO_PROCESS,0) + incr;
-  if (prio < PRIO_MIN) prio=PRIO_MIN;
-  if (prio >= PRIO_MAX) prio=PRIO_MAX-1;
-  if (setpriority (PRIO_PROCESS, 0, prio)==-1) {
-    if (errno==EACCES) errno=EPERM;
-    return -1;
-  } else
-    return getpriority(PRIO_PROCESS, 0);
-}
diff -Naur ../../../dietlibc-0.34/lib/open64.c lib/open64.c
--- ../../../dietlibc-0.34/lib/open64.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/open64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#include <sys/types.h>
-#include <fcntl.h>
-
-#ifndef O_LARGEFILE
-#define O_LARGEFILE 0
-#endif
-
-int __libc_open64(const char* file,int oflag,int mode);
-int __libc_open64(const char* file,int oflag,int mode) {
-  return open(file,oflag|O_LARGEFILE,mode);
-}
-
-int open64(const char* file,int oflag,...) __attribute__((weak,alias("__libc_open64")));
diff -Naur ../../../dietlibc-0.34/lib/opendir.c lib/opendir.c
--- ../../../dietlibc-0.34/lib/opendir.c	2002-07-03 23:33:38.000000000 +0300
+++ lib/opendir.c	2023-10-16 02:47:05.055002917 +0300
@@ -1,26 +1,21 @@
-#include "dietdirent.h"
+#include "../dietdirent.h"
 #include <sys/mman.h>
 #include <unistd.h>
 #include <dirent.h>
 #include <stdlib.h>
-#include <fcntl.h>
+#include <fcntl.h>
 
-DIR*  opendir ( const char* name ) {
-  int   fd = open (name, O_RDONLY | O_DIRECTORY);
-  DIR*  t  = NULL;
 
-  if ( fd >= 0 ) {
-    if (fcntl (fd, F_SETFD, FD_CLOEXEC) < 0)
-      goto lose;
-    t = (DIR *) mmap (NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, 
-		MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
-    if (t == MAP_FAILED)
-lose:
-      close (fd);
-    else
-      t->fd = fd;
-  }
+DIR*  opendir ( const char* name ) {
+
+    DIR *dir = malloc(sizeof(DIR));
+    unsigned int err;
+
+    if( !FindFirstFile(&dir->dir, name, &err) )
+    {
+        free(dir);
+        dir = 0;
+    }
 
-
-  return t;
+    return dir;
 }
diff -Naur ../../../dietlibc-0.34/lib/posix_fallocate.c lib/posix_fallocate.c
--- ../../../dietlibc-0.34/lib/posix_fallocate.c	2011-03-03 20:40:05.000000000 +0200
+++ lib/posix_fallocate.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#define _GNU_SOURCE
-#define _XOPEN_SOURCE 600
-
-#include <fcntl.h>
-int posix_fallocate(int fd, off64_t offset, off64_t len) {
-  return fallocate(fd,0,offset,len);
-}
diff -Naur ../../../dietlibc-0.34/lib/pread.c lib/pread.c
--- ../../../dietlibc-0.34/lib/pread.c	2004-05-11 00:05:07.000000000 +0300
+++ lib/pread.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <endian.h>
-#include <sys/types.h>
-#include <unistd.h>
-
-ssize_t __libc_pread(int fd, void *buf, size_t count, off_t offset);
-ssize_t __libc_pread(int fd, void *buf, size_t count, off_t offset) {
-  return pread64(fd,buf,count,offset);
-}
-
-ssize_t pread(int fd, void *buf, size_t count, off_t offset) __attribute__((weak,alias("__libc_pread")));
diff -Naur ../../../dietlibc-0.34/lib/pselect.c lib/pselect.c
--- ../../../dietlibc-0.34/lib/pselect.c	2004-05-17 20:44:56.000000000 +0300
+++ lib/pselect.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include <sys/select.h>
-
-int pselect(int n, fd_set* readfds, fd_set* writefds, fd_set* exceptfds,
-            const struct timespec *timeout, const sigset_t *sigmask) {
-  struct timeval t;
-  sigset_t old;
-  int r;
-  if (timeout) {
-    t.tv_sec=timeout->tv_sec;
-    t.tv_usec=timeout->tv_nsec/1000;
-    if (!t.tv_sec && !t.tv_usec && timeout->tv_nsec) ++t.tv_usec;
-  }
-  if (sigmask)
-    sigprocmask(SIG_SETMASK,sigmask,&old);
-  r=select(n,readfds,writefds,exceptfds,
-	   timeout?&t:0);
-  if (sigmask)
-    sigprocmask(SIG_SETMASK,&old,0);
-  return r;
-}
diff -Naur ../../../dietlibc-0.34/lib/__ptrace.c lib/__ptrace.c
--- ../../../dietlibc-0.34/lib/__ptrace.c	2004-03-02 23:24:33.000000000 +0200
+++ lib/__ptrace.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,29 +0,0 @@
-/* we need this because we need to use the glibc prototype which uses
- * varargs :-( */
-#include <errno.h>
-#define ptrace fnord
-#include <sys/ptrace.h>
-#undef ptrace
-#include <sys/types.h>
-#include <unistd.h>
-
-extern int __diet_ptrace(int request, pid_t pid, void *addr, void *data);
-int ptrace(int request, pid_t pid, void *addr, void *data);
-
-int ptrace(int request, pid_t pid, void *addr, void *data) {
-  errno=0;
-  switch (request) {
-    case PTRACE_TRACEME: case PTRACE_KILL: case PTRACE_ATTACH:
-    case PTRACE_DETACH:
-      return (__diet_ptrace (request, pid, NULL, NULL));
-    case PTRACE_PEEKDATA: case PTRACE_PEEKUSER: case PTRACE_PEEKTEXT:
-      {
-	long result;
-	if (__diet_ptrace (request, pid, addr, &result) == -1)
-		return (-1);
-	return (result);
-      }
-    default:
-      return (__diet_ptrace (request, pid, addr, data));
-  }
-}
diff -Naur ../../../dietlibc-0.34/lib/putenv.c lib/putenv.c
--- ../../../dietlibc-0.34/lib/putenv.c	2007-01-21 00:47:43.000000000 +0200
+++ lib/putenv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,45 +0,0 @@
-#include <stdlib.h>
-#include <string.h>
-#include <errno.h>
-
-int putenv(const char *string) {
-  size_t len;
-  int envc;
-  int remove=0;
-  char *tmp;
-  const char **ep;
-  char **newenv;
-  static char **origenv;
-  if (!origenv) origenv=environ;
-  if (!(tmp=strchr(string,'='))) {
-    len=strlen(string);
-    remove=1;
-  } else
-    len=tmp-string;
-  for (envc=0, ep=(const char**)environ; (ep && *ep); ++ep) {
-    if (*string == **ep &&
-	!memcmp(string,*ep,len) &&
-	(*ep)[len]=='=') {
-      if (remove) {
-	for (; ep[1]; ++ep) ep[0]=ep[1];
-	ep[0]=0;
-	return 0;
-      }
-      *ep=string;
-      return 0;
-    }
-    ++envc;
-  }
-  if (tmp) {
-    newenv = (char**) realloc(environ==origenv?0:environ,
-			      (envc+2)*sizeof(char*));
-    if (!newenv) return -1;
-    if (envc && (environ==origenv)) {
-      memcpy(newenv,origenv,envc*sizeof(char*));
-    }
-    newenv[envc]=(char*)string;
-    newenv[envc+1]=0;
-    environ=newenv;
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/pwrite.c lib/pwrite.c
--- ../../../dietlibc-0.34/lib/pwrite.c	2004-05-11 00:05:07.000000000 +0300
+++ lib/pwrite.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <endian.h>
-#include <sys/types.h>
-#include <unistd.h>
-
-size_t __libc_pwrite(int fd, void *buf, size_t count, off_t offset);
-size_t __libc_pwrite(int fd, void *buf, size_t count, off_t offset) {
-  return pwrite64(fd,buf,count,offset);
-}
-
-ssize_t pwrite(int fd, const void *buf, size_t count, off_t offset) __attribute__((weak,alias("__libc_pwrite")));
diff -Naur ../../../dietlibc-0.34/lib/qsort.c lib/qsort.c
--- ../../../dietlibc-0.34/lib/qsort.c	2012-08-27 21:08:10.000000000 +0300
+++ lib/qsort.c	2023-10-14 22:05:22.495036228 +0300
@@ -12,8 +12,6 @@
   }
 }
 
-#define RAND
-
 /* Quicksort with 3-way partitioning, ala Sedgewick */
 /* Blame him for the scary variable names */
 /* http://www.cs.princeton.edu/~rs/talks/QuicksortIsOptimal.pdf */
@@ -22,25 +20,6 @@
   ssize_t i=l-1, j=r, p=l-1, q=r, k;
   char* v=base+r*size;
   if (r<=l) return;
-
-#ifdef RAND
-  /*
-     We chose the rightmost element in the array to be sorted as pivot,
-     which is OK if the data is random, but which is horrible if the
-     data is already sorted.  Try to improve by exchanging it with a
-     random other pivot.
-   */
-  exch(base,size,l+(rand()%(r-l)),r);
-#elif defined MID
-  /*
-     We chose the rightmost element in the array to be sorted as pivot,
-     which is OK if the data is random, but which is horrible if the
-     data is already sorted.  Try to improve by chosing the middle
-     element instead.
-   */
-  exch(base,size,l+(r-l)/2,r);
-#endif
-
   for (;;) {
     while (++i != r && compar(base+i*size,v)<0) ;
     while (compar(v,base+(--j)*size)<0) if (j == l) break;
diff -Naur ../../../dietlibc-0.34/lib/raise.c lib/raise.c
--- ../../../dietlibc-0.34/lib/raise.c	2001-06-16 20:48:56.000000000 +0300
+++ lib/raise.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <sys/types.h>
-#include <unistd.h>
-#include <signal.h>
-
-int raise(int sig) {
-  return kill(getpid(),sig);
-}
diff -Naur ../../../dietlibc-0.34/lib/rand.c lib/rand.c
--- ../../../dietlibc-0.34/lib/rand.c	2012-03-22 00:58:39.000000000 +0200
+++ lib/rand.c	2023-10-14 22:05:22.495036228 +0300
@@ -6,7 +6,7 @@
   return rand_r(&seed);
 }
 
-void srand(unsigned int i) { seed=i?i:23; }
+void srand(unsigned int i) { seed=i; }
 
 int random(void) __attribute__((alias("rand")));
 void srandom(unsigned int i) __attribute__((alias("srand")));
diff -Naur ../../../dietlibc-0.34/lib/readdir64.c lib/readdir64.c
--- ../../../dietlibc-0.34/lib/readdir64.c	2004-03-02 23:27:19.000000000 +0200
+++ lib/readdir64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,62 +0,0 @@
-#include "dietfeatures.h"
-#include "dietdirent.h"
-#include <unistd.h>
-#include <dirent.h>
-#include <stdlib.h>
-#include <errno.h>
-#include <string.h>
-#include "syscalls.h"
-
-#ifndef __NR_getdents64
-#define WANT_LARGEFILE_BACKCOMPAT
-#endif
-
-#ifndef WANT_LARGEFILE_BACKCOMPAT
-struct dirent64* readdir64(DIR *d) {
-  if (!d->num || (d->cur += ((struct dirent64*)(d->buf+d->cur))->d_reclen)>=d->num) {
-    int res=getdents64(d->fd,(struct dirent64*)d->buf, sizeof (d->buf)-1);
-    if (res<=0) return 0;
-    d->num=res; d->cur=0;
-  }
-  return (struct dirent64*)(d->buf+d->cur);
-}
-#else
-struct dirent64* readdir64(DIR *d) {
-#ifdef __NR_getdents64
-  static int trygetdents64=1;
-#endif
-  struct dirent* o;
-  static struct dirent64 d64;
-#ifdef __NR_getdents64
-again:
-  if (!trygetdents64) {
-#endif
-    if (!d->num || (d->cur += ((struct dirent*)(d->buf+d->cur))->d_reclen)>=d->num) {
-      int res=getdents(d->fd,(struct dirent*)d->buf, sizeof (d->buf)-1);
-      if (res<=0) return 0;
-      d->num=res; d->cur=0;
-    }
-    o=(struct dirent*)(d->buf+d->cur);
-    d64.d_ino=o->d_ino;
-    d64.d_off=o->d_off;
-    d64.d_reclen=o->d_reclen;
-    strcpy(d64.d_name,o->d_name);
-    d64.d_type=0;	/* is this correct? */
-    return &d64;
-#ifdef __NR_getdents64
-  }
-  if (!d->num || (d->cur += ((struct dirent64*)(d->buf+d->cur))->d_reclen)>=d->num) {
-    int res=getdents64(d->fd,(struct dirent64*)d->buf,sizeof (d->buf));
-    if (res<=0) {
-      if (errno==ENOSYS) {
-	trygetdents64=0;
-	goto again;
-      }
-      return 0;
-    }
-    d->num=res; d->cur=0;
-  }
-  return (struct dirent64*)(d->buf+d->cur);
-#endif
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/readdir.c lib/readdir.c
--- ../../../dietlibc-0.34/lib/readdir.c	2014-02-21 12:03:29.000000000 +0200
+++ lib/readdir.c	2023-10-16 03:10:43.257881056 +0300
@@ -1,13 +1,18 @@
-#define _POSIX_SOURCE
 #include "dietdirent.h"
 #include <unistd.h>
 #include <dirent.h>
-#include <stdlib.h>
+#include <stdlib.h>
 
-static struct dirent tmp;
-
-struct dirent* readdir(DIR *d) {
-  struct dirent* ld;
-  if (readdir_r(d,&tmp,&ld)) return 0;
-  return ld;
+struct dirent* readdir(DIR *d) {
+	if (!d->dir.file_name[0])
+		return 0;
+	
+	struct dirent *de = &d->de;
+	de->d_ino = -1;
+	de->d_off = -1;
+	strcpy(de->d_name, (char*)d->dir.file_name);
+	
+	if (!FindNextFile(&d->dir, 0))
+		d->dir.file_name[0] = 0;
+	return de;
 }
diff -Naur ../../../dietlibc-0.34/lib/readdir_r.c lib/readdir_r.c
--- ../../../dietlibc-0.34/lib/readdir_r.c	2016-06-06 15:01:59.000000000 +0300
+++ lib/readdir_r.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,47 +0,0 @@
-#define _POSIX_SOURCE
-#include "dietdirent.h"
-#include <unistd.h>
-#include <dirent.h>
-#include <stdlib.h>
-#include <errno.h>
-
-#ifdef __DIET_ARCH_ONLY_DIRENT64
-#define linux_dirent dirent64
-#define getdents     getdents64
-#define gddirent     dirent64
-#else
-#define gddirent     dirent
-struct linux_dirent {
-  uint32_t	d_ino;
-  off_t		d_off;
-  uint16_t	d_reclen;
-  char		d_name[1];
-};
-#endif
-
-int readdir_r(DIR *d,struct dirent* entry, struct dirent** result) {
-  struct linux_dirent* ld;
-  *result=0;
-  ld=(struct linux_dirent*)(d->buf+d->cur);
-  if (!d->num || d->cur >= d->num || (d->cur += ld->d_reclen)>=d->num) {
-    int res=getdents(d->fd,(struct gddirent*)d->buf,sizeof (d->buf)-1);
-    if (res<=0)
-      return res<0;
-    d->num=res; d->cur=0;
-  }
-  ld=(struct linux_dirent*)(d->buf+d->cur);
-  /* struct dirent64 has d_name[256] instead of d_name[1] at the end */
-  if (ld->d_reclen < offsetof(struct linux_dirent,d_name)+1)
-    return 0;	/* can't happen */
-  *result=entry;
-  entry->d_ino=ld->d_ino;
-  entry->d_off=ld->d_off;
-  entry->d_reclen=ld->d_reclen;
-#ifdef __DIET_ARCH_ONLY_DIRENT64
-  entry->d_type=ld->d_type;
-#else
-  entry->d_type=ld->d_name[ld->d_reclen-offsetof(struct linux_dirent,d_name)-1];
-#endif
-  memcpy(entry->d_name,ld->d_name,ld->d_reclen-offsetof(struct linux_dirent,d_name));
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/reallocarray.c lib/reallocarray.c
--- ../../../dietlibc-0.34/lib/reallocarray.c	2014-10-01 11:53:52.000000000 +0300
+++ lib/reallocarray.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <stdlib.h>
-#include <endian.h>
-
-#if __WORDSIZE == 64
-typedef __uint128_t ulll;
-#else
-typedef uint64_t ulll;
-#endif
-
-void* reallocarray(void* ptr, size_t nmemb, size_t size) {
-  /* produce a compile-time error if uintmax_t is not larger than size_t */
-  typedef char compile_time_assertion[(sizeof(ulll)>=sizeof(size_t)*2)-1];
-
-  ulll l=(ulll)nmemb * size;
-  if ((size_t)l != l) return 0;	// overflow
-  return realloc(ptr,(size_t)l);
-}
diff -Naur ../../../dietlibc-0.34/lib/reboot.c lib/reboot.c
--- ../../../dietlibc-0.34/lib/reboot.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/reboot.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <sys/reboot.h>
-
-int __reboot(unsigned int magic1, unsigned int magic2, int cmd);
-
-int reboot(int cmd)
-{
-  return __reboot(LINUX_REBOOT_MAGIC1, LINUX_REBOOT_MAGIC2, cmd);
-}
diff -Naur ../../../dietlibc-0.34/lib/recv.c lib/recv.c
--- ../../../dietlibc-0.34/lib/recv.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/recv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <sys/types.h>
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_recv(int a, const void * b, size_t c, int flags);
-int __libc_recv(int a, const void * b, size_t c, int flags) {
-  long args[] = { a, (long) b, c, flags };
-  return socketcall(SYS_RECV, args);
-}
-
-int recv(int a, const void * b, size_t c, int flags)
-  __attribute__ ((weak, alias("__libc_recv")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/recvfrom.c lib/recvfrom.c
--- ../../../dietlibc-0.34/lib/recvfrom.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/recvfrom.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <sys/types.h>
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_recvfrom(int a, const void * b, size_t c, int flags, void *to, void *tolen);
-int __libc_recvfrom(int a, const void * b, size_t c, int flags, void *to, void *tolen) {
-  long args[] = { a, (long) b, c, flags, (long) to, (long) tolen };
-  return socketcall(SYS_RECVFROM, args);
-}
-
-int recvfrom(int a, const void * b, size_t c, int flags, void *to, void *tolen)
- __attribute__ ((weak,alias("__libc_recvfrom"))) ;
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/recvmsg.c lib/recvmsg.c
--- ../../../dietlibc-0.34/lib/recvmsg.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/recvmsg.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <sys/socket.h>
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_recvmsg(int a, struct msghdr* msg, int flags);
-int __libc_recvmsg(int a, struct msghdr* msg, int flags) {
-  long args[] = { a, (long) msg, flags };
-  return socketcall(SYS_RECVMSG, args);
-}
-
-int recvmsg(int a, struct msghdr *msg, int flags)
- __attribute__ ((weak,alias("__libc_recvmsg"))) ;
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/rewinddir.c lib/rewinddir.c
--- ../../../dietlibc-0.34/lib/rewinddir.c	2001-02-03 22:41:12.000000000 +0200
+++ lib/rewinddir.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include "dietdirent.h"
-#include <unistd.h>
-#include <dirent.h>
-
-void rewinddir(DIR *d) {
-  if (lseek(d->fd,0,SEEK_SET) != (off_t)-1)
-    d->num=d->cur=0;
-}
diff -Naur ../../../dietlibc-0.34/lib/sbrk.c lib/sbrk.c
--- ../../../dietlibc-0.34/lib/sbrk.c	2002-01-12 04:38:32.000000000 +0200
+++ lib/sbrk.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <unistd.h>
-
-extern int __libc_brk(void *end_data_segment);
-
-extern void* __curbrk;
-
-void* __libc_sbrk(ptrdiff_t increment);
-void* __libc_sbrk(ptrdiff_t increment) {
-  void* oldbrk;
-  if (__curbrk==0)
-    if (__libc_brk(0) < 0)
-      return (void*)-1;
-  if (increment==0)
-    return __curbrk;
-  oldbrk=__curbrk;
-  if (__libc_brk((char*)oldbrk+increment)<0)
-    return (void*)-1;
-  return oldbrk;
-}
-
-void* sbrk (ptrdiff_t increment) __attribute__((weak,alias("__libc_sbrk")));
diff -Naur ../../../dietlibc-0.34/lib/__sched_getaffinity.c lib/__sched_getaffinity.c
--- ../../../dietlibc-0.34/lib/__sched_getaffinity.c	2011-03-03 20:40:05.000000000 +0200
+++ lib/__sched_getaffinity.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,15 +0,0 @@
-#define _GNU_SOURCE
-#include <sched.h>
-
-extern int __syscall_sched_getaffinity(pid_t, size_t, cpu_set_t*);
-
-int sched_getaffinity(pid_t pid, size_t size, cpu_set_t *mask)
-{
-	int ret;
-
-	*mask = 0;
-	ret = __syscall_sched_getaffinity(pid, size, mask);
-	if (ret > 0)
-		return 0;
-	return ret;
-}
diff -Naur ../../../dietlibc-0.34/lib/secure_getenv.c lib/secure_getenv.c
--- ../../../dietlibc-0.34/lib/secure_getenv.c	2017-09-01 02:26:33.000000000 +0300
+++ lib/secure_getenv.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#define _GNU_SOURCE
-#include <stdlib.h>
-#include <sys/auxv.h>
-
-char* secure_getenv(const char* name) {
-  if (getauxval(AT_SECURE))
-    return NULL;
-  return getenv(name);
-}
diff -Naur ../../../dietlibc-0.34/lib/seekdir.c lib/seekdir.c
--- ../../../dietlibc-0.34/lib/seekdir.c	2006-04-04 06:47:21.000000000 +0300
+++ lib/seekdir.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include "dietdirent.h"
-#include <unistd.h>
-#include <dirent.h>
-
-void seekdir(DIR *d,off_t offset) {
-  if (lseek(d->fd,offset,SEEK_SET) != (off_t)-1) {
-    d->num=d->cur=0;
-    ((struct dirent *)(d->buf))->d_off = offset;
-  }
-}
diff -Naur ../../../dietlibc-0.34/lib/semctl.c lib/semctl.c
--- ../../../dietlibc-0.34/lib/semctl.c	2002-02-24 00:18:42.000000000 +0200
+++ lib/semctl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-
-extern int __ipc(int,int,int,int,void*);
-
-union semun {
-  int val;			/* value for SETVAL */
-  struct semid_ds *buf;		/* buffer for IPC_STAT & IPC_SET */
-  unsigned short *array;		/* array for GETALL & SETALL */
-  struct seminfo *__buf;		/* buffer for IPC_INFO */
-  void *__pad;
-};
-
-int semctl(int semid, int semnum, int cmd, union semun arg);
-int semctl(int semid, int semnum, int cmd, union semun arg) {
-  return __ipc(SEMCTL,semid,semnum,cmd,&arg);
-}
diff -Naur ../../../dietlibc-0.34/lib/semget.c lib/semget.c
--- ../../../dietlibc-0.34/lib/semget.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/semget.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/sem.h>
-
-extern int __ipc(int,key_t,int,int,int);
-
-int semget(key_t key, int nsems, int semflg) {
-  return __ipc(SEMGET,key,nsems,semflg,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/semop.c lib/semop.c
--- ../../../dietlibc-0.34/lib/semop.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/semop.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/sem.h>
-
-extern int __ipc(int,int,unsigned,int,void*);
-
-int semop(int semid,struct sembuf *sops,unsigned nsops) {
-  return __ipc(SEMOP,semid,nsops,0,sops);
-}
diff -Naur ../../../dietlibc-0.34/lib/send.c lib/send.c
--- ../../../dietlibc-0.34/lib/send.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/send.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <sys/types.h>
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_send(int a, const void * b, size_t c, int flags);
-int __libc_send(int a, const void * b, size_t c, int flags) {
-  long args[] = { a, (long) b, c, flags };
-  return socketcall(SYS_SEND, args);
-}
-
-int send(int a, const void * b, size_t c, int flags)
-  __attribute__ ((weak, alias("__libc_send")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__sendfile64.c lib/__sendfile64.c
--- ../../../dietlibc-0.34/lib/__sendfile64.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/__sendfile64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,28 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/sendfile.h>
-#ifndef __NO_STAT64
-
-extern ssize_t __dietlibc_sendfile64 (int out_fd, int in_fd, loff_t* offset,
-			   size_t count);
-
-ssize_t sendfile64 (int out_fd, int in_fd, loff_t* offset, size_t count) {
-  static int havesendfile64=1;
-  ssize_t r = -1;
-  if (havesendfile64) {
-    r=__dietlibc_sendfile64(out_fd,in_fd,offset,count);
-    if (r==-1 && errno==ENOSYS)
-      havesendfile64=0;
-  }
-  if (!havesendfile64) {
-    off_t o=*offset;
-    if (*offset>0x7fffffff) { errno=EINVAL; return -1; }
-    r=sendfile(out_fd,in_fd,&o,count);
-    *offset=o;
-    return r;
-  }
-  return r;
-}
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/sendmsg.c lib/sendmsg.c
--- ../../../dietlibc-0.34/lib/sendmsg.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/sendmsg.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <sys/socket.h>
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_sendmsg(int a, const struct msghdr* msg, int flags);
-int __libc_sendmsg(int a, const struct msghdr* msg, int flags) {
-  long args[] = { a, (long) msg, flags };
-  return socketcall(SYS_SENDMSG, args);
-}
-
-int sendmsg(int a, const struct msghdr *msg, int flags)
- __attribute__ ((weak,alias("__libc_sendmsg"))) ;
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/sendto.c lib/sendto.c
--- ../../../dietlibc-0.34/lib/sendto.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/sendto.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,18 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <sys/socket.h>
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_sendto(int a, const void * b, size_t c, int flags, void *to, int tolen);
-int __libc_sendto(int a, const void * b, size_t c, int flags, void *to, int tolen) {
-  long args[] = { a, (long) b, c, flags, (long) to, tolen };
-  return socketcall(SYS_SENDTO, args);
-}
-
-int sendto(int a, const void * b, size_t c, int flags, const struct sockaddr* to, socklen_t tolen)
-  __attribute__ ((weak, alias("__libc_sendto")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/setlinebuf.c lib/setlinebuf.c
--- ../../../dietlibc-0.34/lib/setlinebuf.c	2002-02-24 00:18:42.000000000 +0200
+++ lib/setlinebuf.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <stdio.h>
-#include "dietwarning.h"
-#undef setlinebuf
-
-/* there is no previous prototype because it is a #define */
-void setlinebuf(FILE* stream);
-
-void setlinebuf(FILE* stream) {
-  setvbuf(stream,0,_IOLBF,BUFSIZ);
-}
-
-link_warning("setlinebuf","warning: you used setlinebuf without including <stdio.h>")
diff -Naur ../../../dietlibc-0.34/lib/setpgrp.c lib/setpgrp.c
--- ../../../dietlibc-0.34/lib/setpgrp.c	2001-02-27 16:51:55.000000000 +0200
+++ lib/setpgrp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <unistd.h>
-
-int setpgrp()
-{
-  return setpgid(0,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/setsockopt.c lib/setsockopt.c
--- ../../../dietlibc-0.34/lib/setsockopt.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/setsockopt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-#include <sys/socket.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_setsockopt(int a, int b, int c, void *d, void *e);
-int __libc_setsockopt(int a, int b, int c, void *d, void *e) {
-  long args[] = { a, b, c, (long)d, (long) e };
-  return socketcall(SYS_SETSOCKOPT, args);
-}
-
-int setsockopt(int s, int level, int optname, const void* optval, socklen_t optlen) __attribute__((weak,alias("__libc_setsockopt")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/shmat.c lib/shmat.c
--- ../../../dietlibc-0.34/lib/shmat.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/shmat.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/shm.h>
-
-extern void* __ipc(int,int,int,void*,const void*);
-
-void* shmat(int shmid,const void* shmaddr,int shmflg) {
-  void* raddr;
-  register void* result;
-  result=__ipc(SHMAT,shmid,shmflg,&raddr,shmaddr);
-  if ((unsigned long)result <= -(unsigned long)8196)
-    result=raddr;
-  return result;
-}
diff -Naur ../../../dietlibc-0.34/lib/shmctl.c lib/shmctl.c
--- ../../../dietlibc-0.34/lib/shmctl.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/shmctl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/shm.h>
-
-extern int __ipc(int,int,int,int,void*);
-
-int shmctl(int shmid, int cmd, struct shmid_ds *buf) {
-  return __ipc(SHMCTL,shmid,cmd,0,buf);
-}
diff -Naur ../../../dietlibc-0.34/lib/shmdt.c lib/shmdt.c
--- ../../../dietlibc-0.34/lib/shmdt.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/shmdt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/shm.h>
-
-extern int __ipc(int,int,int,int,const void*);
-
-int shmdt(const void* shmaddr) {
-  return __ipc(SHMDT,0,0,0,shmaddr);
-}
diff -Naur ../../../dietlibc-0.34/lib/shmget.c lib/shmget.c
--- ../../../dietlibc-0.34/lib/shmget.c	2001-06-15 19:14:50.000000000 +0300
+++ lib/shmget.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/types.h>
-#include <sys/ipc.h>
-#include <sys/shm.h>
-
-extern int __ipc(int,key_t,int,int,int);
-
-int shmget(key_t key, int size, int shmflg) {
-  return __ipc(SHMGET,key,size,shmflg,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/shutdown.c lib/shutdown.c
--- ../../../dietlibc-0.34/lib/shutdown.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/shutdown.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-#include <sys/socket.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_shutdown(int s, int how);
-int __libc_shutdown(int s, int how) {
-  long args[] = { s, (long) how, 0 };
-  return socketcall(SYS_SHUTDOWN, args);
-}
-
-int shutdown(int s, int how) __attribute__((weak,alias("__libc_shutdown")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/sigaction.c lib/sigaction.c
--- ../../../dietlibc-0.34/lib/sigaction.c	2002-08-19 20:08:56.000000000 +0300
+++ lib/sigaction.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include <signal.h>
-
-int __rt_sigaction(int signum, const struct sigaction *act, struct sigaction *oldact, long nr);
-
-int __libc_sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);
-int __libc_sigaction(int signum, const struct sigaction *act, struct sigaction *oldact) {
-  return __rt_sigaction(signum, act, oldact, _NSIG/8);
-}
-
-int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact)
-__attribute__((weak,alias("__libc_sigaction")));
diff -Naur ../../../dietlibc-0.34/lib/sigaddset.c lib/sigaddset.c
--- ../../../dietlibc-0.34/lib/sigaddset.c	2002-05-14 10:35:38.000000000 +0300
+++ lib/sigaddset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <signal.h>
-#include <errno.h>
-
-#define __sigmask(sig)		( ((unsigned long)1) << (((sig)-1) % (8*sizeof(unsigned long))) )
-#define __sigword(sig)		( ((sig)-1) / (8*sizeof(unsigned long)) )
-
-int sigaddset(sigset_t *set, int signo) {
-  if ((signo<1)||(signo>SIGRTMAX)) {
-    (*__errno_location())=EINVAL;
-    return -1;
-  } else {
-    unsigned long __mask = __sigmask (signo);
-    unsigned long __word = __sigword (signo);
-    set->sig[__word]|=__mask;
-    return 0;
-  }
-}
diff -Naur ../../../dietlibc-0.34/lib/sigandset.c lib/sigandset.c
--- ../../../dietlibc-0.34/lib/sigandset.c	2014-10-10 17:54:30.000000000 +0300
+++ lib/sigandset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#define _GNU_SOURCE
-#include <signal.h>
-
-int sigandset(sigset_t*set,const sigset_t*left,const sigset_t*right)
-{
-  set->sig[0]=left->sig[0]&right->sig[0];
-  if (_SIGSET_WORDS>1) set->sig[1]=left->sig[1]&right->sig[1];
-  if (_SIGSET_WORDS>2) {
-    set->sig[2]=left->sig[2]&right->sig[2];
-    set->sig[3]=left->sig[3]&right->sig[3];
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/sigdelset.c lib/sigdelset.c
--- ../../../dietlibc-0.34/lib/sigdelset.c	2002-05-14 10:35:38.000000000 +0300
+++ lib/sigdelset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <signal.h>
-#include <errno.h>
-
-#define __sigmask(sig)		( ((unsigned long)1) << (((sig)-1) % (8*sizeof(unsigned long))) )
-#define __sigword(sig)		( ((sig)-1) / (8*sizeof(unsigned long)) )
-
-int sigdelset(sigset_t *set, int signo) {
-  if ((signo<1)||(signo>SIGRTMAX)) {
-    (*__errno_location())=EINVAL;
-    return -1;
-  } else {
-    unsigned long __mask = __sigmask (signo);
-    unsigned long __word = __sigword (signo);
-    set->sig[__word]&=~__mask;
-    return 0;
-  }
-}
diff -Naur ../../../dietlibc-0.34/lib/sigemptyset.c lib/sigemptyset.c
--- ../../../dietlibc-0.34/lib/sigemptyset.c	2014-10-10 17:54:30.000000000 +0300
+++ lib/sigemptyset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <signal.h>
-
-int sigemptyset(sigset_t *set) {
-  set->sig[0]=0;
-  if (_SIGSET_WORDS>1) set->sig[1]=0;
-  if (_SIGSET_WORDS>2) {
-    set->sig[2]=0;
-    set->sig[3]=0;
-  }
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/sigfillset.c lib/sigfillset.c
--- ../../../dietlibc-0.34/lib/sigfillset.c	2014-10-10 17:54:30.000000000 +0300
+++ lib/sigfillset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include <signal.h>
-
-int sigfillset(sigset_t *set) {
-  set->sig[0]=(unsigned long)-1;
-  if (_SIGSET_WORDS>1) set->sig[1]=(unsigned long)-1;
-  if (_SIGSET_WORDS>2) {
-    set->sig[2]=(unsigned long)-1;
-    set->sig[3]=(unsigned long)-1;
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/siginterrupt.c lib/siginterrupt.c
--- ../../../dietlibc-0.34/lib/siginterrupt.c	2001-07-23 21:43:19.000000000 +0300
+++ lib/siginterrupt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <signal.h>
-
-int siginterrupt(int sig, int flag) {
-  int ret;
-  struct sigaction act;
-
-  sigaction(sig, 0, &act);
-
-  if (flag)
-    act.sa_flags &= ~SA_RESTART;
-  else
-    act.sa_flags |= SA_RESTART;
-
-  ret = sigaction(sig, &act, 0);
-
-  return ret;
-}
diff -Naur ../../../dietlibc-0.34/lib/sigisemptyset.c lib/sigisemptyset.c
--- ../../../dietlibc-0.34/lib/sigisemptyset.c	2014-10-10 17:54:30.000000000 +0300
+++ lib/sigisemptyset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#define _GNU_SOURCE
-#include <signal.h>
-
-int sigisemptyset(const sigset_t*set)
-{
-  unsigned long ret;
-  ret=set->sig[0];
-  if (_SIGSET_WORDS>1) ret|=set->sig[1];
-  if (_SIGSET_WORDS>2) {
-    ret|=set->sig[2];
-    ret|=set->sig[3];
-  }
-  return ret != 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/sigismember.c lib/sigismember.c
--- ../../../dietlibc-0.34/lib/sigismember.c	2002-05-14 10:35:38.000000000 +0300
+++ lib/sigismember.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include <signal.h>
-#include <errno.h>
-
-#define __sigmask(sig)		( ((unsigned long)1) << (((sig)-1) % (8*sizeof(unsigned long))) )
-#define __sigword(sig)		( ((sig)-1) / (8*sizeof(unsigned long)) )
-
-int sigismember(const sigset_t *set, int signo) {
-  if ((signo<1)||(signo>SIGRTMAX)) {
-    (*__errno_location())=EINVAL;
-    return -1;
-  } else {
-    unsigned long __mask = __sigmask (signo);
-    unsigned long __word = __sigword (signo);
-    return (set->sig[__word] & __mask)?1:0;
-  }
-}
diff -Naur ../../../dietlibc-0.34/lib/sigjmp.c lib/sigjmp.c
--- ../../../dietlibc-0.34/lib/sigjmp.c	2005-09-21 10:33:08.000000000 +0300
+++ lib/sigjmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include <setjmp.h>
-#include <signal.h>
-
-int __sigjmp_save(sigjmp_buf env,int savemask);
-int __sigjmp_save(sigjmp_buf env,int savemask) {
-  env[0].__mask_was_saved = 0;
-  if (savemask) {
-    env[0].__mask_was_saved=(sigprocmask(SIG_BLOCK,(sigset_t*)0,&env[0].__saved_mask)==0);
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/signal.c lib/signal.c
--- ../../../dietlibc-0.34/lib/signal.c	2005-09-21 10:33:08.000000000 +0300
+++ lib/signal.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#include <signal.h>
-
-sighandler_t signal(int signum, sighandler_t action) {
-  struct sigaction sa,oa;
-  sa.sa_handler=action;
-  sigemptyset(&sa.sa_mask);
-  if (sigaddset(&sa.sa_mask,signum) != 0)
-    return SIG_ERR;
-  sa.sa_flags = SA_NODEFER; /* FIXME ??? */
-  if (sigaction(signum,&sa,&oa) != 0)
-    return SIG_ERR;
-  return oa.sa_handler;
-}
diff -Naur ../../../dietlibc-0.34/lib/signalfd.c lib/signalfd.c
--- ../../../dietlibc-0.34/lib/signalfd.c	2014-09-08 13:11:21.000000000 +0300
+++ lib/signalfd.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <signal.h>
-#include <errno.h>
-#include <sys/signalfd.h>
-#include <fcntl.h>
-
-extern int __signalfd(int fd,const sigset_t* mask,size_t nsig);
-extern int __signalfd4(int fd,const sigset_t* mask,size_t nsig, int flags);
-
-int signalfd(int fd,const sigset_t* mask,int flags) {
-  int r=__signalfd4(fd,mask,_NSIG/8,flags);
-  if (r==-1 && errno==ENOSYS) {
-    r=__signalfd(fd,mask,NSIG/8);
-    if (r!=-1 && flags) {
-      int x;
-      x=fcntl(r,F_SETFD,flags);
-      if (x==-1)
-	close(r);
-    }
-  }
-  return r;
-}
diff -Naur ../../../dietlibc-0.34/lib/sigorset.c lib/sigorset.c
--- ../../../dietlibc-0.34/lib/sigorset.c	2014-10-10 17:54:30.000000000 +0300
+++ lib/sigorset.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#define _GNU_SOURCE
-#include <signal.h>
-
-int sigorset(sigset_t*set,const sigset_t*left,const sigset_t*right)
-{
-  set->sig[0]=left->sig[0]|right->sig[0];
-  if (_SIGSET_WORDS>1) set->sig[1]=left->sig[1]|right->sig[1];
-  if (_SIGSET_WORDS>2) {
-    set->sig[2]=left->sig[2]|right->sig[2];
-    set->sig[3]=left->sig[3]|right->sig[3];
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/sigpending.c lib/sigpending.c
--- ../../../dietlibc-0.34/lib/sigpending.c	2001-07-23 22:24:34.000000000 +0300
+++ lib/sigpending.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <signal.h>
-
-int __rt_sigpending(sigset_t *set, long nr);
-
-int sigpending(sigset_t *set) {
-  return __rt_sigpending(set, _NSIG/8);
-}
diff -Naur ../../../dietlibc-0.34/lib/sigprocmask.c lib/sigprocmask.c
--- ../../../dietlibc-0.34/lib/sigprocmask.c	2001-07-23 22:24:34.000000000 +0300
+++ lib/sigprocmask.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <signal.h>
-
-int __rt_sigprocmask(int how, const sigset_t *set, sigset_t *oldsetm, long nr);
-
-int sigprocmask(int how, const sigset_t *set, sigset_t *oldset) {
-  return __rt_sigprocmask(how, set, oldset, _NSIG/8);
-}
diff -Naur ../../../dietlibc-0.34/lib/sigqueueinfo.c lib/sigqueueinfo.c
--- ../../../dietlibc-0.34/lib/sigqueueinfo.c	2005-09-21 10:33:08.000000000 +0300
+++ lib/sigqueueinfo.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <signal.h>
-
-int __rt_sigqueueinfo(pid_t pid, int sig, siginfo_t *info);
-
-int sigqueueinfo(pid_t pid, int sig, siginfo_t *info) {
-  return __rt_sigqueueinfo(pid, sig, info);
-}
diff -Naur ../../../dietlibc-0.34/lib/sigsuspend.c lib/sigsuspend.c
--- ../../../dietlibc-0.34/lib/sigsuspend.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/sigsuspend.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <signal.h>
-
-int __rt_sigsuspend(const sigset_t *mask, long nr);
-
-int __libc_sigsuspend(const sigset_t *mask);
-int __libc_sigsuspend(const sigset_t *mask) {
-  return __rt_sigsuspend(mask, _NSIG/8);
-}
-
-int sigsuspend(const sigset_t *mask) __attribute__((weak,alias("__libc_sigsuspend")));
diff -Naur ../../../dietlibc-0.34/lib/sigtimedwait.c lib/sigtimedwait.c
--- ../../../dietlibc-0.34/lib/sigtimedwait.c	2001-07-23 22:24:34.000000000 +0300
+++ lib/sigtimedwait.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <signal.h>
-
-int __rt_sigtimedwait(const sigset_t *set, siginfo_t *info, const struct timespec *ts, long nr);
-
-int sigtimedwait(const sigset_t *set, siginfo_t *info, const struct timespec *ts) {
-  return __rt_sigtimedwait(set,info,ts,_NSIG/8);
-}
diff -Naur ../../../dietlibc-0.34/lib/sigwait.c lib/sigwait.c
--- ../../../dietlibc-0.34/lib/sigwait.c	2003-10-10 02:57:11.000000000 +0300
+++ lib/sigwait.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <signal.h>
-
-int sigwait(const sigset_t* set,int* sig) {
-  siginfo_t si;
-  int r=sigwaitinfo(set,&si);
-  if (r!=-1) *sig=si.si_signo;
-  return r;
-}
diff -Naur ../../../dietlibc-0.34/lib/siphash24.c lib/siphash24.c
--- ../../../dietlibc-0.34/lib/siphash24.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/siphash24.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,67 +0,0 @@
-#include <search.h>
-
-/* taken from https://github.com/floodyberry/siphash */
-
-#define ROTL64(a,b) (((a)<<(b))|((a)>>(64-b)))
-
-static uint64_t
-U8TO64_LE(const unsigned char *p) {
-	return *(const uint64_t *)p;
-}
-
-uint64_t
-siphash24(const unsigned char key[16], const unsigned char *m, size_t len) {
-	uint64_t v0, v1, v2, v3;
-	uint64_t mi, k0, k1;
-	uint64_t last7;
-	size_t i, blocks;
-
-	k0 = U8TO64_LE(key + 0);
-	k1 = U8TO64_LE(key + 8);
-	v0 = k0 ^ 0x736f6d6570736575ull;
-	v1 = k1 ^ 0x646f72616e646f6dull;
-	v2 = k0 ^ 0x6c7967656e657261ull;
-	v3 = k1 ^ 0x7465646279746573ull;
-
-	last7 = (uint64_t)(len & 0xff) << 56;
-
-#define sipcompress() \
-	v0 += v1; v2 += v3; \
-	v1 = ROTL64(v1,13);	v3 = ROTL64(v3,16); \
-	v1 ^= v0; v3 ^= v2; \
-	v0 = ROTL64(v0,32); \
-	v2 += v1; v0 += v3; \
-	v1 = ROTL64(v1,17); v3 = ROTL64(v3,21); \
-	v1 ^= v2; v3 ^= v0; \
-	v2 = ROTL64(v2,32);
-
-	for (i = 0, blocks = (len & ~7); i < blocks; i += 8) {
-		mi = U8TO64_LE(m + i);
-		v3 ^= mi;
-		sipcompress()
-		sipcompress()
-		v0 ^= mi;
-	}
-
-	switch (len - blocks) {
-		case 7: last7 |= (uint64_t)m[i + 6] << 48; /* fall through */
-		case 6: last7 |= (uint64_t)m[i + 5] << 40; /* fall through */
-		case 5: last7 |= (uint64_t)m[i + 4] << 32; /* fall through */
-		case 4: last7 |= (uint64_t)m[i + 3] << 24; /* fall through */
-		case 3: last7 |= (uint64_t)m[i + 2] << 16; /* fall through */
-		case 2: last7 |= (uint64_t)m[i + 1] <<  8; /* fall through */
-		case 1: last7 |= (uint64_t)m[i + 0]      ; /* fall through */
-		case 0:
-		default:;
-	};
-	v3 ^= last7;
-	sipcompress()
-	sipcompress()
-	v0 ^= last7;
-	v2 ^= 0xff;
-	sipcompress()
-	sipcompress()
-	sipcompress()
-	sipcompress()
-	return v0 ^ v1 ^ v2 ^ v3;
-}
diff -Naur ../../../dietlibc-0.34/lib/sleep.c lib/sleep.c
--- ../../../dietlibc-0.34/lib/sleep.c	2001-08-14 19:56:50.000000000 +0300
+++ lib/sleep.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include <unistd.h>
-#include <time.h>
-
-unsigned int sleep(unsigned int secs) {
-  struct timespec t;
-  t.tv_sec=secs;
-  t.tv_nsec=0;
-  nanosleep(&t,&t);
-  return secs-t.tv_sec;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/socket.c lib/socket.c
--- ../../../dietlibc-0.34/lib/socket.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/socket.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,16 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_socket(int a, int b, int c);
-int __libc_socket(int a, int b, int c) {
-  long args[] = { a, b, c };
-  return socketcall(SYS_SOCKET, args);
-}
-
-int socket(int a,int b,int c) __attribute__((weak,alias("__libc_socket")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/socketpair.c lib/socketpair.c
--- ../../../dietlibc-0.34/lib/socketpair.c	2011-03-03 21:03:16.000000000 +0200
+++ lib/socketpair.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include "syscalls.h"
-#ifdef __NR_socketcall
-
-#include <linuxnet.h>
-
-extern int socketcall(int callno,long* args);
-
-int __libc_socketpair(int a, int type, int protocol, int sv[2]);
-int __libc_socketpair(int a, int type, int protocol, int sv[2]) {
-  long args[] = { a, type, protocol, (long)sv };
-  return socketcall(SYS_SOCKETPAIR, args);
-}
-
-int socketpair(int d, int type, int protocol, int sv[2])
-  __attribute__((weak,alias("__libc_socketpair")));
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/stackgap.c lib/stackgap.c
--- ../../../dietlibc-0.34/lib/stackgap.c	2016-03-17 15:09:51.000000000 +0200
+++ lib/stackgap.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,4 +0,0 @@
-#undef __PIE__
-
-#include "stackgap-common.h"
-
diff -Naur ../../../dietlibc-0.34/lib/stackgap-common.h lib/stackgap-common.h
--- ../../../dietlibc-0.34/lib/stackgap-common.h	2018-02-10 20:27:24.000000000 +0200
+++ lib/stackgap-common.h	1970-01-01 03:00:00.000000000 +0300
@@ -1,652 +0,0 @@
-#include <sys/cdefs.h>
-// #define extern __hidden__
-
-// #define PIEDEBUG
-
-extern char __executable_start;
-
-/* Warning: this code sets up the machine registers and segments needed
- * for -fstack-protector to work.  If you compile this function with
- * -fstack-protector, it will reference those registers before they are
- * set up properly, causing a segmentation fault.  Ubuntu adds
- * -fstack-protector to their gcc default options, so this breaks.  I
- * added a workaround to the Makefile to make sure this code is always
- * compiled with -fno-stack-protector for this reason.  Or, as a friend
- * put it: yo dawg. I herd u liek stack protektion. :-)
- */
-#include <unistd.h>
-#include <fcntl.h>
-#include <alloca.h>
-#include <sys/time.h>
-#include <sys/tls.h>
-#include <endian.h>
-#include <elf.h>
-#include <stdlib.h>
-#include "dietfeatures.h"
-#include <sys/auxv.h>
-#include <string.h>
-
-#ifdef IN_LDSO
-#undef WANT_TLS
-#undef WANT_SSP
-#endif
-
-#ifdef WANT_GNU_STARTUP_BLOAT
-char* program_invocation_name;
-char* program_invocation_short_name;
-#endif
-
-void* __vdso;
-
-extern int main(int argc,char* argv[],char* envp[]);
-
-#if defined(WANT_SSP)
-extern __hidden__ unsigned long __guard;
-#endif
-
-#if defined(WANT_VALGRIND_SUPPORT)
-#ifdef NDEBUG
-#undef WANT_VALGRIND_SUPPORT
-#endif
-int __valgrind=0;
-#endif
-
-#ifdef __i386__
-int __modern_linux;
-#endif
-
-#ifdef WANT_TLS
-/* __tdatasize is the size of the initialized thread local data section
- * __tmemsize is the size of the complete thread local data section
- *   (including uninitialized data)
- * __tdataptr is a pointer to the initialized thread local data section
- * __tmemsize is already rounded up to meet alignment
- * the final memory layout is [tdata] [tbss (zero)] [tcb] */
-size_t __tdatasize, __tmemsize;
-void* __tdataptr;
-
-static void findtlsdata(long* auxvec) {
-#if (__WORDSIZE == 64)
-  Elf64_Phdr* x=0;
-#else
-  Elf32_Phdr* x=0;
-#endif
-  size_t i,n=0;
-  while (*auxvec) {
-    if (auxvec[0]==3) {	/* AT_PHDR */
-      x=(void*)auxvec[1];
-      if (n) break;
-    } else if (auxvec[0]==5) { /* AT_PHNUM */
-      n=auxvec[1];
-      if (x) break;
-    }
-    auxvec+=2;
-  } /* if we don't find the entry, the kernel let us down */
-  if (!x || !n) return;	/* a kernel this old does not support thread local storage anyway */
-  for (i=0; i<n; ++i)
-    if (x[i].p_type==PT_TLS) {
-      __tdataptr=(void*)x[i].p_vaddr;
-      __tdatasize=x[i].p_filesz;
-      __tmemsize=x[i].p_memsz;
-      if (__tmemsize&15)
-	__tmemsize=(__tmemsize+15)&~15;
-      break;
-    }
-  /* if there is no PT_TLS section, there is no thread-local data, and
-   * we just leave the __t* variables zero */
-}
-#endif
-
-#if defined(WANT_SSP) || defined(WANT_TLS)
-tcbhead_t* __tcb_mainthread;
-
-void __setup_tls(tcbhead_t*);
-
-void __setup_tls(tcbhead_t* mainthread) {
-  mainthread->tcb=mainthread;
-  mainthread->dtv=0;
-  mainthread->self=0;
-  mainthread->multiple_threads=0;
-#if defined(WANT_SSP)
-  mainthread->stack_guard=__guard;
-#endif
-
-#if defined(__x86_64__)
-
-  arch_prctl(ARCH_SET_FS, mainthread);
-
-#elif defined(__i386__)
-
-  unsigned int sd[4];
-  sd[0]=-1;
-  sd[1]=(unsigned long int)mainthread;
-  sd[2]=0xfffff; /* 4 GB limit */
-  sd[3]=0x51; /* bitfield, see struct user_desc in asm-i386/ldt.h */
-  if (__modern_linux>=0) {
-    if (set_thread_area((struct user_desc*)(void*)&sd)==0) {
-      asm volatile ("movw %w0, %%gs" :: "q" (sd[0]*8+3));
-      __modern_linux=1;
-    } else
-      __modern_linux=-1;
-  }
-
-#elif defined(__alpha__) || defined(__s390__)
-  __builtin_set_thread_pointer(mainthread);
-#elif defined(__mips__)
-  set_thread_area((char*)(void *)mainthread);
-#elif defined(__aarch64__)
-  asm volatile ("msr tpidr_el0, %0" :: "r"(mainthread));
-#elif defined(__arm__)
-  extern void __arm_set_tls(void*);
-  __arm_set_tls(mainthread);
-#elif defined(__hppa__)
-  /* control register 27 is used as thread pointer on PA-RISC Linux,
-   * but it can only be set from Ring0. The Linux kernel provides
-   * privileged code to set this register, so call that. (cf. syscalls,
-   * which branch to 0x100(%%sr2, %%r0), instead.) PA-RISC has
-   * 1-instruction delayed branching. The register may be read by any
-   * code however (using mfctl %cr27, %rXX). r26 is used as input for
-   * the kernel code, r31 is the return address pointer set by the
-   * branch instruction, so clobber both. */
-  asm volatile ("ble 0xe0(%%sr2, %%r0)\n\t"
-                "copy %0, %%r26"
-                :: "r" (mainthread) : "r26", "r31");
-#elif defined(__ABI_TLS_REGISTER)
-  register tcbhead_t* __thread_self __asm__(__ABI_TLS_REGISTER);
-  __thread_self=mainthread;
-  __asm__ __volatile__("" : : "r"(__thread_self) : "memory");
-#else
-#warning "no idea how to enable TLS on this platform, edit lib/stackgap.c"
-#endif
-}
-#endif
-
-static void* find_in_auxvec(long* x,long what) {
-  while (*x) {
-    if (*x==what)
-      return (void*)x[1];
-    x+=2;
-  }
-  return NULL;
-}
-
-static long* _auxvec;
-
-unsigned long getauxval(unsigned long type) {
-  return (long)find_in_auxvec(_auxvec,type);
-}
-
-
-
-#ifdef __PIE__
-
-#if (__WORDSIZE == 64)
-
-#define phdr Elf64_Phdr
-#define ehdr Elf64_Ehdr
-#define shdr Elf64_Shdr
-#define sym Elf64_Sym
-#define dyn Elf64_Dyn
-#define rela Elf64_Rela
-#define R_SYM ELF64_R_SYM
-#define R_TYPE ELF64_R_TYPE
-
-#else
-
-#define phdr Elf32_Phdr
-#define ehdr Elf32_Ehdr
-#define shdr Elf32_Shdr
-#define sym Elf32_Sym
-#define dyn Elf32_Dyn
-#define rela Elf32_Rela
-#define R_SYM ELF32_R_SYM
-#define R_TYPE ELF32_R_TYPE
-
-#endif
-
-#ifdef PIEDEBUG
-static size_t Strlen(const char* s) {
-  size_t i;
-  for (i=0; s[i]; ++i) ;
-  return i;
-}
-
-static ssize_t Write(int fd,const char* s,size_t len) {
-  ssize_t r;
-  asm("syscall\n" : "=a"(r) : "a" (1), "D" (fd), "S" (s), "d" (len) );
-  return r;
-}
-
-static void _puts(const char* s) {
-  Write(1,s,Strlen(s));
-}
-
-static void _putn(size_t n) {
-  char buf[100];
-  size_t j=sizeof(buf);
-  if (!n) buf[--j]='0';
-  for (; j>0 && n; ) {
-    buf[--j]=(n%10)+'0';
-    n/=10;
-  }
-  Write(1,buf+j,sizeof(buf)-j);
-}
-
-static void _putx(size_t n) {
-  char buf[100];
-  size_t j=sizeof(buf);
-  if (!n) buf[--j]='0';
-  for (; j>0 && n; ) {
-    char x = n%16;
-    buf[--j]=x<10 ? x+'0' : x+'a'-10;
-    n/=16;
-  }
-  Write(1,buf+j,sizeof(buf)-j);
-}
-
-static void _putphflags(size_t n) {
-  char buf[100];
-  size_t i=0;
-  if (n&4) buf[i++]='R';
-  if (n&2) buf[i++]='W';
-  if (n&1) buf[i++]='X';
-  Write(1,buf,i);
-}
-
-struct lookup { size_t n; const char s[20]; };
-
-static void _putl(size_t n,struct lookup* l) {
-  size_t i;
-  for (i=0; l[i].n!=0; ++i)
-    if (l[i].n==n) {
-      _puts(l[i].s);
-      return;
-    }
-  Write(1,"[",1);
-  _putx(n);
-  Write(1,"]",1);
-}
-
-static void dump_maps() {
-  int fd=open("/proc/self/maps",O_RDONLY);
-  char buf[2048];
-  if (fd!=-1) {
-    int r=read(fd,buf,sizeof(buf));
-    if (r>0) write(1,buf,r);
-    close(fd);
-  }
-}
-
-static struct lookup atype[] = {
-  { 1, "AT_IGNORE" },
-  { 2, "AT_EXECFD" },
-  { 3, "AT_PHDR" },
-  { 4, "AT_PHENT" },
-  { 5, "AT_PHNUM" },
-  { 6, "AT_PAGESZ" },
-  { 7, "AT_BASE" },
-  { 8, "AT_FLAGS" },
-  { 9, "AT_ENTRY" },
-  { 10, "AT_NOTELF" },
-  { 11, "AT_UID" },
-  { 12, "AT_EUID" },
-  { 13, "AT_GID" },
-  { 14, "AT_EGID" },
-  { 17, "AT_CLKTCK" },
-  { 15, "AT_PLATFORM" },
-  { 16, "AT_HWCAP" },
-  { 18, "AT_FPUCW" },
-  { 19, "AT_DCACHEBSIZE" },
-  { 20, "AT_ICACHEBSIZE" },
-  { 21, "AT_UCACHEBSIZE" },
-  { 22, "AT_IGNOREPPC" },
-  { 23, "AT_SECURE" },
-  { 24, "AT_BASE_PLATFORM" },
-  { 25, "AT_RANDOM" },
-  { 26, "AT_HWCAP2" },
-  { 31, "AT_EXECFN" },
-  { 32, "AT_SYSINFO" },
-  { 33, "AT_SYSINFO_EHDR" },
-  { 0 },
-};
-
-static struct lookup ptype[] = {
-  { 1, "PT_LOAD" },
-  { 2, "PT_DYNAMIC" },
-  { 3, "PT_INTERP" },
-  { 4, "PT_NOTE" },
-  { 5, "PT_SHLIB" },
-  { 6, "PT_PHDR" },
-  { 7, "PT_TLS" },
-  { 8, "PT_NUM" },
-  { 0x60000000, "PT_LOOS" },
-  { 0x6474e550, "PT_GNU_EH_FRAME" },
-  { 0x6474e551, "PT_GNU_STACK" },
-  { 0x6474e552, "PT_GNU_RELRO" },
-  { 0x6ffffffa, "PT_LOSUNW" },
-  { 0x6ffffffa, "PT_SUNWBSS" },
-  { 0x6ffffffb, "PT_SUNWSTACK" },
-  { 0x6fffffff, "PT_HISUNW" },
-  { 0x6fffffff, "PT_HIOS" },
-  { 0x70000000, "PT_LOPROC" },
-  { 0x7fffffff, "PT_HIPROC" },
-  { 0 } };
-
-static struct lookup dtag[] = {
-  { 1, "DT_NEEDED" },
-  { 2, "DT_PLTRELSZ" },
-  { 3, "DT_PLTGOT" },
-  { 4, "DT_HASH" },
-  { 5, "DT_STRTAB" },
-  { 6, "DT_SYMTAB" },
-  { 7, "DT_RELA" },
-  { 8, "DT_RELASZ" },
-  { 9, "DT_RELAENT" },
-  { 10, "DT_STRSZ" },
-  { 11, "DT_SYMENT" },
-  { 12, "DT_INIT" },
-  { 13, "DT_FINI" },
-  { 14, "DT_SONAME" },
-  { 15, "DT_RPATH" },
-  { 16, "DT_SYMBOLIC" },
-  { 17, "DT_REL" },
-  { 18, "DT_RELSZ" },
-  { 19, "DT_RELENT" },
-  { 20, "DT_PLTREL" },
-  { 21, "DT_DEBUG" },
-  { 22, "DT_TEXTREL" },
-  { 23, "DT_JMPREL" },
-  { 24, "DT_BIND_NOW" },
-  { 25, "DT_INIT_ARRAY" },
-  { 26, "DT_FINI_ARRAY" },
-  { 27, "DT_INIT_ARRAYSZ" },
-  { 28, "DT_FINI_ARRAYSZ" },
-  { 29, "DT_RUNPATH" },
-  { 30, "DT_FLAGS" },
-  { 32, "DT_ENCODING" },
-  { 32, "DT_PREINIT_ARRAY" },
-  { 33, "DT_PREINIT_ARRAYSZ" },
-  { 34, "DT_NUM" },
-  { 0x6000000d, "DT_LOOS" },
-  { 0x6ffff000, "DT_HIOS" },
-  { 0x6ffffef5, "DT_GNU_HASH" },
-  { 0x6ffffff9, "DT_RELACOUNT" },
-  { 0x6ffffffa, "DT_RELCOUNT" },
-  { 0x6ffffffb, "DT_FLAGS_1" },
-  { 0x70000000, "DT_LOPROC" },
-  { 0x7fffffff, "DT_HIPROC" },
-  { 0 }
-};
-#endif
-
-static void callback() {
-#ifdef PIEDEBUG
-  _puts("callback called!\n");
-#endif
-  _exit(111);
-}
-
-#endif	/* __PIE__ */
-
-// extern size_t _GLOBAL_OFFSET_TABLE_;
-
-
-
-
-
-
-#ifdef __PIE__
-__hidden__ char _DYNAMIC;
-#endif
-
-int stackgap(int argc,char* argv[],char* envp[]);
-int stackgap(int argc,char* argv[],char* envp[]) {
-  long* auxvec=(long*)envp;
-#if defined(WANT_STACKGAP) || defined(WANT_SSP) || defined(WANT_TLS)
-  char* rand=(char*)&auxvec;
-  char* tlsdata;
-#endif
-  while (*auxvec) ++auxvec;			/* skip envp to get to auxvec */
-  ++auxvec;
-
-  _auxvec=auxvec;
-#ifdef WANT_STACKGAP
-  unsigned short s;
-#endif
-#ifdef __PIE__
-  /* This code is meant for static PIE executables. */
-  /* Since we do not have an interpreter, we'll have to set up the GOT ourselves. */
-  {
-    size_t i;
-    const char* base=0;
-    rela* r=0;
-    size_t relasz=0,relaent=0;
-    size_t phent=0, phnum=0;
-    size_t saddr=0;
-    const char* elfimage=0;
-    for (i=0; auxvec[i]; i+=2) {
-      switch (auxvec[i]) {
-      case AT_PHDR: elfimage=(const char*)auxvec[i+1]; break;
-      case AT_PHENT: phent=auxvec[i+1]; break;
-      case AT_PHNUM: phnum=auxvec[i+1]; break;
-      case AT_ENTRY: saddr=auxvec[i+1]; break;
-      }
-    }
-    /* All four must be there, or we are hosed. Not checking. */
-
-#ifdef PIEDEBUG
-    dump_maps();
-#endif
-
-#ifdef PIEDEBUG
-    _puts("auxvec:\n");
-    for (i=0; auxvec[i]; i+=2) {
-      _putl(auxvec[i],atype);
-      _puts(" - ");
-      _putx(auxvec[i+1]);
-      _puts("\n");
-    }
-    _puts("\nme=");
-    _putx((size_t)&stackgap);
-    _puts("\n");
-#endif
-
-    if (elfimage) {
-
-      size_t* pltgot=0;
-      size_t pltrelsz=0,pltrel=0;
-
-#ifdef PIEDEBUG
-      _puts("\nphdr:\n");
-      for (i=0; i<phnum; ++i) {
-	const phdr* ph=(const phdr*)(elfimage + i*phent);
-	_puts("type ");
-	_putl(ph->p_type,ptype); _puts("\tofs ");
-	_putx(ph->p_offset); _puts("\tvaddr ");
-	_putx(ph->p_vaddr); _puts("\tpaddr ");
-	_putx(ph->p_paddr); _puts("\tfilesz ");
-	_putx(ph->p_filesz); _puts("\tmemsz ");
-	_putx(ph->p_memsz); _puts("\tflags ");
-	_putphflags(ph->p_flags); _puts("\talign ");
-	_putx(ph->p_align); _puts("\n");
-      }
-      _puts("\n\n");
-#endif
-
-      for (i=0; i<phnum; ++i) {
-	const phdr* ph=(const phdr*)(elfimage + i*phent);
-	if (ph->p_type==PT_DYNAMIC) {	/* found .dynamic */
-	  const dyn* dh;
-	  size_t j;
-	  
-	  base = &_DYNAMIC - ph->p_vaddr;
-#ifdef PIEDEBUG
-	  if (((ehdr*)base)->e_entry + (uintptr_t)base != saddr) {
-	    _puts("fail: ");
-	    _putx(((ehdr*)base)->e_entry + (uintptr_t)base);
-	    _puts(" != ");
-	    _putx(saddr);
-	    _puts("!\n\n");
-	  }
-#endif
-
-	  for (j=0; j<ph->p_memsz; j+=sizeof(dyn)) {
-	    dh=(const dyn*)(base + ph->p_vaddr + j);
-	    if (!dh->d_tag) break;
-#ifdef PIEDEBUG
-	    _putl(dh->d_tag,dtag); _puts(" - "); _putx(dh->d_un.d_val); _puts("\n");
-#endif
-	    switch (dh->d_tag) {
-	    case DT_PLTGOT: pltgot=(size_t*)(base+dh->d_un.d_ptr); break;
-	    case DT_PLTRELSZ: pltrelsz=dh->d_un.d_val; break;
-	    case DT_PLTREL: pltrel=dh->d_un.d_val; break;
-
-	    case DT_RELA: r=(rela*)(base+dh->d_un.d_ptr); break;
-	    case DT_RELASZ: relasz=dh->d_un.d_val; break;
-	    case DT_RELAENT: relaent=dh->d_un.d_val; break;
-	    }
-	  }
-	  break;
-	}
-      }
-
-#ifdef PIEDEBUG
-      _puts("got pltgot "); _putx((uintptr_t)pltgot); _puts(", pltrelsz "); _putn(pltrelsz); _puts(", pltrel "); _putn(pltrel); _puts("\n");
-#endif
-      if (r && relasz && relaent) {
-#ifdef PIEDEBUG
-	_puts("got rela ");
-	_putx((uintptr_t)r);
-	_puts(", relasz ");
-	_putx(relasz);
-	_puts(", relaent ");
-	_putx(relaent);
-	_puts("\n");
-
-	_puts("\nrela dump:\n");
-#endif
-
-	for (i=relasz/relaent; i; --i) {
-
-#ifdef PIEDEBUG
-	  _puts("@ "); _putx((uintptr_t)base + r->r_offset);
-	  _puts(", ofs "); _putx(r->r_offset);
-	  _puts(", info "); _putx(r->r_info);
-	  _puts(", addend "); _putx(r->r_addend);
-	  _puts("\n");
-#endif
-
-#if __WORDSIZE == 64
-	  unsigned int type = ELF64_R_TYPE(r->r_info);
-#else
-	  unsigned int type = ELF32_R_TYPE(r->r_info);
-#endif
-	  size_t* x=(size_t*)((char*)(base+r->r_offset));
-	  switch (type) {
-#if defined(__x86_64__)
-	  case R_X86_64_RELATIVE: *x = (uintptr_t)base + r->r_addend; break;
-#else
-#error architecture not supported yet (edit stackgap.c)
-#endif
-#ifdef PIEDEBUG
-	  default: _puts("unsupported relocation type "); _putx(type); break;
-#endif
-	  }
-	  ++r;
-	}
-	if (pltgot)
-	  pltgot[2]=(uintptr_t)callback;
-      }
-    }
-  }
-#endif
-
-#if defined(WANT_STACKGAP) || defined(WANT_SSP) || defined(WANT_TLS)
-#if defined(WANT_STACKGAP) || defined(WANT_SSP)
-  volatile char* gap;
-  rand=find_in_auxvec(auxvec,25);
-#ifdef WANT_URANDOM_SSP
-  if (!rand) {
-    rand=alloca(10);
-    int fd=open("/dev/urandom",O_RDONLY);	// If this fails, there is not much we can do. Limp on.
-    read(fd,rand,10);
-    close(fd);
-  }
-#endif
-#endif
-#ifdef WANT_STACKGAP
-#ifdef __UNALIGNED_MEMORY_ACCESS_OK
-  s=*(unsigned short*)(rand+8);
-#else
-  s=rand[8]+(rand[9]<<8);
-#endif	// __UNALIGNED_MEMORY_ACCESS_OK
-#endif	// WANT_STACKGAP
-#ifdef WANT_SSP
-#ifdef __UNALIGNED_MEMORY_ACCESS_OK
-  __guard=*(unsigned long*)rand;
-#else
-  memcpy(&__guard,rand,sizeof(__guard));
-#endif	// __UNALIGNED_MEMORY_ACCESS_OK
-#endif	// WANT_SSP
-#ifdef WANT_STACKGAP
-  gap=alloca(s);
-#endif
-#endif
-
-  __vdso=find_in_auxvec(auxvec,33);	// AT_SYSINFO_EHDR -> vdso start address
-#ifdef __x86_64__
-  if (!__vdso) __vdso=(char*)0xffffffffff600000;
-#endif
-
-#ifdef WANT_TLS
-  findtlsdata(auxvec);
-  if (__unlikely(__tmemsize+sizeof(tcbhead_t)<sizeof(tcbhead_t)) ||
-      __unlikely(__tmemsize>512*1024*1024) ||
-      __unlikely(__tmemsize<__tdatasize))
-    return 111;
-  tlsdata=alloca(__tmemsize+sizeof(tcbhead_t));
-  memcpy(tlsdata,__tdataptr,__tdatasize);
-  memset(tlsdata+__tdatasize,0,__tmemsize-__tdatasize);
-  __setup_tls(__tcb_mainthread=(tcbhead_t*)(tlsdata+__tmemsize));
-  __tcb_mainthread->sysinfo=(uintptr_t)find_in_auxvec(auxvec,32);
-#elif defined(WANT_SSP)
-  tlsdata=alloca(sizeof(tcbhead_t));
-  __setup_tls(__tcb_mainthread=(tcbhead_t*)(tlsdata));
-#endif
-#if defined(WANT_VALGRIND_SUPPORT)
-  /* detect valgrind by looking for "valgrind" in $LD_PRELOAD */
-  /* for i386 and x86_64 we do it inline instead of calling getenv to
-   * reduce bloat */
-#if defined(__i386__) || defined(__x86_64__)
-  {
-    char** e;
-    for (e=environ; *e; ++e) {
-      if (*(uint64_t*)*e == *(uint64_t*)"LD_PRELO") {
-	char* x;
-	for (x=*e; *x; ++x) {
-	  if (*(uint64_t*)x == *(uint64_t*)"valgrind") {
-	    __valgrind=1;
-	    goto found;
-	  }
-	}
-      }
-    }
-found: ;
-  }
-#else
-  {
-    const char* v=getenv("LD_PRELOAD");
-    __valgrind=(v && strstr(v,"valgrind"));
-  }
-#endif
-#endif
-#ifdef WANT_GNU_STARTUP_BLOAT
-  program_invocation_name=argv[0];
-  {
-    char* c;
-    for (c=program_invocation_short_name=program_invocation_name; *c; ++c)
-      if (*c=='/') program_invocation_short_name=c+1;
-  }
-#endif
-  exit(main(argc,argv,envp));
-}
diff -Naur ../../../dietlibc-0.34/lib/stack_smash_handler2.c lib/stack_smash_handler2.c
--- ../../../dietlibc-0.34/lib/stack_smash_handler2.c	2006-04-04 08:35:14.000000000 +0300
+++ lib/stack_smash_handler2.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <unistd.h>
-#include <write12.h>
-
-void __stack_chk_fail(void);
-
-/* earlier versions of ProPolice actually gave the address and function
- * name as arguments to the handler, so it could print some useful
- * diagnostics.  No more. :-( */
-void __stack_chk_fail(void) {
-  __write2("smashed stack detected, program terminated.\n");
-  _exit(127);
-}
diff -Naur ../../../dietlibc-0.34/lib/stack_smash_handler3.c lib/stack_smash_handler3.c
--- ../../../dietlibc-0.34/lib/stack_smash_handler3.c	2011-03-03 19:33:16.000000000 +0200
+++ lib/stack_smash_handler3.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,15 +0,0 @@
-#include <sys/cdefs.h>
-
-extern void __stack_chk_fail(void) __attribute__((noreturn));
-
-/* this is only called from implicitly generated code, so there is no
- * explicit prototype anywhere */
-void __attribute__((noreturn)) __stack_chk_fail_local(void);
-
-/* no idea why sometimes this is called instead of __stack_chk_fail,
- * but it apparently only happens with shared libraries */
-
-void __attribute__((noreturn)) __stack_chk_fail_local(void)
-{
-  __stack_chk_fail ();
-}
diff -Naur ../../../dietlibc-0.34/lib/stack_smash_handler.c lib/stack_smash_handler.c
--- ../../../dietlibc-0.34/lib/stack_smash_handler.c	2006-04-04 08:35:14.000000000 +0300
+++ lib/stack_smash_handler.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,25 +0,0 @@
-#include <write12.h>
-#include <unistd.h>
-
-/* this is only used with ProPolice in gcc 3.x */
-
-void __stack_smash_handler(char* func,unsigned int damaged);
-void __stack_smash_handler(char* func,unsigned int damaged) {
-  char buf[sizeof(char*)*2+1];
-  int i;
-  for (i=0; i<(int)sizeof(buf)-1; ++i) {
-    char c=damaged&0xf;
-    c+=c<10?'0':'a';
-    buf[sizeof(buf)-2-i]=c;
-    damaged>>=4;
-  }
-  buf[sizeof(buf)-1]=0;
-  __write2("stack smashed in ");
-  __write2(func);
-  __write2(" (value 0x");
-  __write2(buf);
-  __write2(")\n");
-  _exit(127);
-}
-
-
diff -Naur ../../../dietlibc-0.34/lib/__stat64.c lib/__stat64.c
--- ../../../dietlibc-0.34/lib/__stat64.c	2001-05-31 19:12:27.000000000 +0300
+++ lib/__stat64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#ifndef __NO_STAT64
-
-extern int __dietlibc_stat64(const char *__file, struct stat64 *__buf);
-extern void __stat64_cvt(const struct stat *src,struct stat64 *dest);
-
-int stat64(const char *__file, struct stat64 *__buf) {
-  if (__dietlibc_stat64(__file,__buf)) {
-    struct stat temp;
-    if (errno!=ENOSYS) return -1;
-    if (stat(__file,&temp)) return -1;
-    __stat64_cvt(&temp,__buf);
-  }
-  return 0;
-}
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__stat64_cvt.c lib/__stat64_cvt.c
--- ../../../dietlibc-0.34/lib/__stat64_cvt.c	2004-03-10 17:24:50.000000000 +0200
+++ lib/__stat64_cvt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,21 +0,0 @@
-#include <sys/stat.h>
-#ifndef __NO_STAT64
-
-void __stat64_cvt(const struct stat *src,struct stat64 *dest);
-
-void __stat64_cvt(const struct stat *src,struct stat64 *dest) {
-  dest->st_dev=src->st_dev;
-  dest->st_ino=src->st_ino;
-  dest->st_mode=src->st_mode;
-  dest->st_nlink=src->st_nlink;
-  dest->st_uid=src->st_uid;
-  dest->st_gid=src->st_gid;
-  dest->st_rdev=src->st_rdev;
-  dest->st_size=src->st_size;
-  dest->st_blksize=src->st_blksize;
-  dest->st_blocks=src->st_blocks;
-  dest->st_atime=src->st_atime;
-  dest->st_mtime=src->st_mtime;
-  dest->st_ctime=src->st_ctime;
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__statfs64.c lib/__statfs64.c
--- ../../../dietlibc-0.34/lib/__statfs64.c	2005-10-04 20:48:30.000000000 +0300
+++ lib/__statfs64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,23 +0,0 @@
-#include <errno.h>
-#include "dietfeatures.h"
-#include <sys/statfs.h>
-
-#if __WORDSIZE == 32
-
-extern int __dietlibc_statfs64(const char *path, size_t bufsize, struct statfs64 *__buf);
-extern void __statfs64_cvt(const struct statfs *src,struct statfs64 *dest);
-
-int statfs64(const char *__file, struct statfs64 *__buf) {
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-  if (__dietlibc_statfs64(__file,sizeof(*__buf),__buf)) {
-    struct statfs temp;
-    if (errno!=ENOSYS) return -1;
-    if (statfs(__file,&temp)) return -1;
-    __statfs64_cvt(&temp,__buf);
-  }
-  return 0;
-#else
-  return __dietlibc_statfs64(__file,sizeof(*__buf),__buf);
-#endif
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/statfs64_cvt.c lib/statfs64_cvt.c
--- ../../../dietlibc-0.34/lib/statfs64_cvt.c	2005-10-04 20:49:09.000000000 +0300
+++ lib/statfs64_cvt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,19 +0,0 @@
-#include <sys/statfs.h>
-
-#if __WORDSIZE == 32
-
-void __statfs64_cvt(const struct statfs *src,struct statfs64 *dest);
-void __statfs64_cvt(const struct statfs *src,struct statfs64 *dest) {
-  dest->f_type=src->f_type;
-  dest->f_bsize=src->f_bsize;
-  dest->f_frsize=src->f_frsize;
-  dest->f_blocks=src->f_blocks;
-  dest->f_bfree=src->f_bfree;
-  dest->f_files=src->f_files;
-  dest->f_ffree=src->f_ffree;
-  dest->f_bavail=src->f_bavail;
-  dest->f_fsid=src->f_fsid;
-  dest->f_namelen=src->f_namelen;
-}
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/statvfs.c lib/statvfs.c
--- ../../../dietlibc-0.34/lib/statvfs.c	2008-05-09 07:36:56.000000000 +0300
+++ lib/statvfs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,13 +0,0 @@
-#define _FILE_OFFSET_BITS 64
-#include <sys/statvfs.h>
-#include <sys/statfs.h>
-
-extern void __statvfs_cvt(struct statfs* from,struct statvfs* to);
-
-int statvfs(const char *path, struct statvfs *sv) {
-  struct statfs ss;
-  if (statfs(path,&ss)==-1) return -1;
-  __statvfs_cvt(&ss,sv);
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/statvfs_cvt.c lib/statvfs_cvt.c
--- ../../../dietlibc-0.34/lib/statvfs_cvt.c	2007-10-19 00:08:02.000000000 +0300
+++ lib/statvfs_cvt.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,19 +0,0 @@
-#define _FILE_OFFSET_BITS 64
-#include <sys/statvfs.h>
-#include <sys/statfs.h>
-
-void __statvfs_cvt(struct statfs* from,struct statvfs* to);
-
-void __statvfs_cvt(struct statfs* from,struct statvfs* to) {
-  to->f_bsize=from->f_bsize;
-  to->f_frsize=from->f_frsize;
-  to->f_blocks=from->f_blocks;
-  to->f_bfree=from->f_bfree;
-  to->f_bavail=from->f_bavail;
-  to->f_files=from->f_files;
-  to->f_ffree=from->f_ffree;
-  to->f_favail=from->f_ffree;
-  to->f_fsid=from->f_fsid.__val[0];
-  to->f_flag=0;
-  to->f_namemax=from->f_namelen;
-}
diff -Naur ../../../dietlibc-0.34/lib/__stime.c lib/__stime.c
--- ../../../dietlibc-0.34/lib/__stime.c	2002-11-18 03:16:51.000000000 +0200
+++ lib/__stime.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#include <errno.h>
-#include <sys/time.h>
-#include <time.h>
-#include <syscalls.h>
-
-#ifndef __NR_stime
-int stime(time_t *when)
-{
-  struct timeval tv;
-  tv.tv_sec = *when;
-  tv.tv_usec = 0;
-  return settimeofday(&tv, (struct timezone *)0);
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/stpcpy.c lib/stpcpy.c
--- ../../../dietlibc-0.34/lib/stpcpy.c	2013-08-17 01:46:38.000000000 +0300
+++ lib/stpcpy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <string.h>
-
-char * stpcpy (char *dst, const char *src) {
-  while ((*dst++ = *src++));
-  return (dst-1);
-}
diff -Naur ../../../dietlibc-0.34/lib/stpncpy.c lib/stpncpy.c
--- ../../../dietlibc-0.34/lib/stpncpy.c	2016-06-03 18:45:00.000000000 +0300
+++ lib/stpncpy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#define _GNU_SOURCE
-#include <string.h>
-#include "dietfeatures.h"
-
-char* stpncpy(char* dest, const char* src, size_t n) {
-  char* x=memccpy(dest,src,0,n);
-  if (x) {
-#ifdef WANT_FULL_POSIX_COMPAT
-    memset(x,0,n-(x-dest));
-#endif
-    return x-1;
-  } else
-    return dest+n;
-}
diff -Naur ../../../dietlibc-0.34/lib/strcat.c lib/strcat.c
--- ../../../dietlibc-0.34/lib/strcat.c	2016-04-30 00:48:29.000000000 +0300
+++ lib/strcat.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,22 +1,28 @@
 #include "dietfeatures.h"
-#include <string.h>
+#include <string.h>
+#include <swihelper.h>
 
+#ifndef __BUILDIN_FUNCTIONS
 char* strcat(register char* s,register const char* t)
 {
   char *dest=s;
   s+=strlen(s);
   for (;;) {
-    if (!(*s = *t)) break;
-                           ++s; ++t;
+    if (!(*s = *t)) break; ++s; ++t;
 #ifndef WANT_SMALL_STRING_ROUTINES
-    if (!(*s = *t)) break;
-                           ++s; ++t;
-    if (!(*s = *t)) break;
-                           ++s; ++t;
-    if (!(*s = *t)) break;
-                           ++s; ++t;
+    if (!(*s = *t)) break; ++s; ++t;
+    if (!(*s = *t)) break; ++s; ++t;
+    if (!(*s = *t)) break; ++s; ++t;
 #endif
   }
   return dest;
 }
-
+#else
+
+char* strcat(register char* s,register const char* t)
+{
+    // syscall strcat
+    __def_noinline( 23, char*, s, t);
+}
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/strchr.c lib/strchr.c
--- ../../../dietlibc-0.34/lib/strchr.c	2018-09-25 00:34:48.000000000 +0300
+++ lib/strchr.c	2023-10-14 22:05:22.491036121 +0300
@@ -1,27 +1,28 @@
 #include "dietfeatures.h"
-#include <string.h>
+#include <string.h>
+#include <swihelper.h>
+
 
+#ifndef __BUILDIN_FUNCTIONS
 char *strchr(register const char *t, int c) {
   register char ch;
 
   ch = c;
   for (;;) {
-    if (__unlikely(*t == ch)) break; 
-				     if (__unlikely(!*t)) return 0;
-								    ++t;
+    if (__unlikely(*t == ch)) break; if (__unlikely(!*t)) return 0; ++t;
 #ifndef WANT_SMALL_STRING_ROUTINES
-    if (__unlikely(*t == ch)) break; 
-				     if (__unlikely(!*t)) return 0;
-								    ++t;
-    if (__unlikely(*t == ch)) break; 
-				     if (__unlikely(!*t)) return 0;
-								    ++t;
-    if (__unlikely(*t == ch)) break; 
-				     if (__unlikely(!*t)) return 0;
-								    ++t;
+    if (__unlikely(*t == ch)) break; if (__unlikely(!*t)) return 0; ++t;
+    if (__unlikely(*t == ch)) break; if (__unlikely(!*t)) return 0; ++t;
+    if (__unlikely(*t == ch)) break; if (__unlikely(!*t)) return 0; ++t;
 #endif
   }
   return (char*)t;
-}
+}
+#else
+char *strchr(register const char *t, int c)
+{
+    __def_noinline(24, char*, t, c)
+}
+#endif
 
 char *index(char *t,int c)	__attribute__((weak,alias("strchr")));
diff -Naur ../../../dietlibc-0.34/lib/strcmp.c lib/strcmp.c
--- ../../../dietlibc-0.34/lib/strcmp.c	2016-06-06 14:48:29.000000000 +0300
+++ lib/strcmp.c	2023-10-14 22:05:22.491036121 +0300
@@ -1,12 +1,12 @@
 /* fast strcmp -- Copyright (C) 2003 Thomas M. Ogrisegg <tom@hi-tek.fnord.at> */
 #include <string.h>
 #include "dietfeatures.h"
-#include "dietstring.h"
-
-#ifdef WANT_VALGRIND_SUPPORT
-extern int __valgrind;
-#endif
+#include "dietstring.h"
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 int
 strcmp (const char *s1, const char *s2)
 {
@@ -19,11 +19,7 @@
     unsigned long   l1, l2;
     int             tmp;
 
-    if (UNALIGNED(s1, s2)
-#ifdef WANT_VALGRIND_SUPPORT
-        || __unlikely(__valgrind)
-#endif
-    ) {
+    if (UNALIGNED(s1, s2)) {
         while (*s1 && *s1 == *s2) s1++, s2++;
         return (*s1 - *s2);
     }
@@ -53,6 +49,15 @@
         }
     }
 #endif
-}
+}
+#else
+int
+strcmp (const char *s1, const char *s2)
+{
+    __def_noinline(25, int, s1, s2)
+}
+
+#endif
 
 int strcoll(const char *s,const char* t)       __attribute__((weak,alias("strcmp")));
+
diff -Naur ../../../dietlibc-0.34/lib/strcpy.c lib/strcpy.c
--- ../../../dietlibc-0.34/lib/strcpy.c	2016-06-06 14:48:30.000000000 +0300
+++ lib/strcpy.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,12 +1,12 @@
 /* fast strcpy -- Copyright (C) 2003 Thomas M. Ogrisegg <tom@hi-tek.fnord.at> */
 #include <string.h>
 #include "dietfeatures.h"
-#include "dietstring.h"
-
-#ifdef WANT_VALGRIND_SUPPORT
-extern int __valgrind;
-#endif
+#include "dietstring.h"
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 char *
 strcpy (char *s1, const char *s2)
 {
@@ -18,11 +18,7 @@
     int             tmp;
     unsigned long   l;
 
-    if (UNALIGNED(s1, s2)
-#ifdef WANT_VALGRIND_SUPPORT
-        || __unlikely(__valgrind)
-#endif
-    ) {
+    if (UNALIGNED(s1, s2)) {
 	while ((*s1++ = *s2++));
 	return (res);
     }
@@ -42,4 +38,13 @@
 	s1 += sizeof(unsigned long);
     }
 #endif
-}
+}
+#else
+char *
+strcpy (char *s1, const char *s2)
+{
+    __def_noinline(26, char *, s1, s2)
+}
+
+#endif
+
diff -Naur ../../../dietlibc-0.34/lib/strcspn.c lib/strcspn.c
--- ../../../dietlibc-0.34/lib/strcspn.c	2010-09-23 03:27:36.000000000 +0300
+++ lib/strcspn.c	2023-10-15 17:05:34.780183822 +0300
@@ -4,7 +4,7 @@
 size_t strcspn(const char *s, const char *reject)
 {
   size_t l=0;
-  int i;
+  int i,al=strlen(reject);
 
   for (; *s; ++s) {
     for (i=0; reject[i]; ++i)
diff -Naur ../../../dietlibc-0.34/lib/strlcpy.3 lib/strlcpy.3
--- ../../../dietlibc-0.34/lib/strlcpy.3	2001-01-09 19:57:43.000000000 +0200
+++ lib/strlcpy.3	1970-01-01 03:00:00.000000000 +0300
@@ -1,169 +0,0 @@
-.\" $OpenBSD: strlcpy.3,v 1.10 2000/11/06 01:03:25 aaron Exp $
-.\"
-.\" Copyright (c) 1998, 2000 Todd C. Miller <Todd.Miller@courtesan.com>
-.\" All rights reserved.
-.\"
-.\" Redistribution and use in source and binary forms, with or without
-.\" modification, are permitted provided that the following conditions
-.\" are met:
-.\" 1. Redistributions of source code must retain the above copyright
-.\"    notice, this list of conditions and the following disclaimer.
-.\" 2. Redistributions in binary form must reproduce the above copyright
-.\"    notice, this list of conditions and the following disclaimer in the
-.\"    documentation and/or other materials provided with the distribution.
-.\" 3. The name of the author may not be used to endorse or promote products
-.\"    derived from this software without specific prior written permission.
-.\"
-.\" THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,
-.\" INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
-.\" AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
-.\" THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
-.\" EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
-.\" PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
-.\" OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
-.\" WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
-.\" OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
-.\" ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-.\"
-.Dd June 22, 1998
-.Dt STRLCPY 3
-.Os
-.Sh NAME
-.Nm strlcpy ,
-.Nm strlcat
-.Nd size-bounded string copying and concatenation
-.Sh SYNOPSIS
-.Fd #include <string.h>
-.Ft size_t
-.Fn strlcpy "char *dst" "const char *src" "size_t size"
-.Ft size_t
-.Fn strlcat "char *dst" "const char *src" "size_t size"
-.Sh DESCRIPTION
-The
-.Fn strlcpy
-and
-.Fn strlcat
-functions copy and concatenate strings respectively.
-They are designed
-to be safer, more consistent, and less error prone replacements for
-.Xr strncpy 3
-and
-.Xr strncat 3 .
-Unlike those functions,
-.Fn strlcpy
-and
-.Fn strlcat
-take the full size of the buffer (not just the length) and guarantee to
-NUL-terminate the result (as long as
-.Fa size
-is larger than 0 or, in the case of
-.Fn strlcat ,
-as long as there is at least one byte free in
-.Fa dst ) .
-Note that you should include a byte for the NUL in
-.Fa size .
-Also note that
-.Fn strlcpy  
-and
-.Fn strlcat
-only operate on true
-.Dq C
-strings.
-This means that for
-.Fn strlcpy
-.Fa src
-must be NUL-terminated and for
-.Fn strlcat
-both
-.Fa src
-and
-.Fa dst
-must be NUL-terminated.
-.Pp
-The
-.Fn strlcpy
-function copies up to
-.Fa size
-- 1 characters from the NUL-terminated string
-.Fa src
-to
-.Fa dst ,
-NUL-terminating the result.
-.Pp
-The
-.Fn strlcat
-function appends the NUL-terminated string
-.Fa src
-to the end of
-.Fa dst .
-It will append at most
-.Fa size
-- strlen(dst) - 1 bytes, NUL-terminating the result.
-.Sh RETURN VALUES
-The
-.Fn strlcpy
-and
-.Fn strlcat
-functions return the total length of the string they tried to create.
-For
-.Fn strlcpy
-that means the length of
-.Fa src .
-For
-.Fn strlcat
-that means the initial length of
-.Fa dst
-plus
-the length of
-.Fa src .
-While this may seem somewhat confusing it was done to make
-truncation detection simple.
-.Sh EXAMPLES
-The following code fragment illustrates the simple case:
-.Bd -literal -offset indent
-char *s, *p, buf[BUFSIZ];
-
-\&...
-
-(void)strlcpy(buf, s, sizeof(buf));
-(void)strlcat(buf, p, sizeof(buf));
-.Ed
-.Pp
-To detect truncation, perhaps while building a pathname, something
-like the following might be used:
-.Bd -literal -offset indent
-char *dir, *file, pname[MAXPATHLEN];
-
-\&...
-
-if (strlcpy(pname, dir, sizeof(pname)) >= sizeof(pname))
-	goto toolong;
-if (strlcat(pname, file, sizeof(pname)) >= sizeof(pname))
-	goto toolong;
-.Ed
-.Pp
-Since we know how many characters we copied the first time, we can
-speed things up a bit by using a copy instead of an append:
-.Bd -literal -offset indent
-char *dir, *file, pname[MAXPATHLEN];
-size_t n;
-
-\&...
-
-n = strlcpy(pname, dir, sizeof(pname));
-if (n >= sizeof(pname))
-	goto toolong;
-if (strlcpy(pname + n, file, sizeof(pname) - n) >= sizeof(pname) - n)
-	goto toolong;
-.Ed
-.Pp
-However, one may question the validity of such optimizations, as they
-defeat the whole purpose of
-.Fn strlcpy
-and
-.Fn strlcat .
-As a matter of fact, the first version of this manual page got it wrong.
-.Sh SEE ALSO
-.Xr snprintf 3 ,
-.Xr strncat 3 ,
-.Xr strncpy 3
diff -Naur ../../../dietlibc-0.34/lib/strlen.c lib/strlen.c
--- ../../../dietlibc-0.34/lib/strlen.c	2016-06-06 14:48:30.000000000 +0300
+++ lib/strlen.c	2023-10-14 22:05:22.491036121 +0300
@@ -2,7 +2,11 @@
 #include "dietfeatures.h"
 #include <string.h>
 #include <stdint.h>
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 #ifdef WANT_SMALL_STRING_ROUTINES
 size_t strlen(const char *s) {
   register size_t i;
@@ -22,29 +26,14 @@
 
 static word_t const	magic = (word_t)(0x0101010101010101ull);
 
-#ifdef WANT_VALGRIND_SUPPORT
-extern int __valgrind;
-#endif
-
 size_t strlen(const char *s)
 {
   const char *t = s;
   word_t	word;
   word_t	mask;
-#if __BYTE_ORDER != __LITTLE_ENDIAN
-  word_t	orig_word;
-#endif
 
   if (__unlikely(!s)) return 0;
 
-#ifdef WANT_VALGRIND_SUPPORT
-  if (__unlikely(__valgrind)) {
-    register size_t i;
-    for (i=0; __likely(*s); ++s) ++i;
-    return i;
-  }
-#endif
-
   /* Byte compare up until word boundary */
   for (; ((unsigned long) t & (sizeof(magic)-1)); t++)
     if (!*t) return t - s;
@@ -52,9 +41,6 @@
   /* Word compare */
   do {
     word = *((word_t const *) t); t += sizeof word;
-#if __BYTE_ORDER != __LITTLE_ENDIAN
-    orig_word = word;
-#endif
     word = (word - magic) &~ word;
     word &= (magic << 7);
   } while (__likely(word == 0));
@@ -81,18 +67,6 @@
   default: { char exc[sizeof(word)==8]; (void)exc; }
   }
 #else
-  /* On big endian there's a corner case where the remaining up to
-   * (wordsize-1) bytes in a string are \001. In that case above code
-   * properly detects that a NUL byte is present in this word, but the
-   * result of the calculation in the loop will leave the following
-   * code thinking that _only_ NUL bytes are present in the remaining
-   * word, resulting in strlen returning a value that's too small. This
-   * is not a problem on little endian systems. */
-  if (__unlikely(orig_word < magic)) {
-    for (t -= sizeof(word); __unlikely(*t); t++);
-    return t - s;
-  }
-
   mask = (magic << 7);
 
   switch (sizeof(word)) {
@@ -126,3 +100,11 @@
   return t - sizeof(word) - s;
 }
 #endif
+#else
+size_t strlen(const char *s)
+{
+    __def_noinline(27, size_t, s)
+}
+
+#endif
+
diff -Naur ../../../dietlibc-0.34/lib/strncat.c lib/strncat.c
--- ../../../dietlibc-0.34/lib/strncat.c	2016-04-30 00:48:29.000000000 +0300
+++ lib/strncat.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,6 +1,10 @@
 #include "dietfeatures.h"
 #include <string.h>
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 /* gcc is broken and has a non-SUSv2 compliant internal prototype.
  * This causes it to warn about a type mismatch here.  Ignore it. */
 char *strncat(char *s, const char *t, size_t n) {
@@ -9,22 +13,20 @@
   s+=strlen(s);
   if (__unlikely((max=s+n)==s)) goto fini;
   for (;;) {
-    if (__unlikely(!(*s = *t))) break;
-                                       if (__unlikely(++s==max)) break;
-                                                                        ++t;
+    if (__unlikely(!(*s = *t))) break; if (__unlikely(++s==max)) break; ++t;
 #ifndef WANT_SMALL_STRING_ROUTINES
-    if (__unlikely(!(*s = *t))) break;
-                                       if (__unlikely(++s==max)) break;
-                                                                        ++t;
-    if (__unlikely(!(*s = *t))) break;
-                                       if (__unlikely(++s==max)) break;
-                                                                        ++t;
-    if (__unlikely(!(*s = *t))) break;
-                                       if (__unlikely(++s==max)) break;
-                                                                        ++t;
+    if (__unlikely(!(*s = *t))) break; if (__unlikely(++s==max)) break; ++t;
+    if (__unlikely(!(*s = *t))) break; if (__unlikely(++s==max)) break; ++t;
+    if (__unlikely(!(*s = *t))) break; if (__unlikely(++s==max)) break; ++t;
 #endif
   }
   *s=0;
 fini:
   return dest;
 }
+#else
+char *strncat(char *s, const char *t, size_t n) {
+    __def_noinline(0x0114, char *, s, t, n)
+}
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/strncmp.c lib/strncmp.c
--- ../../../dietlibc-0.34/lib/strncmp.c	2012-01-15 21:10:26.000000000 +0200
+++ lib/strncmp.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,13 +1,17 @@
 #include <sys/types.h>
 #include <string.h>
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 /* gcc is broken and has a non-SUSv2 compliant internal prototype.
  * This causes it to warn about a type mismatch here.  Ignore it. */
 int strncmp(const char *s1, const char *s2, size_t n) {
   register const unsigned char* a=(const unsigned char*)s1;
   register const unsigned char* b=(const unsigned char*)s2;
   register const unsigned char* fini=a+n;
-  while (a!=fini) {
+  while (a<fini) {
     register int res=*a-*b;
     if (res) return res;
     if (!*a) return 0;
@@ -15,3 +19,11 @@
   }
   return 0;
 }
+#else
+int strncmp(const char *s1, const char *s2, size_t n)
+{
+    __def_noinline(0x0115, int, s1, s2, n)
+}
+
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/strncpy.c lib/strncpy.c
--- ../../../dietlibc-0.34/lib/strncpy.c	2006-04-12 19:39:11.000000000 +0300
+++ lib/strncpy.c	2023-10-14 22:05:22.495036228 +0300
@@ -3,7 +3,11 @@
 #include <sys/types.h>
 #include <string.h>
 #include "dietfeatures.h"
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 /* gcc is broken and has a non-SUSv2 compliant internal prototype.
  * This causes it to warn about a type mismatch here.  Ignore it. */
 char *strncpy(char *dest, const char *src, size_t n) {
@@ -16,3 +20,10 @@
 #endif
   return dest;
 }
+#else
+char *strncpy(char *dest, const char *src, size_t n)
+{
+    __def_noinline(0x0116, char *, dest, src, n)
+}
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/strnlen.c lib/strnlen.c
--- ../../../dietlibc-0.34/lib/strnlen.c	2015-09-30 14:27:28.000000000 +0300
+++ lib/strnlen.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <string.h>
-
-size_t strnlen(const char *s,size_t maxlen) {
-  const char* x=memchr(s,0,maxlen);
-  if (!x) x=s+maxlen;
-  return x-s;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/strrchr.c lib/strrchr.c
--- ../../../dietlibc-0.34/lib/strrchr.c	2016-04-30 00:48:29.000000000 +0300
+++ lib/strrchr.c	2023-10-14 22:05:22.491036121 +0300
@@ -1,28 +1,31 @@
 #include <string.h>
-#include "dietfeatures.h"
+#include "dietfeatures.h"
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 char *strrchr(const char *t, int c) {
   register char ch;
   register const char *l=0;
 
   ch = c;
   for (;;) {
-    if (__unlikely(*t == ch)) l=t;
-                                   if (__unlikely(!*t)) return (char*)l;
-                                                                         ++t;
+    if (__unlikely(*t == ch)) l=t; if (__unlikely(!*t)) return (char*)l; ++t;
 #ifndef WANT_SMALL_STRING_ROUTINES
-    if (__unlikely(*t == ch)) l=t;
-                                   if (__unlikely(!*t)) return (char*)l;
-                                                                         ++t;
-    if (__unlikely(*t == ch)) l=t;
-                                   if (__unlikely(!*t)) return (char*)l;
-                                                                         ++t;
-    if (__unlikely(*t == ch)) l=t;
-                                   if (__unlikely(!*t)) return (char*)l;
-                                                                         ++t;
+    if (__unlikely(*t == ch)) l=t; if (__unlikely(!*t)) return (char*)l; ++t;
+    if (__unlikely(*t == ch)) l=t; if (__unlikely(!*t)) return (char*)l; ++t;
+    if (__unlikely(*t == ch)) l=t; if (__unlikely(!*t)) return (char*)l; ++t;
 #endif
   }
   return (char*)l;
-}
+}
+#else
+char *strrchr(const char *t, int c)
+{
+    __def_noinline(0x0117, char *, t, c)
+}
+
+#endif
 
 char *rindex(const char *t,int c)	__attribute__((weak,alias("strrchr")));
diff -Naur ../../../dietlibc-0.34/lib/strsep.c lib/strsep.c
--- ../../../dietlibc-0.34/lib/strsep.c	2015-04-11 07:26:28.000000000 +0300
+++ lib/strsep.c	2023-10-14 22:05:22.491036121 +0300
@@ -2,7 +2,7 @@
 
 char *strsep(char **stringp, const char *delim) {
   register char *tmp=*stringp;
-  register char *tmp2;
+  register char *tmp2=tmp;
   register const char *tmp3;
   if (!*stringp) return 0;
   for (tmp2=tmp; *tmp2; ++tmp2) {
diff -Naur ../../../dietlibc-0.34/lib/strstr.c lib/strstr.c
--- ../../../dietlibc-0.34/lib/strstr.c	2008-02-19 02:28:13.000000000 +0200
+++ lib/strstr.c	2023-10-14 22:05:22.495036228 +0300
@@ -1,6 +1,10 @@
 #include <sys/types.h>
-#include <string.h>
+#include <string.h>
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 char *strstr(const char *haystack, const char *needle) {
   size_t nl=strlen(needle);
   size_t hl=strlen(haystack);
@@ -15,3 +19,12 @@
   }
   return 0;
 }
+#else
+
+char *strstr(const char *haystack, const char *needle)
+{
+    __def_noinline(0x0118, char *, haystack, needle)
+}
+
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/strtod.c lib/strtod.c
--- ../../../dietlibc-0.34/lib/strtod.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/strtod.c	2023-10-14 22:07:02.809736207 +0300
@@ -2,24 +2,18 @@
 #include <stdlib.h>
 #include <ctype.h>
 
-#ifndef WANT_STRTOD_WITHOUT_LONG_DOUBLE
-#define ldbltype long double
-#else
-#define ldbltype double
-#endif
-
 double strtod(const char* s, char** endptr) {
     register const char*  p     = s;
-    register ldbltype     value = 0.;
+    register long double  value = 0.L;
     int                   sign  = +1;
-    ldbltype              factor;
+    long double           factor;
     unsigned int          expo;
 
     while ( isspace(*p) )
         p++;
 
     switch (*p) {
-    case '-': sign = -1;	/* fall through */
+    case '-': sign = -1;
     case '+': p++;
     default : break;
     }
@@ -39,15 +33,15 @@
 
     if ( (*p | 32) == 'e' ) {
         expo   = 0;
-        factor = 10.;
+        factor = 10.L;
 
-        switch (*++p) {                 // ja hier weiÃ ich nicht, was mindestens nach einem 'E' folgenden MUSS.
-        case '-': factor = 0.1;	/* fall through */
+        switch (*++p) {                 // ja hier weiß ich nicht, was mindestens nach einem 'E' folgenden MUSS.
+        case '-': factor = 0.1;
         case '+': p++;
                   break;
         case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
                   break;
-        default : value = 0.;
+        default : value = 0.L;
                   p     = s;
                   goto done;
         }
diff -Naur ../../../dietlibc-0.34/lib/strtof.c lib/strtof.c
--- ../../../dietlibc-0.34/lib/strtof.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/strtof.c	2023-10-14 22:07:02.809736207 +0300
@@ -13,7 +13,7 @@
         p++;
 
     switch (*p) {
-    case '-': sign = -1;	/* fall through */
+    case '-': sign = -1;
     case '+': p++;
     default : break;
     }
@@ -35,8 +35,8 @@
         expo   = 0;
         factor = 10.L;
 
-        switch (*++p) {                 // ja hier weiÃ ich nicht, was mindestens nach einem 'E' folgenden MUSS.
-        case '-': factor = 0.1;	/* fall through */
+        switch (*++p) {                 // ja hier weiß ich nicht, was mindestens nach einem 'E' folgenden MUSS.
+        case '-': factor = 0.1;
         case '+': p++;
                   break;
         case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
diff -Naur ../../../dietlibc-0.34/lib/strtol.c lib/strtol.c
--- ../../../dietlibc-0.34/lib/strtol.c	2004-08-24 13:10:48.000000000 +0300
+++ lib/strtol.c	2023-10-14 22:05:22.491036121 +0300
@@ -3,7 +3,11 @@
 #include <errno.h>
 #include <limits.h>
 #include <stdlib.h>
+#include <swihelper.h>
+
+
 
+#ifndef __BUILDIN_FUNCTIONS
 #if __WORDSIZE == 64
 #define ABS_LONG_MIN 9223372036854775808UL
 #else
@@ -30,3 +34,10 @@
   }
   return (neg?-v:v);
 }
+#else
+long int strtol(const char *nptr, char **endptr, int base)
+{
+    __def_noinline(0x0119, long int, nptr, endptr, base)
+}
+
+#endif
diff -Naur ../../../dietlibc-0.34/lib/strtold.c lib/strtold.c
--- ../../../dietlibc-0.34/lib/strtold.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/strtold.c	2023-10-14 22:07:02.809736207 +0300
@@ -13,7 +13,7 @@
         p++;
 
     switch (*p) {
-    case '-': sign = -1;	/* fall through */
+    case '-': sign = -1;
     case '+': p++;
     default : break;
     }
@@ -35,8 +35,8 @@
         expo   = 0;
         factor = 10.L;
 
-        switch (*++p) {                 // ja hier weiÃ ich nicht, was mindestens nach einem 'E' folgenden MUSS.
-        case '-': factor = 0.1;	/* fall through */
+        switch (*++p) {                 // ja hier weiß ich nicht, was mindestens nach einem 'E' folgenden MUSS.
+        case '-': factor = 0.1;
         case '+': p++;
                   break;
         case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':
diff -Naur ../../../dietlibc-0.34/lib/strverscmp.c lib/strverscmp.c
--- ../../../dietlibc-0.34/lib/strverscmp.c	2015-04-11 07:26:28.000000000 +0300
+++ lib/strverscmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,32 +0,0 @@
-#define _GNU_SOURCE
-#include <string.h>
-#include <ctype.h>
-
-int strverscmp(const char* s1, const char* s2)
-{
-  size_t i,j;
-  long long a,b;
-  b=0;
-  for (i=0; s1[i]==s2[i]; ++i) {
-    if (!s1[i]) return 0;	/* perfect match */
-  }
-
-  /* if we get here, there is a mismatch */
-  /* backtrack over the matching digits */
-  if (!isdigit(s1[i]) || !isdigit(s2[i]))
-    return s1[i]-s2[i];
-  for (j=i; j>0 && isdigit(s1[j-1]); --j) ;
-  for (a=0; j<i; ++j) {
-    a=a*10+s1[j]-'0';
-  }
-  b=a;
-  while (isdigit(s1[i])) {
-    a=a*10+s1[i]-'0';
-    ++i;
-  }
-  while (isdigit(s2[j])) {
-    b=b*10+s2[j]-'0';
-    ++j;
-  }
-  return a<b ? -1 : 1;
-}
diff -Naur ../../../dietlibc-0.34/lib/swapcontext.c lib/swapcontext.c
--- ../../../dietlibc-0.34/lib/swapcontext.c	2014-10-10 21:23:27.000000000 +0300
+++ lib/swapcontext.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <ucontext.h>
-#include <stdio.h>
-
-int swapcontext(ucontext_t* o,const ucontext_t* n) {
-  volatile int once=0;
-  if (getcontext(o)==-1) return -1;
-  if (!once) {
-    ++once;
-    return setcontext(n);
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/__sysctl.c lib/__sysctl.c
--- ../../../dietlibc-0.34/lib/__sysctl.c	2003-08-19 18:28:11.000000000 +0300
+++ lib/__sysctl.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,29 +0,0 @@
-/* includes linux/sysctl.h, and we don't want to rely in Linux kernel
- * headers for building the diet libc: */
-/* #include <sys/sysctl.h> */
-#include <unistd.h>
-
-struct __sysctl_args {
-	int *name;
-	int nlen;
-	void *oldval;
-	size_t *oldlenp;
-	void *newval;
-	size_t newlen;
-	unsigned long __unused[4];
-};
-
-extern int sysctl (int *, int, void *, size_t *, void *, size_t);
-
-int
-sysctl (int *name, int nlen, void *oldval, size_t *oldlenp, void *newval, size_t newlen)
-{
-	struct __sysctl_args args;
-	args.name = name;
-	args.nlen = nlen;
-	args.oldval = oldval;
-	args.oldlenp = oldlenp;
-	args.newval = newval;
-	args.newlen = newlen;
-	return (_sysctl (&args));
-}
diff -Naur ../../../dietlibc-0.34/lib/sys_siglist.c lib/sys_siglist.c
--- ../../../dietlibc-0.34/lib/sys_siglist.c	2003-10-18 18:53:35.000000000 +0300
+++ lib/sys_siglist.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,175 +0,0 @@
-const char *const __sys_siglist[] = {
-  "Signal 0",
-  "Hangup",
-  "Interrupt",
-  "Quit",
-  "Illegal instruction",
-  "Trace/breakpoint trap",
-  "ABRT/IOT trap",
-#if defined(__alpha__) || defined(__sparc__) || defined(__mips__) || defined(__hppa__)
-  "EMT trap",
-#else
-  "Bus error",
-#endif
-  "Floating point exception",
-  "Killed",
-#if defined(__alpha__) || defined(__sparc__) || defined(__mips__) || defined(__hppa__)
-  "Bus error",
-#else
-  "User defined signal 1",
-#endif
-  "Segmentation fault",
-#if defined(__alpha__) || defined(__sparc__) || defined(__mips__) || defined(__hppa__)
-  "Bad system call",
-#else
-  "User defined signal 2",
-#endif
-  "Broken pipe",
-  "Alarm clock",
-  "Terminated",
-#if defined(__hppa__)
-  "User defined signal 1",
-  "User defined signal 2",
-  "Child exited",
-  "Power lost",
-  "Virtual timer expired",
-  "Profiling timer expired",
-  "I/O possible",
-  "Window changed",
-  "Stopped (signal)",
-  "Stopped",
-  "Continued",
-  "Stopped (tty input)",
-  "Stopped (tty output)",
-  "Urgent I/O condition",
-  "Power lost",
-  "Unknown",
-  "Unknown",
-  "CPU time limit exceeded",
-  "File size limit exceeded",
-  "Unknown",
-  "Stack fault",
-#elif defined(__mips__)
-  "User defined signal 1",
-  "User defined signal 2",
-  "Child exited",
-  "Power lost",
-  "Window changed",
-  "Urgent I/O condition",
-  "I/O possible",
-  "Stopped (signal)",
-  "Stopped",
-  "Continued",
-  "Stopped (tty input)",
-  "Stopped (tty output)",
-  "Virtual timer expired",
-  "Profiling timer expired",
-  "CPU time limit exceeded",
-  "File size limit exceeded",
-#elif defined(__alpha__) || defined(__sparc__)
-  "Urgent I/O condition",
-  "Stopped (signal)",
-  "Stopped",
-  "Continued",
-  "Child exited",
-  "Stopped (tty input)",
-  "Stopped (tty output)",
-  "I/O possible",
-  "CPU time limit exceeded",
-  "File size limit exceeded",
-  "Virtual timer expired",
-  "Profiling timer expired",
-  "Window changed",
-  "Power/Resource lost",
-  "User defined signal 1",
-  "User defined signal 2",
-#else
-  "Stack fault",
-  "Child exited",
-  "Continued",
-  "Stopped (signal)",
-  "Stopped",
-  "Stopped (tty input)",
-  "Stopped (tty output)",
-  "Urgent I/O condition",
-  "CPU time limit exceeded",
-  "File size limit exceeded",
-  "Virtual timer expired",
-  "Profiling timer expired",
-  "Window changed",
-  "I/O possible",
-  "Power lost",
-  "Bad system call",
-#endif
-#ifndef __hppa__
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-#endif
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-#ifdef __mips__
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-  "Real time signal",
-#endif
-  0
-};
-
-const char *const* sys_siglist=__sys_siglist;
diff -Naur ../../../dietlibc-0.34/lib/tcdrain.c lib/tcdrain.c
--- ../../../dietlibc-0.34/lib/tcdrain.c	2001-08-14 19:56:51.000000000 +0300
+++ lib/tcdrain.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/ioctl.h>
-
-int __libc_tcdrain(int fd);
-int __libc_tcdrain(int fd)
-{
-  return ioctl(fd, TCSBRK, 1);
-}
-
-int tcdrain(int fd) __attribute__((weak,alias("__libc_tcdrain")));
diff -Naur ../../../dietlibc-0.34/lib/tcflow.c lib/tcflow.c
--- ../../../dietlibc-0.34/lib/tcflow.c	2001-08-15 19:39:30.000000000 +0300
+++ lib/tcflow.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,35 +0,0 @@
-#include "dietfeatures.h"
-#include <errno.h>
-#include <termios.h>
-#include <sys/ioctl.h>
-
-int  tcflow ( int fd, int action )
-{
-#if TCOOFF==0  &&  TCOON==1  &&  TCIOFF==2  &&  TCION==3
-
-    if ( (unsigned int)action < 4u )
-	return ioctl ( fd, TCXONC, action );
-
-    errno = EINVAL;
-    return -1;
-
-#else
-
-    int  arg = 0;
-    
-    switch (action) {
-    case TCION: 
-	arg++;
-    case TCIOFF: 
-	arg++;
-    case TCOON:   
-	arg++;
-    case TCOOFF:
-	return ioctl ( fd, TCXONC, arg );
-    default:
-        errno = EINVAL;
-        return -1;
-    }
-
-#endif
-}
diff -Naur ../../../dietlibc-0.34/lib/tcflush.c lib/tcflush.c
--- ../../../dietlibc-0.34/lib/tcflush.c	2018-05-05 03:30:53.000000000 +0300
+++ lib/tcflush.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <sys/ioctl.h>
-
-int __libc_tcflush(int fd, int queue_selector);
-int __libc_tcflush(int fd, int queue_selector)
-{
-  return ioctl(fd, TCFLSH, queue_selector);
-}
-
-int tcflush(int fd, int queue_selector) __attribute__((weak,alias("__libc_tcflush")));
diff -Naur ../../../dietlibc-0.34/lib/tcgetattr.c lib/tcgetattr.c
--- ../../../dietlibc-0.34/lib/tcgetattr.c	2001-01-09 19:57:43.000000000 +0200
+++ lib/tcgetattr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <termios.h>
-#include <sys/ioctl.h>
-
-int tcgetattr(int fildes, struct termios *termios_p)
-{
-  return ioctl(fildes, TCGETS, termios_p);
-}
diff -Naur ../../../dietlibc-0.34/lib/tcgetpgrp.c lib/tcgetpgrp.c
--- ../../../dietlibc-0.34/lib/tcgetpgrp.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/tcgetpgrp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <termios.h>
-#include <sys/ioctl.h>
-#include <unistd.h>
-
-pid_t tcgetpgrp(int fildes)
-{
-  int32_t foo = -1;
-  if (ioctl(fildes, TIOCGPGRP, &foo)==-1)
-    return -1;
-  else
-    return foo;
-}
diff -Naur ../../../dietlibc-0.34/lib/tcgetsid.c lib/tcgetsid.c
--- ../../../dietlibc-0.34/lib/tcgetsid.c	2004-08-04 01:28:46.000000000 +0300
+++ lib/tcgetsid.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <termios.h>
-#include <sys/ioctl.h>
-
-pid_t tcgetsid(int fildes) {
-  pid_t pid;
-  return ioctl(fildes, TIOCGSID, &pid)==-1?-1:pid;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/tcsendbreak.c lib/tcsendbreak.c
--- ../../../dietlibc-0.34/lib/tcsendbreak.c	2001-08-06 15:18:27.000000000 +0300
+++ lib/tcsendbreak.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include "dietfeatures.h"
-#include <errno.h>
-#include <termios.h>
-#include <sys/ioctl.h>
-
-int tcsendbreak (int fd,int duration)
-{
-  if (duration <= 0) return (ioctl (fd,TCSBRKP,0));
-  errno = EINVAL;
-  return (-1);
-}
diff -Naur ../../../dietlibc-0.34/lib/tcsetattr.c lib/tcsetattr.c
--- ../../../dietlibc-0.34/lib/tcsetattr.c	2002-01-11 20:06:53.000000000 +0200
+++ lib/tcsetattr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,37 +0,0 @@
-#include <termios.h>
-#include <sys/ioctl.h>
-#include <errno.h>
-#include "dietfeatures.h"
-
-#if !defined(__powerpc__) && !defined(__sparc__) && !defined(__alpha__) && !defined(__hppa__)
-#if TCSANOW==0 && TCSADRAIN==1 && TCSAFLUSH==2 && TCSETSW-TCSETS==1 && TCSETSF-TCSETS==2
-#define shortcut
-#endif
-#endif
-
-int  tcsetattr ( int fildes, int optional_actions, struct termios* termios_p )
-{
-#ifdef shortcut
-
-    if ( (unsigned int)optional_actions < 3u )
-        return ioctl ( fildes, TCSETS+optional_actions, termios_p );
-
-    errno = EINVAL;
-    return -1;
-
-#else
-
-    switch ( optional_actions ) {
-    case TCSANOW:
-        return ioctl ( fildes, TCSETS , termios_p );
-    case TCSADRAIN:
-        return ioctl ( fildes, TCSETSW, termios_p );
-    case TCSAFLUSH:
-        return ioctl ( fildes, TCSETSF, termios_p );
-    default:
-        errno = EINVAL;
-        return -1;
-    }
-    
-#endif    
-}
diff -Naur ../../../dietlibc-0.34/lib/tcsetpgrp.c lib/tcsetpgrp.c
--- ../../../dietlibc-0.34/lib/tcsetpgrp.c	2002-05-09 04:01:16.000000000 +0300
+++ lib/tcsetpgrp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <termios.h>
-#include <sys/ioctl.h>
-#include <unistd.h>
-
-int tcsetpgrp(int fildes, pid_t pgrpid)
-{
-  return ioctl(fildes, TIOCSPGRP, &pgrpid);
-}
diff -Naur ../../../dietlibc-0.34/lib/telldir.c lib/telldir.c
--- ../../../dietlibc-0.34/lib/telldir.c	2006-04-04 06:47:21.000000000 +0300
+++ lib/telldir.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include "dietdirent.h"
-#include <unistd.h>
-#include <dirent.h>
-
-off_t telldir(DIR *d) {
-  off_t result = 0;
-  if (lseek(d->fd,0,SEEK_CUR))
-    result=((struct dirent*)(d->buf+d->cur))->d_off;
-  return result;
-}
diff -Naur ../../../dietlibc-0.34/lib/thrd_create.c lib/thrd_create.c
--- ../../../dietlibc-0.34/lib/thrd_create.c	2018-02-10 20:27:23.000000000 +0200
+++ lib/thrd_create.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,73 +0,0 @@
-#define _LINUX_SOURCE
-#include <unistd.h>
-#include <threads.h>
-#include <sys/mman.h>
-#include <fcntl.h>
-#define _GNU_SOURCE
-#include <sched.h>
-#include "dietfeatures.h"
-#include <sys/tls.h>
-#include <stdio.h>
-#include <sys/random.h>
-
-extern thrd_t _thrd_root;
-extern size_t _thrd_stacksize;
-
-#ifdef WANT_TLS
-extern size_t __tdatasize, __tmemsize;
-extern void* __tdataptr;
-extern tcbhead_t* __tcb_mainthread;
-#else
-static const size_t __tmemsize=0,__tdatasize=0;
-#endif
-
-static int launch(void* p) {
-  thrd_t self=p;
-  thrd_exit(self->func(self->arg));
-  return 0;
-}
-
-int thrd_create(thrd_t *thr, thrd_start_t func, void *arg) {
-  size_t stacksize=_thrd_stacksize;	// capture value to prevent asynchronous changes to break us
-  char* stack=mmap(0,stacksize+4096+__tmemsize+sizeof(tcbhead_t)+sizeof(**thr),PROT_NONE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_STACK|MAP_GROWSDOWN,-1,0);
-  thrd_t t;
-  tcbhead_t* tcb;
-
-  if (stack==MAP_FAILED) return thrd_nomem;
-  if (mprotect(stack+4096,stacksize+__tmemsize+sizeof(tcbhead_t)+sizeof(**thr),PROT_READ|PROT_WRITE)) {
-    munmap(stack,stacksize+4096+__tmemsize+sizeof(tcbhead_t)+sizeof(**thr));
-    return thrd_error;
-  }
-  tcb=(tcbhead_t*)(stack+stacksize+4096+__tmemsize);
-  tcb->tcb=tcb;
-  tcb->dtv=0;
-  t=(thrd_t)(tcb+1);
-  tcb->self=t;
-  tcb->multiple_threads=1;
-#ifdef WANT_TLS
-  tcb->sysinfo=__tcb_mainthread->sysinfo;
-  if (getrandom(&tcb->stack_guard,sizeof(tcb->stack_guard),GRND_NONBLOCK) != sizeof(tcb->stack_guard))
-    tcb->stack_guard=__tcb_mainthread->stack_guard ^ gettid() ^ (uintptr_t)t;
-  __tcb_mainthread->multiple_threads=1;
-#endif
-  t->memstart=stack;
-  t->memsize=stacksize+4096+__tmemsize;
-  t->res=0;
-  t->func=func;
-  t->arg=arg;
-  t->flags=0;
-  t->join_futex=0;
-
-#ifdef WANT_TLS
-  memcpy(stack+stacksize+4096,__tdataptr,__tdatasize);
-  memset(stack+stacksize+4096+__tdatasize,0,__tmemsize-__tdatasize);
-#endif
-
-  t->tid=clone(launch,stack+4096+stacksize,CLONE_FILES|CLONE_FS|CLONE_IO|CLONE_PARENT|CLONE_SIGHAND|CLONE_SYSVSEM|CLONE_THREAD|CLONE_VM|CLONE_SETTLS|CLONE_PARENT_SETTID,t,&t->tid,stack+stacksize+4096+__tmemsize);
-  if (t->tid==-1) {
-    munmap(stack,stacksize+4096+__tmemsize+sizeof(tcbhead_t)+sizeof(**thr));
-    return thrd_error;
-  }
-  *thr=t;
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/thrd_current.c lib/thrd_current.c
--- ../../../dietlibc-0.34/lib/thrd_current.c	2014-03-16 00:18:58.000000000 +0200
+++ lib/thrd_current.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <sys/tls.h>
-#include <threads.h>
-
-thrd_t thrd_current(void) {
-  tcbhead_t* x=__get_cur_tcb();
-  if (x->multiple_threads==0) return NULL;
-  return (thrd_t)(x+1);
-}
diff -Naur ../../../dietlibc-0.34/lib/thrd_detach.c lib/thrd_detach.c
--- ../../../dietlibc-0.34/lib/thrd_detach.c	2014-03-16 00:18:58.000000000 +0200
+++ lib/thrd_detach.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <threads.h>
-#include <sys/tls.h>
-#include <sys/mman.h>
-
-int thrd_detach(thrd_t thr) {
-  int flags=thr->flags;
-  do {
-    if (flags&4) return thrd_error;
-    if (flags&2) {
-      munmap(thr->memstart+thr->memsize,sizeof(tcbhead_t)+sizeof(*thr));
-      return thrd_success;
-    }
-    if (flags&1) return thrd_success;
-    flags=__sync_val_compare_and_swap(&thr->flags,flags,flags|1);
-  } while (1);
-}
-
diff -Naur ../../../dietlibc-0.34/lib/thrd_exit.c lib/thrd_exit.c
--- ../../../dietlibc-0.34/lib/thrd_exit.c	2016-02-24 00:05:01.000000000 +0200
+++ lib/thrd_exit.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,63 +0,0 @@
-#define _REENTRANT
-#define _LINUX_SOURCE
-#include <threads.h>
-#include <unistd.h>
-#include <sys/futex.h>
-#include <sys/tls.h>
-#include <stdlib.h>
-#include <errno.h>
-
-extern void __munmap_and_exit(void* map,size_t len) __attribute__((noreturn));
-
-thread_local tss_t tss_dtor_list;
-
-void thrd_exit(int res) {
-  thrd_t t=thrd_current();
-  int flags;
-
-  size_t len;
-
-  while (tss_dtor_list) {
-    tss_t cur=tss_dtor_list;
-    tss_dtor_list=tss_dtor_list->next;
-    if (cur->dtor) cur->dtor(cur);
-  }
-  if (!t) exit(res);	// moron user called us when no threads are running
-  t->res=res;
-  if ((flags=__sync_fetch_and_or(&t->flags,4))&4) return;	// shouldn't be possible, but the tear-down-bit was already set
-  if (t->join_futex) {	// somebody is waiting; send him a message
-    t->join_wait_futex=0;
-    /* we need to wake the waiting threads up one by one, because we
-     * need to wait for all of them to have received our return value
-     * before we can self destruct. */
-    while (futex(&t->join_futex,FUTEX_WAKE,1,0,0,0)==1) {	// wake one waiting thread
-      // We woke somebody up.
-      // Give them time to read our exit code.
-      int r;
-      do {
-	r=futex(&t->join_wait_futex,FUTEX_WAIT,0,0,0,0);
-      } while (r==EINTR);
-      t->join_wait_futex=0;
-    }
-    flags|=1;	// mark as detached
-  }
-
-  len=t->memsize;
-  if (flags&1) {
-    // We are detached or somebody already thrd_join'ed us.
-    // We can die in piece and free all our resources
-    len += sizeof(tcbhead_t)+sizeof(*t);
-  } else {
-    // Tell thrd_join that we are dead and cleaned up our stack and it
-    // should clean up the rest when it's done.
-    __sync_fetch_and_or(&t->flags,2);
-    len&=~4095;	// round down to nearest page
-    t->arg=t->memstart+len;
-    t->memsize=t->memsize+sizeof(tcbhead_t)+sizeof(*t)-len;
-  }
-  /* Problem: we need to unmap the stack and call exit, but we can't
-   * touch the stack in between. Unfortunately, calling exit touches the
-   * stack. Returning from the munmap syscall also touches the stack. So
-   * this needs to be done in assembly language. */
-  __munmap_and_exit(t->memstart,len);
-}
diff -Naur ../../../dietlibc-0.34/lib/thrd_join.c lib/thrd_join.c
--- ../../../dietlibc-0.34/lib/thrd_join.c	2016-02-24 00:05:01.000000000 +0200
+++ lib/thrd_join.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,38 +0,0 @@
-#define _REENTRANT
-#include <threads.h>
-#include <sys/futex.h>
-#include <sys/mman.h>
-#include <sys/tls.h>
-#include <errno.h>
-
-int thrd_join(thrd_t thr, int* res) {
-  int flags=thr->flags;
-  int r;
-  while ((flags&6) == 4) {
-    /* if flags&4 then thrd_exit is already working on that thread.
-     * when it's done, it does flags|=2.
-     * so we wait for that. */
-    __sync_synchronize();
-    flags=thr->flags;
-  }
-  if ((flags&2)==0) {	/* is the thread still running? */
-    if (flags&5)
-      // thread is detached or in the process of being cleaned up, refuse join
-      return thrd_error;
-    if (!__sync_bool_compare_and_swap(&thr->join_futex,0,1))
-      // somebody is already calling thrd_join, refuse join
-      return thrd_error;
-    do {
-      r=futex(&thr->join_futex,FUTEX_WAIT,1,0,0,0);
-    } while (r==-1 && errno==EINTR);
-    if (res) *res=thr->res;
-    thr->join_wait_futex=1;
-    futex(&thr->join_wait_futex,FUTEX_WAKE,1,0,0,0);
-  } else {
-    /* thread is already dead, do cleanup */
-    if (res) *res=thr->res;
-    munmap(thr->arg,thr->memsize);
-  }
-  return thrd_success;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/thrd_root.c lib/thrd_root.c
--- ../../../dietlibc-0.34/lib/thrd_root.c	2014-03-16 00:18:58.000000000 +0200
+++ lib/thrd_root.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,4 +0,0 @@
-#include <threads.h>
-
-thrd_t _thrd_root;
-size_t _thrd_stacksize=16*1024;
diff -Naur ../../../dietlibc-0.34/lib/__time.c lib/__time.c
--- ../../../dietlibc-0.34/lib/__time.c	2011-03-03 20:54:54.000000000 +0200
+++ lib/__time.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,15 +0,0 @@
-#include <sys/time.h>
-#include <time.h>
-#include <syscalls.h>
-
-#ifndef __NR_time
-time_t time(time_t *t)
-{
-  struct timeval tv;
-  if (__unlikely(gettimeofday(&tv, NULL) < 0))
-    tv.tv_sec = -1;
-  if (t)
-    *t = tv.tv_sec;
-  return tv.tv_sec;
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/timerfd_create.c lib/timerfd_create.c
--- ../../../dietlibc-0.34/lib/timerfd_create.c	2008-02-19 02:28:13.000000000 +0200
+++ lib/timerfd_create.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <sys/timerfd.h>
-
-extern int __timerfd(int ufd, int clockid, int flags, const struct itimerspec *utmr);
-
-int timerfd_create (clockid_t __clock_id, int __flags) {
-  return __timerfd(-1,__clock_id,__flags,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/timingsafe_bcmp.c lib/timingsafe_bcmp.c
--- ../../../dietlibc-0.34/lib/timingsafe_bcmp.c	2015-09-30 16:41:18.000000000 +0300
+++ lib/timingsafe_bcmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include <string.h>
-
-int timingsafe_bcmp(const void* a,const void* b,size_t n) {
-  size_t i;
-  const unsigned char* x = a;
-  const unsigned char* y = b;
-  int r;
-  for (i=r=0; i<n; ++i)
-    r |= x[i] ^ y[i];	/* x[i]^y[i] is 0 iff x[i]==y[i] */
-  return !!r;	/* turn nonzero into 1 */
-}
diff -Naur ../../../dietlibc-0.34/lib/timingsafe_memcmp.c lib/timingsafe_memcmp.c
--- ../../../dietlibc-0.34/lib/timingsafe_memcmp.c	2015-09-30 16:41:18.000000000 +0300
+++ lib/timingsafe_memcmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,23 +0,0 @@
-#include <string.h>
-
-int timingsafe_memcmp(const void* a,const void* b,size_t n) {
-  /* slightly harder than bcmp because we want to know which one was
-   * smaller, not just if they did not match */
-  register const unsigned char *x=a;
-  register const unsigned char *y=b;
-  int r=0,done=0;
-  /* r is what we return in the end,
-   * done is there to be 0 or -1 so we can assign to r branchlessly */
-  size_t i;
-  for (i=0; i<n; ++i) {
-    int t=x[i]-y[i];
-    /* if t is nonzero, t|-t will have the sign bit set */
-    int minusone = (t|-t)>>(sizeof(int)-1);
-    /* if there is no mismatch, t is 0. Then r |= t is a no-op. */
-    /* if this is the first mismatch, we want to do r |= t. */
-    /* if this is not the first mismatch, we want to leave r alone. */
-    r |= t & ~done;
-    done |= minusone;
-  }
-  return r;
-}
diff -Naur ../../../dietlibc-0.34/lib/towlower.c lib/towlower.c
--- ../../../dietlibc-0.34/lib/towlower.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/towlower.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-wint_t towlower(wint_t c) {
-  if ( (unsigned int)(c - 'A') < 26u )
-    c += 'a' - 'A';
-  return c;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/towupper.c lib/towupper.c
--- ../../../dietlibc-0.34/lib/towupper.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/towupper.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wctype.h>
-
-wint_t towupper(wint_t c) {
-  if ( (unsigned int)(c - 'a') < 26u )
-    c += 'A' - 'a';
-  return c;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/__truncate64.c lib/__truncate64.c
--- ../../../dietlibc-0.34/lib/__truncate64.c	2002-10-21 16:02:06.000000000 +0300
+++ lib/__truncate64.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,23 +0,0 @@
-#include "dietfeatures.h"
-#include <errno.h>
-#ifdef WANT_LARGEFILE_BACKCOMPAT
-#include <sys/stat.h>
-#include "syscalls.h"
-#include <unistd.h>
-#ifndef __NO_STAT64
-#ifdef __NR_truncate64
-
-extern int __dietlibc_truncate64(const char* f, loff_t o);
-
-int truncate64(const char* f, loff_t o) {
-  int tmp;
-  if ((tmp=__dietlibc_truncate64(f,o))==-1) {
-    if (errno!=ENOSYS) return -1;
-    if (o>0x7fffffff) { errno=EOVERFLOW; return -1; }
-    return truncate(f,o);
-  }
-  return tmp;
-}
-#endif
-#endif
-#endif
diff -Naur ../../../dietlibc-0.34/lib/tss_create.c lib/tss_create.c
--- ../../../dietlibc-0.34/lib/tss_create.c	2014-03-20 14:08:11.000000000 +0200
+++ lib/tss_create.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#include <stdlib.h>
-#include <threads.h>
-
-extern thread_local tss_t tss_dtor_list;
-
-int tss_create(tss_t* tss_id, tss_dtor_t destructor) {
-  *tss_id=malloc(sizeof(**tss_id));
-  if (!*tss_id) return thrd_nomem;
-  (*tss_id)->dtor=destructor;
-  (*tss_id)->next=tss_dtor_list;
-  (*tss_id)->data=0;
-  tss_dtor_list=*tss_id;
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/tss_delete.c lib/tss_delete.c
--- ../../../dietlibc-0.34/lib/tss_delete.c	2014-03-20 14:08:11.000000000 +0200
+++ lib/tss_delete.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,14 +0,0 @@
-#include <threads.h>
-
-extern thread_local tss_t tss_dtor_list;
-
-void tss_delete(tss_t tss_id) {
-  tss_t* cur;
-  for (cur=&tss_dtor_list; *cur; cur=&((*cur)->next)) {
-    if (*cur==tss_id)
-      *cur=tss_id->next;
-  }
-  tss_id->dtor=0;
-  tss_id->data=0;
-  tss_id->next=0;
-}
diff -Naur ../../../dietlibc-0.34/lib/tss_get.c lib/tss_get.c
--- ../../../dietlibc-0.34/lib/tss_get.c	2014-03-20 14:08:11.000000000 +0200
+++ lib/tss_get.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,5 +0,0 @@
-#include <threads.h>
-
-void* tss_get(tss_t tss_id) {
-  return tss_id->data;
-}
diff -Naur ../../../dietlibc-0.34/lib/tss_set.c lib/tss_set.c
--- ../../../dietlibc-0.34/lib/tss_set.c	2014-03-20 14:08:11.000000000 +0200
+++ lib/tss_set.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <threads.h>
-
-int tss_set(tss_t tss_id, void* val) {
-  tss_id->data=val;
-  return thrd_success;
-}
diff -Naur ../../../dietlibc-0.34/lib/ttyname.c lib/ttyname.c
--- ../../../dietlibc-0.34/lib/ttyname.c	2002-02-24 00:18:42.000000000 +0200
+++ lib/ttyname.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,66 +0,0 @@
-#include "dietfeatures.h"
-#include <unistd.h>
-#include <sys/stat.h>
-#include <string.h>
-
-#ifdef __linux__
-
-#include <stdlib.h>
-
-char *ttyname(int fd) {
-#ifdef SLASH_PROC_OK
-  char ibuf[20];
-  static char obuf[20];
-  int len;
-  if (!isatty(fd)) return 0;
-  strcpy(ibuf,"/proc/self/fd/");
-  ibuf[__ltostr(ibuf+14,6,(unsigned long)fd,10,0)+14]=0;
-  if ((len=readlink(ibuf,obuf,sizeof(obuf)-1))<0) return 0;
-  obuf[len]=0;
-  return obuf;
-#else
-  static char buf[20];
-  struct stat s;
-  char *c=buf+8;
-  int n;
-  if (!isatty(fd)) return 0;
-  if (fstat(fd,&s)) return 0;
-  strcpy(buf,"/dev/tty");
-  if (S_ISCHR(s.st_mode)) {
-    n=minor(s.st_rdev);
-    switch (major(s.st_rdev)) {
-    case 4:
-      if (n>63) {
-	n-=64;
-	*c='S';
-	++c;
-      }
-num:
-      c[__ltostr(c,6,n,10,0)]=0;
-      break;
-    case 2:
-      buf[8]='p'-(n>>4);
-      buf[9]=n%4+'0';
-      if (buf[9]>'9') *c+='a'-'0';
-      buf[10]=0;
-      goto duh;
-    case 136:
-    case 137:
-    case 138:
-    case 139:
-      buf[7]='s';
-duh:
-      buf[5]='p';
-      n+=(major(s.st_rdev)-136)<<8;
-      *c='/'; ++c;
-      goto num;
-    default:
-      return 0;
-    }
-    return buf;
-  }
-  return 0;
-#endif
-}
-
-#endif
diff -Naur ../../../dietlibc-0.34/lib/__umount.c lib/__umount.c
--- ../../../dietlibc-0.34/lib/__umount.c	2011-03-03 20:40:05.000000000 +0200
+++ lib/__umount.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <sys/mount.h>
-#include "syscalls.h"
-
-#ifndef __NR_umount
-int umount(const char *target)
-{
-       return umount2(target, 0);
-}
-#endif
-
diff -Naur ../../../dietlibc-0.34/lib/uname.c lib/uname.c
--- ../../../dietlibc-0.34/lib/uname.c	1970-01-01 03:00:00.000000000 +0300
+++ lib/uname.c	2023-10-14 22:05:22.495036228 +0300
@@ -0,0 +1,17 @@
+
+#include <stdlib.h>
+#include <sys/utsname.h>
+#include <string.h>
+
+
+int uname(struct utsname *__name)
+{
+    if(!__name) return -1;
+
+    memset(__name, 9, sizeof(struct utsname));
+
+    strcpy(__name->sysname, "siemens");
+    strcpy(__name->machine, "armv5");
+
+    return 0;
+}
diff -Naur ../../../dietlibc-0.34/lib/usleep.c lib/usleep.c
--- ../../../dietlibc-0.34/lib/usleep.c	2002-02-23 22:33:51.000000000 +0200
+++ lib/usleep.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,12 +0,0 @@
-#include <time.h>
-#include <unistd.h>
-
-/* nano * 1000 == usecs
- * usecs * 1000 == msecs
- * msecs * 1000 = secs */
-int usleep(unsigned long usecs) {
-  struct timespec t;
-  t.tv_sec=usecs/1000000;
-  t.tv_nsec=(usecs%1000000)*1000;
-  return nanosleep(&t,&t);
-}
diff -Naur ../../../dietlibc-0.34/lib/__utime.c lib/__utime.c
--- ../../../dietlibc-0.34/lib/__utime.c	2014-04-19 18:07:34.000000000 +0300
+++ lib/__utime.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,20 +0,0 @@
-#include <syscalls.h>
-#define _BSD_SOURCE
-#include <utime.h>
-#include <sys/time.h>
-
-#ifndef __NR_utime
-int utime(const char *filename, const struct utimbuf *times)
-{
-  if (times == NULL)
-    return utimes(filename, NULL);
-  else {
-    struct timeval tvs[2];
-    tvs[0].tv_sec  = times->actime;
-    tvs[0].tv_usec = 0;
-    tvs[1].tv_sec  = times->modtime;
-    tvs[1].tv_usec = 0;
-    return utimes(filename, tvs);
-  }
-}
-#endif
diff -Naur ../../../dietlibc-0.34/lib/vdso_dlsym.c lib/vdso_dlsym.c
--- ../../../dietlibc-0.34/lib/vdso_dlsym.c	2012-03-08 10:44:15.000000000 +0200
+++ lib/vdso_dlsym.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,75 +0,0 @@
-#include <inttypes.h>
-#include <stdint.h>
-#include <stdio.h>
-#include <sys/time.h>
-#include <stdlib.h>
-
-#include <elf.h>
-
-#include "internal.h"
-
-#if (__WORDSIZE == 64)
-
-#define phdr Elf64_Phdr
-#define ehdr Elf64_Ehdr
-#define shdr Elf64_Shdr
-#define sym Elf64_Sym
-
-#else
-
-#define phdr Elf32_Phdr
-#define ehdr Elf32_Ehdr
-#define shdr Elf32_Shdr
-#define sym Elf32_Sym
-
-#endif
-
-const void* vdso_dlsym(const char* elfimage,const char* symbol) {
-  /* WARNING: this does NO validation AT ALL. */
-  /* It is meant to be used on the VDSO ELF .so mapped into user space
-   * by the kernel.  Since the kernel gave it to us, it is trustworthy.
-   * A real dlsym would have to check all the pointers and offsets
-   * against the file and section sizes, obviously. */
-  const ehdr* eh=(ehdr*)elfimage;
-  const char* dynstringtable=0;
-
-  {
-    size_t i;
-    /* first traverse the section list to find ".dynstr"
-     * we need the offset of .dynstr because the names in the symbol
-     * list are given as offsets inside .dynstr */
-    for (i=0; i<eh->e_shnum; ++i) {
-      const shdr* sh=(shdr*)(elfimage + eh->e_shoff + i*eh->e_shentsize);
-      if (sh->sh_type==3 && (sh->sh_flags&2)) {	// type SHT_STRTAB and flags has SHF_ALLOC
-	dynstringtable = elfimage + sh->sh_offset;
-	break;
-      }
-    }
-  }
-
-  /* now traverse .dynsym */
-  if (dynstringtable) {
-    size_t i;
-    for (i=0; i<eh->e_shnum; ++i) {
-      const shdr* sh=(shdr*)(elfimage + eh->e_shoff + i*eh->e_shentsize);
-      if (sh->sh_type==11) {
-	size_t j;
-//	printf(".dynsym @ %p\n",vdso + sh->sh_offset);
-	for (j=0; j*sh->sh_entsize < sh->sh_size; ++j) {
-	  const sym* es=(sym*)(elfimage + sh->sh_offset + j*sh->sh_entsize);
-//	  printf("%p: %s\n",((shdr*)(elfimage + eh->e_shoff + es->st_shndx * eh->e_shentsize))->sh-offset + es->st_value-eh->e_entry, dynstringtable+es->st_name);
-	  if (!strcmp(dynstringtable+es->st_name,symbol)) {
-	    const shdr* sec=(shdr*)(elfimage + eh->e_shoff + es->st_shndx*eh->e_shentsize);
-	    size_t ofs=es->st_value-sec->sh_addr+sec->sh_offset;
-//	    if (ofs>sec->sh_size) return 0;
-//	    printf("found symbol \"%s\" at offset %p\n",dynstringtable+es->st_name,es->st_value);
-	    return elfimage + ofs;
-	  }
-	}
-      }
-      sh = (shdr*)((char*)sh + eh->e_shentsize);
-    }
-  }
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/vfork.c lib/vfork.c
--- ../../../dietlibc-0.34/lib/vfork.c	2002-05-17 15:35:34.000000000 +0300
+++ lib/vfork.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,4 +0,0 @@
-#include <unistd.h>
-
-pid_t vfork() { return fork(); }
-
diff -Naur ../../../dietlibc-0.34/lib/__v_printf.c lib/__v_printf.c
--- ../../../dietlibc-0.34/lib/__v_printf.c	2018-02-01 04:03:39.000000000 +0200
+++ lib/__v_printf.c	2023-10-19 03:41:29.556843155 +0300
@@ -10,6 +10,8 @@
 
 #define MAX_WIDTH 10*1024
 
+int __isnan(double d);
+
 static inline unsigned long skip_to(const char *format) {
   unsigned long nr;
   for (nr=0; format[nr] && (format[nr]!='%'); ++nr);
@@ -375,7 +377,7 @@
 
 	  sz=__dtostr(d,s,sizeof(buf)-1,width,preci,flags);
 
-	  if (!isnan(d) && !isinf(d)) {		/* skip NaN + INF values */
+	  if (!__isnan(d) && !isinf(d)) {		/* skip NaN + INF values */
 	    if (flag_dot) {
 	      char *tmp;
 	      if ((tmp=strchr(s,'.'))) {
@@ -424,4 +426,6 @@
   return len;
 }
 
+#if 0
 link_warning("__v_printf","warning: the printf functions add several kilobytes of bloat.")
+#endif
diff -Naur ../../../dietlibc-0.34/lib/__v_scanf.c lib/__v_scanf.c
--- ../../../dietlibc-0.34/lib/__v_scanf.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/__v_scanf.c	2023-10-15 17:05:34.780183822 +0300
@@ -115,13 +115,10 @@
 	case 'X':
 	case 'x':
 	  _div+=6;
-	  /* fall through */
 	case 'd':
 	  _div+=2;
-	  /* fall through */
 	case 'o':
 	  _div+=8;
-	  /* fall through */
 	case 'u':
 	case 'i':
 	  {
@@ -341,7 +338,6 @@
 	    char cset[256];
 	    int flag_not=0;
 	    int flag_dash=0;
-	    int matched=0;
 	    memset(cset,0,sizeof(cset));
 	    ch=*format++;
 	    /* first char specials */
@@ -372,19 +368,18 @@
 	    else cset[ch]=1;
 
 	    /* like %c or %s */
-	    if (!flag_discard)
+	    if (!flag_discard) {
 	      s=(char *)va_arg(arg_ptr,char*);
+	      ++n;
+	    }
 	    while (width && (tpch>=0) && (cset[tpch]^flag_not)) {
 	      if (!flag_discard) *s=tpch;
 	      if (tpch) ++s; else break;
 	      --width;
 	      tpch=A_GETC(fn);
-	      matched=1;
 	    }
 	    if (!flag_discard) *s=0;
 	    ++format;
-	    if (matched && !flag_discard)
-	      ++n;
 	  }
 	  break;
 #endif
@@ -417,4 +412,6 @@
   return n;
 }
 
+#ifdef __NEED_WARNING
 link_warning("__v_scanf","warning: the scanf functions add several kilobytes of bloat.");
+#endif
diff -Naur ../../../dietlibc-0.34/lib/vsnprintf.c lib/vsnprintf.c
--- ../../../dietlibc-0.34/lib/vsnprintf.c	2018-05-05 03:30:21.000000000 +0300
+++ lib/vsnprintf.c	2023-10-14 22:05:22.491036121 +0300
@@ -11,8 +11,7 @@
   size_t size;
 };
 
-static int swrite(const void*ptr, size_t nmemb, void* cookie) {
-  struct str_data* sd=cookie;
+static int swrite(void*ptr, size_t nmemb, struct str_data* sd) {
   size_t tmp=sd->size-sd->len;
   if (tmp>0) {
     size_t len=nmemb;
@@ -29,7 +28,7 @@
 int vsnprintf(char* str, size_t size, const char *format, va_list arg_ptr) {
   int n;
   struct str_data sd = { str, 0, size?size-1:0 };
-  struct arg_printf ap = { &sd, swrite };
+  struct arg_printf ap = { &sd, (int(*)(void*,size_t,void*)) swrite };
   n=__v_printf(&ap,format,arg_ptr);
   if (str && size && n>=0) {
     if (size!=(size_t)-1 && ((size_t)n>=size)) str[size-1]=0;
diff -Naur ../../../dietlibc-0.34/lib/vsprintf.c lib/vsprintf.c
--- ../../../dietlibc-0.34/lib/vsprintf.c	2017-05-03 00:41:27.000000000 +0300
+++ lib/vsprintf.c	2023-10-14 22:05:22.495036228 +0300
@@ -6,7 +6,9 @@
 
 int vsprintf(char *dest,const char *format, va_list arg_ptr)
 {
-  return vsnprintf(dest,(size_t)-1-(uintptr_t)dest,format,arg_ptr);
+  return vsnprintf(dest,(size_t)-1,format,arg_ptr);
 }
 
+#ifdef __NEED_WARNING
 link_warning("vsprintf","warning: Avoid *sprintf; use *snprintf. It is more secure.")
+#endif
diff -Naur ../../../dietlibc-0.34/lib/wait3.c lib/wait3.c
--- ../../../dietlibc-0.34/lib/wait3.c	2005-03-15 10:51:22.000000000 +0200
+++ lib/wait3.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,5 +0,0 @@
-#include <sys/wait.h>
-
-pid_t wait3(int* status,int opts,struct rusage* rusage) {
-  return wait4(-1,status,opts,rusage);
-}
diff -Naur ../../../dietlibc-0.34/lib/wait.c lib/wait.c
--- ../../../dietlibc-0.34/lib/wait.c	2001-01-09 19:57:43.000000000 +0200
+++ lib/wait.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <sys/types.h>
-#include <sys/wait.h>
-
-pid_t wait(int *status) {
-  return waitpid(-1,status,0);
-}
diff -Naur ../../../dietlibc-0.34/lib/wcrtomb.c lib/wcrtomb.c
--- ../../../dietlibc-0.34/lib/wcrtomb.c	2010-03-15 00:53:03.000000000 +0200
+++ lib/wcrtomb.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,36 +0,0 @@
-#include <wchar.h>
-#include "dietlocale.h"
-
-static mbstate_t internal;
-
-size_t wcrtomb(char *s, wchar_t wc, mbstate_t *ps) {
-  if (!ps) ps=&internal;
-  switch (lc_ctype) {
-  case CT_8BIT:
-    if (!s) return 0;
-    *s=wc;
-    return 1;
-  case CT_UTF8:
-    if (!s) return (wc>=0x80);
-    {
-      char c;
-      unsigned int bits,j,k;
-      if (wc>=0x04000000) { bits=30; c=0xFC; j=6; } else
-      if (wc>=0x00200000) { bits=24; c=0xF8; j=5; } else
-      if (wc>=0x00010000) { bits=18; c=0xF0; j=4; } else
-      if (wc>=0x00000800) { bits=12; c=0xE0; j=3; } else
-      if (wc>=0x00000080) { bits=6; c=0xC0; j=2; } else
-			{ *s=wc; return 1; }
-      c |= (unsigned char)(wc>>bits);
-      if (s) {
-	*s=c;
-	for (k=1; k<j; ++k) {
-	  bits-=6;
-	  s[k]=0x80+((wc>>bits)&0x3f);
-	}
-      }
-      return j;
-    }
-  }
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcscat.c lib/wcscat.c
--- ../../../dietlibc-0.34/lib/wcscat.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/wcscat.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wchar.h>
-
-wchar_t* wcscat(wchar_t *__restrict__ dest, const wchar_t *__restrict__ src) {
-  wchar_t* orig=dest;
-  for (; *dest; ++dest) ;	/* go to end of dest */
-  for (; (*dest=*src); ++src,++dest) ;	/* then append from src */
-  return orig;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcschr.c lib/wcschr.c
--- ../../../dietlibc-0.34/lib/wcschr.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/wcschr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wchar.h>
-
-wchar_t* wcschr(const wchar_t *wcs, wchar_t wc) {
-  for (; *wcs; ++wcs)
-    if (*wcs == wc)
-      return (wchar_t*)wcs;
-  return 0;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcscmp.c lib/wcscmp.c
--- ../../../dietlibc-0.34/lib/wcscmp.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/wcscmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <wchar.h>
-
-int wcscmp(const wchar_t* a,const wchar_t* b) {
-  while (*a && *a == *b)
-    a++, b++;
-  return (*a - *b);
-}
-
-int wcscoll(const wchar_t *s,const wchar_t* t)       __attribute__((weak,alias("wcscmp")));
diff -Naur ../../../dietlibc-0.34/lib/wcscpy.c lib/wcscpy.c
--- ../../../dietlibc-0.34/lib/wcscpy.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/wcscpy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <wchar.h>
-
-wchar_t* wcscpy(wchar_t *__restrict__ dest, const wchar_t *__restrict__ src) {
-  wchar_t* orig=dest;
-  for (; (*dest=*src); ++src,++dest) ;
-  return orig;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcslen.c lib/wcslen.c
--- ../../../dietlibc-0.34/lib/wcslen.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/wcslen.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <wchar.h>
-
-size_t wcslen(const wchar_t* s) {
-  size_t i;
-  for (i=0; s[i]; ++i) ;
-  return i;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcsncat.c lib/wcsncat.c
--- ../../../dietlibc-0.34/lib/wcsncat.c	2007-10-04 16:58:29.000000000 +0300
+++ lib/wcsncat.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <wchar.h>
-
-wchar_t* wcsncat(wchar_t *__restrict__ dest, const wchar_t *__restrict__ src,size_t n) {
-  wchar_t* orig=dest;
-  size_t i;
-  while (*dest) ++dest;
-  for (i=0; i<n && src[i]; ++i) dest[i]=src[i];
-  dest[i]=0;
-  return orig;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcsncmp.c lib/wcsncmp.c
--- ../../../dietlibc-0.34/lib/wcsncmp.c	2010-03-15 01:03:28.000000000 +0200
+++ lib/wcsncmp.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,7 +0,0 @@
-#include <wchar.h>
-
-int wcsncmp(const wchar_t *s1, const wchar_t *s2, size_t n) {
-  size_t i;
-  for (i=0; i<n && s1[i]==s2[i]; ++i) ;
-  return s1[i]-s2[i];
-}
diff -Naur ../../../dietlibc-0.34/lib/wcsncpy.c lib/wcsncpy.c
--- ../../../dietlibc-0.34/lib/wcsncpy.c	2007-10-04 16:58:29.000000000 +0300
+++ lib/wcsncpy.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,8 +0,0 @@
-#include <wchar.h>
-
-wchar_t* wcsncpy(wchar_t *__restrict__ dest, const wchar_t *__restrict__ src,size_t n) {
-  wchar_t* orig=dest;
-  for (; dest<orig+n && (*dest=*src); ++src,++dest) ;
-  for (; dest<orig+n; ++dest) *dest=0;
-  return orig;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcsrchr.c lib/wcsrchr.c
--- ../../../dietlibc-0.34/lib/wcsrchr.c	2005-07-15 21:34:03.000000000 +0300
+++ lib/wcsrchr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,9 +0,0 @@
-#include <wchar.h>
-
-wchar_t* wcsrchr(const wchar_t *wcs, wchar_t wc) {
-  wchar_t* last=0;
-  for (; *wcs; ++wcs)
-    if (*wcs == wc)
-      last=(wchar_t*)wcs;
-  return last;
-}
diff -Naur ../../../dietlibc-0.34/lib/wcsrtombs.c lib/wcsrtombs.c
--- ../../../dietlibc-0.34/lib/wcsrtombs.c	2015-04-11 07:26:28.000000000 +0300
+++ lib/wcsrtombs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,36 +0,0 @@
-#include <stdlib.h>
-#include <wchar.h>
-#include "dietlocale.h"
-#include <wchar.h>
-#include <errno.h>
-#include <string.h>
-
-size_t wcsrtombs(char *dest, const wchar_t **src, size_t len, mbstate_t *ps) {
-  wchar_t c;
-  char buf[MB_CUR_MAX];
-  size_t cur;
-  if (!src || !*src) {
-inval:
-    errno=EINVAL;
-    return -1;
-  }
-  if (!dest) {
-    len=-1;
-  }
-  for (cur=0; (c=**src); ++*src) {
-    size_t n;
-    char* s=__likely(len-cur>=MB_CUR_MAX)?(dest?dest+cur:NULL):buf;
-    n=wcrtomb(s,c,ps);
-    if (n==(size_t)-1) return -1;
-    if (dest && s==buf) {
-      /* check if we fit */
-      if (len<n) return cur;
-      memcpy(dest+cur,buf,n);
-    }
-    cur+=n;
-  }
-  if (dest && len>cur) dest[cur]=0;
-keinplatz:
-  return cur;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/wcsstr.c lib/wcsstr.c
--- ../../../dietlibc-0.34/lib/wcsstr.c	2007-10-08 17:23:59.000000000 +0300
+++ lib/wcsstr.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,11 +0,0 @@
-#include <wchar.h>
-
-wchar_t *wcsstr(const wchar_t *haystack, const wchar_t *needle) {
-  size_t i,j;
-  for (i=0; haystack[i]; ++i) {
-    for (j=0; haystack[i+j]==needle[j]; ++j) ;
-    if (!needle[j]) return (wchar_t*)haystack+i;
-  }
-  return 0;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/wcstombs.c lib/wcstombs.c
--- ../../../dietlibc-0.34/lib/wcstombs.c	2011-03-03 19:33:16.000000000 +0200
+++ lib/wcstombs.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,10 +0,0 @@
-#include <wchar.h>
-#include "dietlocale.h"
-#include <wchar.h>
-#include <errno.h>
-#include <string.h>
-#include <stdlib.h>
-
-size_t wcstombs(char *dest, const wchar_t *src, size_t len) {
-  return wcsrtombs(dest,&src,len,NULL);
-}
diff -Naur ../../../dietlibc-0.34/lib/wcswidth.c lib/wcswidth.c
--- ../../../dietlibc-0.34/lib/wcswidth.c	2010-08-27 22:38:45.000000000 +0300
+++ lib/wcswidth.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,77 +0,0 @@
-#define _XOPEN_SOURCE
-#include <wchar.h>
-
-/*
- * This is an implementation of wcwidth() and wcswidth() (defined in
- * IEEE Std 1002.1-2001) for Unicode.
- *
- * http://www.opengroup.org/onlinepubs/007904975/functions/wcwidth.html
- * http://www.opengroup.org/onlinepubs/007904975/functions/wcswidth.html
- *
- * In fixed-width output devices, Latin characters all occupy a single
- * "cell" position of equal width, whereas ideographic CJK characters
- * occupy two such cells. Interoperability between terminal-line
- * applications and (teletype-style) character terminals using the
- * UTF-8 encoding requires agreement on which character should advance
- * the cursor by how many cell positions. No established formal
- * standards exist at present on which Unicode character shall occupy
- * how many cell positions on character terminals. These routines are
- * a first attempt of defining such behavior based on simple rules
- * applied to data provided by the Unicode Consortium.
- *
- * For some graphical characters, the Unicode standard explicitly
- * defines a character-cell width via the definition of the East Asian
- * FullWidth (F), Wide (W), Half-width (H), and Narrow (Na) classes.
- * In all these cases, there is no ambiguity about which width a
- * terminal shall use. For characters in the East Asian Ambiguous (A)
- * class, the width choice depends purely on a preference of backward
- * compatibility with either historic CJK or Western practice.
- * Choosing single-width for these characters is easy to justify as
- * the appropriate long-term solution, as the CJK practice of
- * displaying these characters as double-width comes from historic
- * implementation simplicity (8-bit encoded characters were displayed
- * single-width and 16-bit ones double-width, even for Greek,
- * Cyrillic, etc.) and not any typographic considerations.
- *
- * Much less clear is the choice of width for the Not East Asian
- * (Neutral) class. Existing practice does not dictate a width for any
- * of these characters. It would nevertheless make sense
- * typographically to allocate two character cells to characters such
- * as for instance EM SPACE or VOLUME INTEGRAL, which cannot be
- * represented adequately with a single-width glyph. The following
- * routines at present merely assign a single-cell width to all
- * neutral characters, in the interest of simplicity. This is not
- * entirely satisfactory and should be reconsidered before
- * establishing a formal standard in this area. At the moment, the
- * decision which Not East Asian (Neutral) characters should be
- * represented by double-width glyphs cannot yet be answered by
- * applying a simple rule from the Unicode database content. Setting
- * up a proper standard for the behavior of UTF-8 character terminals
- * will require a careful analysis not only of each Unicode character,
- * but also of each presentation form, something the author of these
- * routines has avoided to do so far.
- *
- * http://www.unicode.org/unicode/reports/tr11/
- *
- * Markus Kuhn -- 2007-05-26 (Unicode 5.0)
- *
- * Permission to use, copy, modify, and distribute this software
- * for any purpose and without fee is hereby granted. The author
- * disclaims all warranties with regard to this software.
- *
- * Latest version: http://www.cl.cam.ac.uk/~mgk25/ucs/wcwidth.c
- */
-
-int wcswidth(const wchar_t *pwcs, size_t n)
-{
-  int w, width = 0;
-
-  for (;*pwcs && n-- > 0; pwcs++)
-    if ((w = wcwidth(*pwcs)) < 0)
-      return -1;
-    else
-      width += w;
-
-  return width;
-}
-
diff -Naur ../../../dietlibc-0.34/lib/wctomb.c lib/wctomb.c
--- ../../../dietlibc-0.34/lib/wctomb.c	2007-09-09 04:37:54.000000000 +0300
+++ lib/wctomb.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,6 +0,0 @@
-#include <stdlib.h>
-#include <wchar.h>
-
-int wctomb(char *pwc, wchar_t s) {
-  return wcrtomb(pwc,s,NULL);
-}
diff -Naur ../../../dietlibc-0.34/lib/wcwidth.c lib/wcwidth.c
--- ../../../dietlibc-0.34/lib/wcwidth.c	2010-08-27 22:38:45.000000000 +0300
+++ lib/wcwidth.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,208 +0,0 @@
-#define _XOPEN_SOURCE
-#include <wchar.h>
-
-/*
- * This is an implementation of wcwidth() and wcswidth() (defined in
- * IEEE Std 1002.1-2001) for Unicode.
- *
- * http://www.opengroup.org/onlinepubs/007904975/functions/wcwidth.html
- * http://www.opengroup.org/onlinepubs/007904975/functions/wcswidth.html
- *
- * In fixed-width output devices, Latin characters all occupy a single
- * "cell" position of equal width, whereas ideographic CJK characters
- * occupy two such cells. Interoperability between terminal-line
- * applications and (teletype-style) character terminals using the
- * UTF-8 encoding requires agreement on which character should advance
- * the cursor by how many cell positions. No established formal
- * standards exist at present on which Unicode character shall occupy
- * how many cell positions on character terminals. These routines are
- * a first attempt of defining such behavior based on simple rules
- * applied to data provided by the Unicode Consortium.
- *
- * For some graphical characters, the Unicode standard explicitly
- * defines a character-cell width via the definition of the East Asian
- * FullWidth (F), Wide (W), Half-width (H), and Narrow (Na) classes.
- * In all these cases, there is no ambiguity about which width a
- * terminal shall use. For characters in the East Asian Ambiguous (A)
- * class, the width choice depends purely on a preference of backward
- * compatibility with either historic CJK or Western practice.
- * Choosing single-width for these characters is easy to justify as
- * the appropriate long-term solution, as the CJK practice of
- * displaying these characters as double-width comes from historic
- * implementation simplicity (8-bit encoded characters were displayed
- * single-width and 16-bit ones double-width, even for Greek,
- * Cyrillic, etc.) and not any typographic considerations.
- *
- * Much less clear is the choice of width for the Not East Asian
- * (Neutral) class. Existing practice does not dictate a width for any
- * of these characters. It would nevertheless make sense
- * typographically to allocate two character cells to characters such
- * as for instance EM SPACE or VOLUME INTEGRAL, which cannot be
- * represented adequately with a single-width glyph. The following
- * routines at present merely assign a single-cell width to all
- * neutral characters, in the interest of simplicity. This is not
- * entirely satisfactory and should be reconsidered before
- * establishing a formal standard in this area. At the moment, the
- * decision which Not East Asian (Neutral) characters should be
- * represented by double-width glyphs cannot yet be answered by
- * applying a simple rule from the Unicode database content. Setting
- * up a proper standard for the behavior of UTF-8 character terminals
- * will require a careful analysis not only of each Unicode character,
- * but also of each presentation form, something the author of these
- * routines has avoided to do so far.
- *
- * http://www.unicode.org/unicode/reports/tr11/
- *
- * Markus Kuhn -- 2007-05-26 (Unicode 5.0)
- *
- * Permission to use, copy, modify, and distribute this software
- * for any purpose and without fee is hereby granted. The author
- * disclaims all warranties with regard to this software.
- *
- * Latest version: http://www.cl.cam.ac.uk/~mgk25/ucs/wcwidth.c
- */
-
-#include <wchar.h>
-
-struct interval {
-  int first;
-  int last;
-};
-
-/* auxiliary function for binary search in interval table */
-static int bisearch(wchar_t ucs, const struct interval *table, int max) {
-  int min = 0;
-  int mid;
-
-  if (ucs < table[0].first || ucs > table[max].last)
-    return 0;
-  while (max >= min) {
-    mid = (min + max) / 2;
-    if (ucs > table[mid].last)
-      min = mid + 1;
-    else if (ucs < table[mid].first)
-      max = mid - 1;
-    else
-      return 1;
-  }
-
-  return 0;
-}
-
-
-/* The following two functions define the column width of an ISO 10646
- * character as follows:
- *
- *    - The null character (U+0000) has a column width of 0.
- *
- *    - Other C0/C1 control characters and DEL will lead to a return
- *      value of -1.
- *
- *    - Non-spacing and enclosing combining characters (general
- *      category code Mn or Me in the Unicode database) have a
- *      column width of 0.
- *
- *    - SOFT HYPHEN (U+00AD) has a column width of 1.
- *
- *    - Other format characters (general category code Cf in the Unicode
- *      database) and ZERO WIDTH SPACE (U+200B) have a column width of 0.
- *
- *    - Hangul Jamo medial vowels and final consonants (U+1160-U+11FF)
- *      have a column width of 0.
- *
- *    - Spacing characters in the East Asian Wide (W) or East Asian
- *      Full-width (F) category as defined in Unicode Technical
- *      Report #11 have a column width of 2.
- *
- *    - All remaining characters (including all printable
- *      ISO 8859-1 and WGL4 characters, Unicode control characters,
- *      etc.) have a column width of 1.
- *
- * This implementation assumes that wchar_t characters are encoded
- * in ISO 10646.
- */
-
-int wcwidth(wchar_t ucs)
-{
-  /* sorted list of non-overlapping intervals of non-spacing characters */
-  /* generated by "uniset +cat=Me +cat=Mn +cat=Cf -00AD +1160-11FF +200B c" */
-  static const struct interval combining[] = {
-    { 0x0300, 0x036F }, { 0x0483, 0x0486 }, { 0x0488, 0x0489 },
-    { 0x0591, 0x05BD }, { 0x05BF, 0x05BF }, { 0x05C1, 0x05C2 },
-    { 0x05C4, 0x05C5 }, { 0x05C7, 0x05C7 }, { 0x0600, 0x0603 },
-    { 0x0610, 0x0615 }, { 0x064B, 0x065E }, { 0x0670, 0x0670 },
-    { 0x06D6, 0x06E4 }, { 0x06E7, 0x06E8 }, { 0x06EA, 0x06ED },
-    { 0x070F, 0x070F }, { 0x0711, 0x0711 }, { 0x0730, 0x074A },
-    { 0x07A6, 0x07B0 }, { 0x07EB, 0x07F3 }, { 0x0901, 0x0902 },
-    { 0x093C, 0x093C }, { 0x0941, 0x0948 }, { 0x094D, 0x094D },
-    { 0x0951, 0x0954 }, { 0x0962, 0x0963 }, { 0x0981, 0x0981 },
-    { 0x09BC, 0x09BC }, { 0x09C1, 0x09C4 }, { 0x09CD, 0x09CD },
-    { 0x09E2, 0x09E3 }, { 0x0A01, 0x0A02 }, { 0x0A3C, 0x0A3C },
-    { 0x0A41, 0x0A42 }, { 0x0A47, 0x0A48 }, { 0x0A4B, 0x0A4D },
-    { 0x0A70, 0x0A71 }, { 0x0A81, 0x0A82 }, { 0x0ABC, 0x0ABC },
-    { 0x0AC1, 0x0AC5 }, { 0x0AC7, 0x0AC8 }, { 0x0ACD, 0x0ACD },
-    { 0x0AE2, 0x0AE3 }, { 0x0B01, 0x0B01 }, { 0x0B3C, 0x0B3C },
-    { 0x0B3F, 0x0B3F }, { 0x0B41, 0x0B43 }, { 0x0B4D, 0x0B4D },
-    { 0x0B56, 0x0B56 }, { 0x0B82, 0x0B82 }, { 0x0BC0, 0x0BC0 },
-    { 0x0BCD, 0x0BCD }, { 0x0C3E, 0x0C40 }, { 0x0C46, 0x0C48 },
-    { 0x0C4A, 0x0C4D }, { 0x0C55, 0x0C56 }, { 0x0CBC, 0x0CBC },
-    { 0x0CBF, 0x0CBF }, { 0x0CC6, 0x0CC6 }, { 0x0CCC, 0x0CCD },
-    { 0x0CE2, 0x0CE3 }, { 0x0D41, 0x0D43 }, { 0x0D4D, 0x0D4D },
-    { 0x0DCA, 0x0DCA }, { 0x0DD2, 0x0DD4 }, { 0x0DD6, 0x0DD6 },
-    { 0x0E31, 0x0E31 }, { 0x0E34, 0x0E3A }, { 0x0E47, 0x0E4E },
-    { 0x0EB1, 0x0EB1 }, { 0x0EB4, 0x0EB9 }, { 0x0EBB, 0x0EBC },
-    { 0x0EC8, 0x0ECD }, { 0x0F18, 0x0F19 }, { 0x0F35, 0x0F35 },
-    { 0x0F37, 0x0F37 }, { 0x0F39, 0x0F39 }, { 0x0F71, 0x0F7E },
-    { 0x0F80, 0x0F84 }, { 0x0F86, 0x0F87 }, { 0x0F90, 0x0F97 },
-    { 0x0F99, 0x0FBC }, { 0x0FC6, 0x0FC6 }, { 0x102D, 0x1030 },
-    { 0x1032, 0x1032 }, { 0x1036, 0x1037 }, { 0x1039, 0x1039 },
-    { 0x1058, 0x1059 }, { 0x1160, 0x11FF }, { 0x135F, 0x135F },
-    { 0x1712, 0x1714 }, { 0x1732, 0x1734 }, { 0x1752, 0x1753 },
-    { 0x1772, 0x1773 }, { 0x17B4, 0x17B5 }, { 0x17B7, 0x17BD },
-    { 0x17C6, 0x17C6 }, { 0x17C9, 0x17D3 }, { 0x17DD, 0x17DD },
-    { 0x180B, 0x180D }, { 0x18A9, 0x18A9 }, { 0x1920, 0x1922 },
-    { 0x1927, 0x1928 }, { 0x1932, 0x1932 }, { 0x1939, 0x193B },
-    { 0x1A17, 0x1A18 }, { 0x1B00, 0x1B03 }, { 0x1B34, 0x1B34 },
-    { 0x1B36, 0x1B3A }, { 0x1B3C, 0x1B3C }, { 0x1B42, 0x1B42 },
-    { 0x1B6B, 0x1B73 }, { 0x1DC0, 0x1DCA }, { 0x1DFE, 0x1DFF },
-    { 0x200B, 0x200F }, { 0x202A, 0x202E }, { 0x2060, 0x2063 },
-    { 0x206A, 0x206F }, { 0x20D0, 0x20EF }, { 0x302A, 0x302F },
-    { 0x3099, 0x309A }, { 0xA806, 0xA806 }, { 0xA80B, 0xA80B },
-    { 0xA825, 0xA826 }, { 0xFB1E, 0xFB1E }, { 0xFE00, 0xFE0F },
-    { 0xFE20, 0xFE23 }, { 0xFEFF, 0xFEFF }, { 0xFFF9, 0xFFFB },
-    { 0x10A01, 0x10A03 }, { 0x10A05, 0x10A06 }, { 0x10A0C, 0x10A0F },
-    { 0x10A38, 0x10A3A }, { 0x10A3F, 0x10A3F }, { 0x1D167, 0x1D169 },
-    { 0x1D173, 0x1D182 }, { 0x1D185, 0x1D18B }, { 0x1D1AA, 0x1D1AD },
-    { 0x1D242, 0x1D244 }, { 0xE0001, 0xE0001 }, { 0xE0020, 0xE007F },
-    { 0xE0100, 0xE01EF }
-  };
-
-  /* test for 8-bit control characters */
-  if (ucs == 0)
-    return 0;
-  if (ucs < 32 || (ucs >= 0x7f && ucs < 0xa0))
-    return -1;
-
-  /* binary search in table of non-spacing characters */
-  if (bisearch(ucs, combining,
-	       sizeof(combining) / sizeof(struct interval) - 1))
-    return 0;
-
-  /* if we arrive here, ucs is not a combining or C0/C1 control character */
-
-  return 1 + 
-    (ucs >= 0x1100 &&
-     (ucs <= 0x115f ||                    /* Hangul Jamo init. consonants */
-      ucs == 0x2329 || ucs == 0x232a ||
-      (ucs >= 0x2e80 && ucs <= 0xa4cf &&
-       ucs != 0x303f) ||                  /* CJK ... Yi */
-      (ucs >= 0xac00 && ucs <= 0xd7a3) || /* Hangul Syllables */
-      (ucs >= 0xf900 && ucs <= 0xfaff) || /* CJK Compatibility Ideographs */
-      (ucs >= 0xfe10 && ucs <= 0xfe19) || /* Vertical forms */
-      (ucs >= 0xfe30 && ucs <= 0xfe6f) || /* CJK Compatibility Forms */
-      (ucs >= 0xff00 && ucs <= 0xff60) || /* Fullwidth Forms */
-      (ucs >= 0xffe0 && ucs <= 0xffe6) ||
-      (ucs >= 0x20000 && ucs <= 0x2fffd) ||
-      (ucs >= 0x30000 && ucs <= 0x3fffd)));
-}
-
diff -Naur ../../../dietlibc-0.34/lib/write12.c lib/write12.c
--- ../../../dietlibc-0.34/lib/write12.c	2005-09-21 10:33:08.000000000 +0300
+++ lib/write12.c	1970-01-01 03:00:00.000000000 +0300
@@ -1,17 +0,0 @@
-#include <unistd.h>
-#include <string.h>
-#include <write12.h>
-
-#if defined(__i386__)
-#define REGPARM(x) __attribute__((regparm(x)))
-#else
-#define REGPARM(x)
-#endif
-
-ssize_t REGPARM(1) __write1 (const char* s) {
-  return write(1, s, strlen(s));
-}
-
-ssize_t REGPARM(1) __write2 (const char* s) {
-  return write(2, s, strlen(s));
-}
